erDiagram
  %% 主实体
  ORDER ||--|{ SERVICE : contains
  SERVICE ||--o{ SERVICE_FEE : has
  LEGAL_ENTITY ||--o{ ORG_ACCOUNT : "账号/抬头"
  CUSTOMER ||--o{ ORDER : places
  SUPPLIER ||--o{ SERVICE : provides

  %% 规则域
  RULE_SET ||--o{ RULE_CONDITION : has
  RULE_SET ||--o{ RULE_PARAM : has
  RULE_SET {
    string rule_set_id PK
    string name
    string version
    string scope  "global/region/legal-entity"
    string mode   "chain|star"
    bool   active
    datetime effective_from
    datetime effective_to
  }
  RULE_CONDITION {
    string cond_id PK
    string rule_set_id FK
    string type "borrowed_title|posting|share"
    string expr "JSONLogic/DSL"
    int    priority
  }
  RULE_PARAM {
    string param_id PK
    string rule_set_id FK
    string key "share_ratio|bt_rate|posting_offset"
    string val "0.5|0.03|netting=true"
  }

  %% 清分输出(分录/流水)
  POSTING ||--|{ POSTING_LINE : has
  POSTING {
    string posting_id PK
    string batch_id
    string order_id
    string service_id
    string currency
    decimal amount
    string mode "chain|star"
    string status "trial|booked|reversed"
    datetime created_at
  }
  POSTING_LINE {
    string line_id PK
    string posting_id FK
    string dr_cr "DR|CR"
    string legal_entity_id
    string account_code
    decimal amount
    string memo
  }

  %% 报表域(双轨)
  MGMT_REPORT ||--o{ MGMT_FACT : has
  STAT_REPORT ||--o{ STAT_FACT : has
  DIFF_MARK {
    string diff_id PK
    string object "order|service"
    string object_id
    string reason "mgmt!=stat"
    string detail "JSON"
    datetime created_at
  }

  %% 基础实体
  ORDER {
    string order_id PK
    string customer_id
    decimal total_amount
    string currency
    datetime create_time
  }
  SERVICE {
    string service_id PK
    string order_id FK
    string service_type
    string sales_legal_entity_id
    string delivery_legal_entity_id
    string pay_legal_entity_id
    decimal expected_revenue
    decimal expected_cost
  }
  SERVICE_FEE {
    string fee_id PK
    string service_id FK
    string fee_type "revenue|cost|internal"
    decimal amount
    string currency
  }
  LEGAL_ENTITY {
    string legal_entity_id PK
    string name
    string region
    string default_account_id
  }
  ORG_ACCOUNT {
    string account_id PK
    string legal_entity_id FK
    string account_no
    string account_type "AR|AP|Cash"
    string is_borrowed_title "Y|N"
  }
  CUSTOMER {
    string customer_id PK
    string name
    string tax_no
  }
  SUPPLIER {
    string supplier_id PK
    string name
    string region
  }


  要点
	•	RULE_SET 用于描述链式/新式切换、借抬头费率、过账抵消策略与分润比例；expr 可采用 JSONLogic/DSL，便于热更新。
	•	POSTING & POSTING_LINE 满足会计双分录；status 支持试算/入账/冲销。
	•	MGMT_REPORT / STAT_REPORT 分离存储；DIFF_MARK 专门记录口径差异。
	•	ORG_ACCOUNT.is_borrowed_title 直接承载“借抬头判定”的系统化依据。