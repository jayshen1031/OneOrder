<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>费用明细录入管理 - OneOrder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .status-badge {
            font-size: 0.85em;
            padding: 0.25rem 0.5rem;
        }
        .table th {
            background-color: #f8f9fa;
            border-top: none;
        }
        .expense-summary {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
            border-radius: 10px;
        }
        .form-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .validation-message {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
        }
        .validation-valid {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .validation-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .validation-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .smart-suggestion {
            background-color: #e8f4f8;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        .entry-actions {
            white-space: nowrap;
        }
        .amount-input {
            text-align: right;
        }
        .currency-select {
            width: 80px;
        }
        .transit-entity-section {
            border: 2px dashed #ffc107;
            background-color: #fff8e1;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        /* iframe内嵌样式优化 */
        body {
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }
        
        .iframe-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .iframe-header h5 {
            margin: 0;
            color: white;
        }
        
        .iframe-header small {
            color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <div class="container-fluid p-3">
        <!-- iframe内嵌页面头部（简化版） -->
        <div class="iframe-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>费用明细录入</h5>
                <small>当前用户: <span id="currentUser">张美华</span></small>
            </div>
        </div>

        <!-- 订单选择 -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-search"></i> 订单选择</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <select class="form-select" id="orderSelect" onchange="loadOrderExpenseEntries()">
                                    <option value="">请选择订单</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-primary" onclick="refreshOrders()">
                                    <i class="fas fa-sync-alt"></i> 刷新
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card expense-summary" id="orderSummary" style="display: none;">
                    <div class="card-body">
                        <h6><i class="fas fa-info-circle"></i> 订单信息</h6>
                        <div class="row">
                            <div class="col-6">
                                <small>客户: <span id="customerName"></span></small><br>
                                <small>收款: <span id="receivableCount">0</span>笔 / ¥<span id="totalReceivable">0.00</span></small>
                            </div>
                            <div class="col-6">
                                <small>录费状态: <span id="entryStatus" class="badge bg-secondary"></span></small><br>
                                <small>付款: <span id="payableCount">0</span>笔 / ¥<span id="totalPayable">0.00</span></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 费用明细录入表单 -->
        <div class="card mb-4" id="entryFormCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-plus"></i> 新增费用明细</h5>
            </div>
            <div class="card-body">
                <form id="expenseEntryForm">
                    <div class="row">
                        <!-- 基本信息 -->
                        <div class="col-md-6">
                            <div class="form-section">
                                <h6><i class="fas fa-clipboard-list"></i> 基本信息</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">收付类型 <span class="text-danger">*</span></label>
                                        <select class="form-select" id="entryType" required onchange="handleEntryTypeChange()">
                                            <option value="">请选择</option>
                                            <option value="RECEIVABLE">收款</option>
                                            <option value="PAYABLE">付款</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">费用科目 <span class="text-danger">*</span></label>
                                        <select class="form-select" id="feeCode" required onchange="handleFeeCodeChange()">
                                            <option value="">请选择费用科目</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">服务项目 <span class="text-danger">*</span></label>
                                        <select class="form-select" id="serviceCode" required onchange="handleServiceCodeChange()">
                                            <option value="">请选择服务项目</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">供应商类型</label>
                                        <select class="form-select" id="supplierType" onchange="handleSupplierTypeChange()">
                                            <option value="">请选择供应商类型</option>
                                            <option value="SHIPPING_COMPANY">船公司</option>
                                            <option value="TERMINAL">码头公司</option>
                                            <option value="CUSTOMS_BROKER">报关行</option>
                                            <option value="TRUCKING_COMPANY">拖车公司</option>
                                            <option value="FREIGHT_FORWARDER">货代公司</option>
                                            <option value="LOGISTICS_PROVIDER">物流公司</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- 智能推荐区域 -->
                                <div id="smartSuggestion" class="smart-suggestion" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-lightbulb text-info me-2"></i>
                                        <span id="suggestionText"></span>
                                        <button type="button" class="btn btn-sm btn-info ms-2" id="applySuggestion" onclick="applySuggestion()" style="display: none;">
                                            应用建议
                                        </button>
                                    </div>
                                </div>
                                <!-- 校验结果区域 -->
                                <div id="validationResult" class="validation-message" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- 金额和对方信息 -->
                        <div class="col-md-6">
                            <div class="form-section">
                                <h6><i class="fas fa-money-bill-wave"></i> 金额信息</h6>
                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <label class="form-label">金额 <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control amount-input" id="amount" step="0.01" min="0.01" required placeholder="0.00">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">币种</label>
                                        <select class="form-select currency-select" id="currency">
                                            <option value="CNY">CNY</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                            <option value="JPY">JPY</option>
                                            <option value="HKD">HKD</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">对方法人公司 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="counterpartEntity" required placeholder="请输入对方公司名称">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">对方部门</label>
                                    <input type="text" class="form-control" id="counterpartDepartment" placeholder="请输入对方部门">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 我方信息 -->
                    <div class="form-section">
                        <h6><i class="fas fa-building"></i> 我方信息</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">我方法人 <span class="text-danger">*</span></label>
                                <select class="form-select" id="ourEntityId" required onchange="handleOurEntityChange()">
                                    <option value="">请选择我方法人</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">我方部门 <span class="text-danger">*</span></label>
                                <select class="form-select" id="ourDepartmentId" required>
                                    <option value="">请选择我方部门</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 借抬头信息 -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="isTransitEntity" onchange="handleTransitEntityChange()">
                        <label class="form-check-label" for="isTransitEntity">
                            <i class="fas fa-exchange-alt"></i> 借抬头处理
                        </label>
                    </div>
                    <div id="transitEntitySection" class="transit-entity-section" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">借抬头原因 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="transitReason" rows="2" placeholder="请说明借抬头的具体原因"></textarea>
                        </div>
                    </div>

                    <!-- 备注信息 -->
                    <div class="mb-3">
                        <label class="form-label">备注信息</label>
                        <textarea class="form-control" id="remarks" rows="2" placeholder="请输入备注信息"></textarea>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-undo"></i> 重置
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 保存明细
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 费用明细列表 -->
        <div class="card" id="entryListCard" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list"></i> 费用明细列表</h5>
                <div>
                    <button type="button" class="btn btn-success btn-sm" onclick="completeExpenseEntry()" id="completeButton" style="display: none;">
                        <i class="fas fa-check"></i> 完成录费
                    </button>
                    <button type="button" class="btn btn-info btn-sm" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> 导出Excel
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>序号</th>
                                <th>收付类型</th>
                                <th>费用科目</th>
                                <th>服务项目</th>
                                <th>对方公司</th>
                                <th>金额</th>
                                <th>币种</th>
                                <th>状态</th>
                                <th>校验</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="entryTableBody">
                            <!-- 动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    确定要删除这条费用明细吗？删除后不可恢复。
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
                </div>
            </div>
        </div>
    </div> <!-- 关闭container-fluid -->

    <!-- Toast 通知 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">OneOrder</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/expense-entry-management.js?v=20250921-2330"></script>
</body>
</html>