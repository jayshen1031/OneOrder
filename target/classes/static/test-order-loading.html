<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•è®¢å•åŠ è½½</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; white-space: pre-wrap; }
        .error { background: #ffe6e6; color: #d63384; }
        .success { background: #e6f7e6; color: #198754; }
        select { width: 100%; padding: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>è®¢å•åŠ è½½æµ‹è¯•</h1>
    
    <div>
        <label>è®¢å•é€‰æ‹©:</label>
        <select id="orderSelect">
            <option value="">è¯·é€‰æ‹©è®¢å•</option>
        </select>
        <button onclick="loadOrderList()">åˆ·æ–°è®¢å•åˆ—è¡¨</button>
    </div>
    
    <div id="logs"></div>

    <script>
        // ç®€åŒ–çš„æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.textContent = new Date().toLocaleTimeString() + ': ' + message;
            logsDiv.appendChild(logEntry);
            console.log(message);
        }

        // ç®€åŒ–çš„é€šçŸ¥å‡½æ•°
        function showNotification(message, type) {
            log(`é€šçŸ¥ (${type}): ${message}`, type);
        }

        // å®¢æˆ·æ˜ å°„
        const customerMapping = {
            'CUST_001': 'CONG TY TNHH COCREATION GRASS CORPORATION VIET NAM',
            'CUST_002': 'COCREATION GRASS CORPORATION (VIET NAM) CO., LTD',
            'CUST_003': 'CONG TY TNHH COCREATION GRASS CORPORATION VIET NAM',
            'CUST_004': 'COCREATION GRASS CORPORATION (VIET NAM) CO., LTD',
            'CUST_005': 'CONG TY TNHH COCREATION GRASS CORPORATION VIET NAM',
            'CUST_006': 'COCREATION GRASS CORPORATION (VIET NAM) CO., LTD',
            'CUST_007': 'CONG TY TNHH COCREATION GRASS CORPORATION VIET NAM',
            'CUST_008': 'COCREATION GRASS CORPORATION (VIET NAM) CO., LTD'
        };

        function getCustomerName(order) {
            if (order.customerName && order.customerName.trim() !== '') {
                return order.customerName;
            }
            return customerMapping[order.customerId] || order.customerId || 'Unknown Customer';
        }

        function getBusinessTypeName(type) {
            const typeMap = {
                'OCEAN': 'æµ·è¿',
                'AIR': 'ç©ºè¿',
                'TRUCK': 'é™†è¿',
                'RAIL': 'é“è¿',
                'CUSTOMS': 'å…³åŠ¡',
                'WAREHOUSE': 'ä»“å‚¨'
            };
            return typeMap[type] || type || 'æµ·è¿';
        }

        // åŠ è½½è®¢å•åˆ—è¡¨å‡½æ•°
        async function loadOrderList() {
            log('ğŸ”„ å¼€å§‹åŠ è½½è®¢å•åˆ—è¡¨...');
            
            try {
                // æ£€æŸ¥orderSelectå…ƒç´ æ˜¯å¦å­˜åœ¨
                const orderSelect = document.getElementById('orderSelect');
                if (!orderSelect) {
                    throw new Error('æœªæ‰¾åˆ°è®¢å•é€‰æ‹©æ¡†å…ƒç´ (orderSelect)');
                }
                
                log('ğŸ“¡ è°ƒç”¨è´§ä»£è®¢å•API...');
                // è°ƒç”¨è´§ä»£è®¢å•APIè·å–çœŸå®æ•°æ®
                const response = await fetch('/api/freight-orders?page=0&size=20');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const apiOrders = await response.json();
                log(`âœ… è·å–åˆ°${apiOrders.length}ä¸ªè®¢å•`, 'success');
                
                const orders = apiOrders.map(order => {
                    return {
                        orderId: order.orderId,
                        orderNo: order.orderNo,
                        customerId: order.customerId,
                        customerName: order.customerName,
                        businessType: order.businessType || 'OCEAN',
                        portOfLoading: order.portOfLoading,
                        portOfDischarge: order.portOfDischarge,
                        orderStatus: order.orderStatus
                    };
                });
                
                log('ğŸ”„ æ›´æ–°è®¢å•é€‰æ‹©æ¡†...');
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
                while (orderSelect.children.length > 1) {
                    orderSelect.removeChild(orderSelect.lastChild);
                }
                
                if (orders && orders.length > 0) {
                    orders.forEach((order, index) => {
                        log(`  æ·»åŠ è®¢å• ${index + 1}: ${order.orderNo}`);
                        const option = document.createElement('option');
                        option.value = order.orderId;
                        const customerDisplayName = getCustomerName(order);
                        const shortCustomerName = customerDisplayName.length > 30 ? customerDisplayName.substring(0, 27) + '...' : customerDisplayName;
                        option.textContent = `${order.orderNo} - ${shortCustomerName} (${getBusinessTypeName(order.businessType)})`;
                        option.title = `${order.orderNo} - ${customerDisplayName} (${getBusinessTypeName(order.businessType)})`;
                        orderSelect.appendChild(option);
                    });
                    
                    log(`âœ… æˆåŠŸæ·»åŠ ${orders.length}ä¸ªè®¢å•åˆ°é€‰æ‹©æ¡†`, 'success');
                    showNotification(`è®¢å•åˆ—è¡¨å·²æ›´æ–° (${orders.length}ä¸ªè®¢å•)`, 'success');
                } else {
                    log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°è®¢å•æ•°æ®');
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'æš‚æ— è®¢å•æ•°æ®ï¼Œè¯·å…ˆåœ¨è´§ä»£ç®¡ç†ç³»ç»Ÿä¸­åˆ›å»ºè®¢å•';
                    option.disabled = true;
                    orderSelect.appendChild(option);
                    showNotification('æš‚æ— è®¢å•æ•°æ®', 'warning');
                }
                
            } catch (error) {
                log(`âŒ åŠ è½½è®¢å•åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
                showNotification('åŠ è½½è®¢å•åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                
                // æ·»åŠ é”™è¯¯æ—¶çš„å¤‡ç”¨æ˜¾ç¤º
                const orderSelect = document.getElementById('orderSelect');
                if (orderSelect) {
                    while (orderSelect.children.length > 1) {
                        orderSelect.removeChild(orderSelect.lastChild);
                    }
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'æ— æ³•åŠ è½½è®¢å•æ•°æ®ï¼Œè¯·æ£€æŸ¥APIè¿æ¥';
                    option.disabled = true;
                    orderSelect.appendChild(option);
                }
            }
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨æ‰§è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“– é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æµ‹è¯•...');
            loadOrderList();
        });
    </script>
</body>
</html>