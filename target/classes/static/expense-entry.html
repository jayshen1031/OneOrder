<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneOrder - 录费管理</title>
    
    <!-- Bootstrap 5.1.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 6.0 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .order-info-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .expense-entry-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        .entry-table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .entry-table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
        }
        
        .entry-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .validation-status {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-valid {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .progress-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .progress-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .progress-item:last-child {
            margin-bottom: 0;
        }
        
        .progress-icon {
            width: 20px;
            text-align: center;
            margin-right: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #667eea 100%);
            transform: translateY(-1px);
        }
        
        .btn-success {
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
        }
        
        .btn-danger {
            border-radius: 25px;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .constraint-info {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 5px;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .constraint-info .constraint-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        
        .constraint-info .constraint-item:last-child {
            margin-bottom: 0;
        }
        
        .constraint-icon {
            width: 20px;
            text-align: center;
            margin-right: 0.5rem;
        }
        
        .auto-suggest-alert {
            border-left: 4px solid #667eea;
            background-color: #f8f9fa;
        }
        
        .currency-input {
            position: relative;
        }
        
        .currency-symbol {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-weight: 500;
        }
        
        .currency-input input {
            padding-left: 35px;
        }
        
        @media (max-width: 768px) {
            .order-info-row {
                flex-direction: column;
            }
            
            .entry-table {
                font-size: 0.875rem;
            }
            
            .btn {
                font-size: 0.875rem;
                padding: 0.375rem 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- 主标题 -->
    <div class="main-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-0">
                        <i class="fas fa-file-invoice-dollar me-2"></i>
                        OneOrder - 录费管理
                    </h2>
                    <p class="mb-0 opacity-75">费用明细录入与管理</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light" onclick="window.history.back()">
                        <i class="fas fa-arrow-left me-1"></i>返回
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container mt-4">
        <!-- 订单信息区域 -->
        <div class="order-info-card">
            <div class="row align-items-center order-info-row" id="orderInfoRow">
                <div class="col-md-3">
                    <label for="orderSelect" class="form-label">
                        <i class="fas fa-file-alt me-1"></i>选择订单
                    </label>
                    <select class="form-select" id="orderSelect" onchange="loadOrderInfo()">
                        <option value="">请选择订单</option>
                        <option value="HCBD20250916001">HCBD20250916001 - 海运整柜</option>
                        <option value="HCBD20250916002">HCBD20250916002 - 空运普货</option>
                        <option value="HCBD20250916003">HCBD20250916003 - 海运拼箱</option>
                    </select>
                </div>
                <div class="col-md-9" id="orderDetailInfo" style="display: none;">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>客户:</strong> <span id="customerName">-</span>
                        </div>
                        <div class="col-md-4">
                            <strong>业务类型:</strong> <span id="businessType">-</span>
                        </div>
                        <div class="col-md-4">
                            <strong>录费状态:</strong> 
                            <span id="entryStatus" class="badge bg-info">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 录费进度区域 -->
        <div class="progress-card" id="progressCard" style="display: none;">
            <h5 class="mb-3">
                <i class="fas fa-chart-line me-2"></i>录费进度
            </h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="progress-item">
                        <div class="progress-icon">
                            <i class="fas fa-arrow-down text-success"></i>
                        </div>
                        <div>
                            <strong>收款明细:</strong> 
                            <span id="receivableCount">0</span>条
                            <small class="opacity-75">| ¥<span id="totalReceivable">0.00</span></small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="progress-item">
                        <div class="progress-icon">
                            <i class="fas fa-arrow-up text-warning"></i>
                        </div>
                        <div>
                            <strong>付款明细:</strong> 
                            <span id="payableCount">0</span>条
                            <small class="opacity-75">| ¥<span id="totalPayable">0.00</span></small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="progress-item">
                        <div class="progress-icon">
                            <i class="fas fa-exclamation-circle text-danger"></i>
                        </div>
                        <div>
                            <strong>待处理:</strong> 
                            <span id="pendingCount">0</span>条
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 费用明细录入区域 -->
        <div class="expense-entry-card" id="expenseEntryCard" style="display: none;">
            <div class="card-header bg-transparent border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list-alt me-2"></i>费用明细
                    </h5>
                    <button class="btn btn-primary" onclick="openAddEntryModal()">
                        <i class="fas fa-plus me-1"></i>添加明细
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table entry-table mb-0">
                        <thead>
                            <tr>
                                <th style="width: 8%">序号</th>
                                <th style="width: 15%">服务项目</th>
                                <th style="width: 15%">费用科目</th>
                                <th style="width: 8%">收付</th>
                                <th style="width: 20%">对方法人</th>
                                <th style="width: 18%">我方法人</th>
                                <th style="width: 10%">金额</th>
                                <th style="width: 6%">操作</th>
                            </tr>
                        </thead>
                        <tbody id="entriesTableBody">
                            <!-- 动态生成费用明细行 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted">
                        共 <span id="totalEntriesCount">0</span> 条明细
                    </div>
                    <button class="btn btn-success" id="completeButton" onclick="completeExpenseEntry()" style="display: none;">
                        <i class="fas fa-check me-1"></i>录费完成
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加费用明细弹窗 -->
    <div class="modal fade" id="addEntryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>录入费用明细
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="entryForm">
                        <!-- 基本信息 -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-info-circle me-1"></i>基本信息
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="serviceCode" class="form-label">服务项目 *</label>
                                <select class="form-select" id="serviceCode" required>
                                    <option value="">请选择服务项目</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="feeCode" class="form-label">费用科目 *</label>
                                <div class="position-relative">
                                    <select class="form-select" id="feeCode" required onchange="validateFeeConstraints()">
                                        <option value="">请选择费用科目</option>
                                    </select>
                                    <button type="button" class="btn btn-sm btn-outline-info position-absolute top-50 end-0 translate-middle-y me-2" 
                                            style="font-size: 0.75rem; padding: 0.25rem 0.5rem; display: none;" 
                                            id="constraintInfoBtn" onclick="showConstraintInfo()">
                                        <i class="fas fa-info"></i>
                                    </button>
                                </div>
                                <!-- 约束信息提示 -->
                                <div id="constraintInfo" class="constraint-info" style="display: none;">
                                    <div class="constraint-item">
                                        <div class="constraint-icon">
                                            <i class="fas fa-check-circle text-success"></i>
                                        </div>
                                        <div>
                                            <strong>适用服务:</strong> <span id="applicableServices">-</span>
                                        </div>
                                    </div>
                                    <div class="constraint-item">
                                        <div class="constraint-icon">
                                            <i class="fas fa-building text-info"></i>
                                        </div>
                                        <div>
                                            <strong>适用供应商:</strong> <span id="applicableSuppliers">-</span>
                                        </div>
                                    </div>
                                    <div class="constraint-item" id="currentSelection">
                                        <div class="constraint-icon">
                                            <i class="fas fa-exclamation-triangle text-warning"></i>
                                        </div>
                                        <div>
                                            <strong>当前选择:</strong> <span id="selectionWarning">-</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 智能推荐提示 -->
                                <div id="autoSuggestAlert" class="alert auto-suggest-alert" style="display: none; margin-top: 0.5rem;">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-robot me-2"></i>
                                        <div class="flex-grow-1">
                                            <strong>智能提示</strong>
                                            <div id="autoSuggestMessage" class="small">-</div>
                                        </div>
                                        <div>
                                            <button type="button" class="btn btn-sm btn-primary" onclick="acceptAutoSuggestion()">
                                                采纳
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="dismissAutoSuggestion()">
                                                忽略
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">收付类型 *</label>
                                <div class="d-flex">
                                    <div class="form-check me-4">
                                        <input class="form-check-input" type="radio" name="entryType" id="receivable" value="RECEIVABLE">
                                        <label class="form-check-label" for="receivable">
                                            <i class="fas fa-arrow-down text-success me-1"></i>收款
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="entryType" id="payable" value="PAYABLE">
                                        <label class="form-check-label" for="payable">
                                            <i class="fas fa-arrow-up text-danger me-1"></i>付款
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 对方信息 -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-users me-1"></i>对方信息
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="counterpartEntity" class="form-label">对方法人公司 *</label>
                                <input type="text" class="form-control" id="counterpartEntity" required
                                       placeholder="请输入对方法人公司名称">
                            </div>
                            <div class="col-md-4">
                                <label for="counterpartDepartment" class="form-label">对方部门</label>
                                <input type="text" class="form-control" id="counterpartDepartment"
                                       placeholder="对方部门（可选）">
                            </div>
                        </div>
                        
                        <div class="row mb-3" id="supplierTypeRow" style="display: none;">
                            <div class="col-md-6">
                                <label for="supplierType" class="form-label">供应商类型</label>
                                <select class="form-select" id="supplierType">
                                    <option value="">请选择供应商类型</option>
                                    <option value="SHIPPING_COMPANY">船公司</option>
                                    <option value="TERMINAL_OPERATOR">码头运营商</option>
                                    <option value="CUSTOMS_BROKER">报关行</option>
                                    <option value="TRUCKING_COMPANY">拖车公司</option>
                                    <option value="FREIGHT_FORWARDER">货代公司</option>
                                    <option value="LOGISTICS_PROVIDER">物流服务商</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 我方信息 -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-building me-1"></i>我方信息
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="ourEntityId" class="form-label">我方法人 *</label>
                                <div class="d-flex">
                                    <select class="form-select" id="ourEntityId" required>
                                        <option value="">请选择我方法人</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-warning ms-2" id="transitEntityBtn" 
                                            onclick="toggleTransitEntity()" title="使用借抬头">
                                        <i class="fas fa-exchange-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="ourDepartment" class="form-label">我方部门</label>
                                <input type="text" class="form-control" id="ourDepartment" readonly
                                       value="海运部" placeholder="自动匹配">
                            </div>
                        </div>
                        
                        <div class="row mb-3" id="transitReasonRow" style="display: none;">
                            <div class="col-md-12">
                                <label for="transitReason" class="form-label">借抬头原因</label>
                                <textarea class="form-control" id="transitReason" rows="2"
                                          placeholder="请说明使用借抬头的原因"></textarea>
                            </div>
                        </div>
                        
                        <!-- 金额信息 -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-calculator me-1"></i>金额信息
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="amount" class="form-label">金额 *</label>
                                <div class="currency-input">
                                    <span class="currency-symbol">¥</span>
                                    <input type="number" class="form-control" id="amount" required 
                                           min="0" step="0.01" placeholder="0.00">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="currency" class="form-label">币种 *</label>
                                <select class="form-select" id="currency" required>
                                    <option value="CNY" selected>CNY - 人民币</option>
                                    <option value="USD">USD - 美元</option>
                                    <option value="EUR">EUR - 欧元</option>
                                    <option value="HKD">HKD - 港币</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 校验信息区域 -->
                        <div id="validationResult" class="alert" style="display: none;">
                            <div class="d-flex align-items-center">
                                <div id="validationIcon" class="me-2"></div>
                                <div id="validationMessage" class="flex-grow-1">-</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveExpenseEntry()">
                        <i class="fas fa-save me-1"></i>确定
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap 5.1.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="js/expense-entry.js"></script>
</body>
</html>