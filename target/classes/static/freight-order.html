<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneOrder - 货代订单管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 0.75rem 1.25rem;
            margin: 0.2rem 0;
            border-radius: 0.375rem;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.15);
            transform: translateX(5px);
        }
        .content-area {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.75rem rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
        }
        .service-card {
            transition: all 0.3s;
            cursor: pointer;
        }
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15);
        }
        .service-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        .ocean-freight { color: #0066cc; }
        .air-freight { color: #ff6600; }
        .truck-freight { color: #009900; }
        .rail-freight { color: #cc0066; }
        .customs { color: #9900cc; }
        .warehouse { color: #666666; }
        
        .price-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8rem;
        }
        
        .order-status {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-confirmed { background-color: #d1ecf1; color: #0c5460; }
        .status-shipped { background-color: #d4edda; color: #155724; }
        .status-delivered { background-color: #d1ecf1; color: #0c5460; }
        .status-completed { background-color: #d4edda; color: #155724; }

        .fee-breakdown {
            background: linear-gradient(45deg, #f8f9fa, #ffffff);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .total-amount {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        
        /* 法人实体流转图样式 */
        .flow-diagram {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e9ecef;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .flow-title {
            font-weight: bold;
            text-align: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .flow-path {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .flow-path.vertical {
            flex-direction: column;
            align-items: center;
        }
        
        .flow-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #ffffff;
            border: 2px solid #dee2e6;
            border-radius: 0.75rem;
            padding: 0.75rem;
            min-width: 80px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .flow-node.highlight {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }
        
        .flow-node.region {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%);
        }
        
        .flow-node i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #495057;
        }
        
        .flow-node span {
            font-size: 0.8rem;
            font-weight: 500;
            text-align: center;
        }
        
        .retention-info {
            display: block;
            font-size: 0.7rem;
            color: #dc3545;
            font-weight: 600;
            margin-top: 0.25rem;
        }
        
        .flow-arrow {
            font-size: 1.5rem;
            color: #6c757d;
            font-weight: bold;
            margin: 0 0.5rem;
        }
        
        .flow-arrow-down {
            font-size: 1.5rem;
            color: #6c757d;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        
        .netting-info {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, #f8d7da 0%, #ffffff 100%);
            border: 1px solid #f5c6cb;
            border-radius: 0.5rem;
            color: #721c24;
            font-size: 0.9rem;
        }
        
        /* 清分结果表格样式 */
        .clearing-result-table {
            font-size: 0.9rem;
        }
        
        .clearing-result-table th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
        }
        
        .clearing-result-table .amount-positive {
            color: #28a745;
            font-weight: 600;
        }
        
        .clearing-result-table .amount-negative {
            color: #dc3545;
            font-weight: 600;
        }
        
        .retention-highlight {
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }
        
        /* 规则配置开关样式 */
        .form-check-input:checked {
            background-color: #28a745;
            border-color: #28a745;
        }
        
        /* 订单号显示优化 */
        .table .order-no-cell {
            word-break: break-all;
            min-width: 200px;
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .table .order-no-cell:hover {
            white-space: normal;
            overflow: visible;
            text-overflow: initial;
            background-color: #f8f9fa;
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边导航 -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="text-center flex-grow-1">
                            <h4 class="text-white"><i class="fas fa-ship me-2"></i>OneOrder</h4>
                            <small class="text-white-50">货代订单管理系统</small>
                        </div>
                        <!-- 全局通知中心 -->
                        <div class="position-relative">
                            <button class="btn btn-outline-light btn-sm position-relative" onclick="notificationSystem.displayNotificationCenter()" title="通知中心">
                                <i class="fas fa-bell"></i>
                                <span class="notification-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="globalNotificationCount" style="display: none;">0</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 登录用户信息 -->
                    <div class="user-info mb-4 p-3 bg-dark bg-opacity-25 rounded">
                        <div class="text-center">
                            <div class="user-avatar mb-2">
                                <i class="fas fa-user-circle text-white" style="font-size: 2rem;"></i>
                            </div>
                            <div class="user-details">
                                <div class="text-white fw-bold" id="currentUserName">张美华</div>
                                <small class="text-white-50" id="currentUserDept">客服中心</small>
                                <div class="mt-1">
                                    <span class="badge bg-success" id="currentUserOpid">CS001</span>
                                    <span class="badge bg-warning text-dark ms-1">客服专员</span>
                                </div>
                                <div class="mt-1">
                                    <small class="text-info">
                                        <i class="fas fa-handshake me-1"></i>接单权限：创建订单并成为负责人
                                    </small>
                                </div>
                                <!-- 全局用户切换下拉菜单 -->
                                <div class="mt-2">
                                    <select id="userSwitchSelect" class="form-select form-select-sm" style="font-size: 0.75rem;" data-role="user-selector">
                                        <!-- 选项将由GlobalUserManager自动生成 -->
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <ul class="nav flex-column">
                        <!-- 核心业务流程导航 -->
                        <li class="nav-item">
                            <a class="nav-link active" href="#dashboard" onclick="showSection('dashboard')">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                仪表盘
                            </a>
                        </li>
                        
                        <!-- 六大核心步骤 -->
                        <li class="nav-item">
                            <a class="nav-link" href="#orders" onclick="showSection('orders')">
                                <i class="fas fa-clipboard-list me-2"></i>
                                1. 订单管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#assignment" onclick="showSection('assignment')" data-page-permission="assignment">
                                <i class="fas fa-user-check me-2"></i>
                                2. 接派单管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#profitsharing" onclick="showSection('profitsharing')" data-page-permission="reports">
                                <i class="fas fa-calculator me-2"></i>
                                3. 分润计算
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#clearing" onclick="showSection('clearing')" data-page-permission="clearing">
                                <i class="fas fa-cogs me-2"></i>
                                4. 清分处理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#passthrough" onclick="showSection('passthrough')" data-page-permission="clearing">
                                <i class="fas fa-route me-2"></i>
                                5. 过账处理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#reports" onclick="showSection('reports')" data-page-permission="reports">
                                <i class="fas fa-chart-bar me-2"></i>
                                6. 财务报表
                            </a>
                        </li>

                        <!-- 分割线 -->
                        <li class="nav-item mt-3">
                            <hr style="border-color: rgba(255,255,255,0.3);">
                        </li>
                        
                        <!-- 辅助功能 -->
                        <li class="nav-item">
                            <a class="nav-link" href="service-config.html" target="_blank">
                                <i class="fas fa-cog me-2"></i>
                                系统配置
                                <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8rem;"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <!-- 主内容区域 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 content-area">
                
                
                <!-- 仪表盘 -->
                <div id="dashboard" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2"><i class="fas fa-tachometer-alt me-2"></i>货代业务仪表盘</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-primary" onclick="showSection('orders'); showNewOrderForm();">
                                <i class="fas fa-plus me-2"></i>新建订单
                            </button>
                        </div>
                    </div>
                    
                    <!-- 业务统计 -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card text-center service-card ocean-freight">
                                <div class="card-body">
                                    <i class="fas fa-ship service-icon ocean-freight"></i>
                                    <h5>海运业务</h5>
                                    <h3 id="oceanOrders">0</h3>
                                    <p class="text-muted">本月订单</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card text-center service-card air-freight">
                                <div class="card-body">
                                    <i class="fas fa-plane service-icon air-freight"></i>
                                    <h5>空运业务</h5>
                                    <h3 id="airOrders">0</h3>
                                    <p class="text-muted">本月订单</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card text-center service-card truck-freight">
                                <div class="card-body">
                                    <i class="fas fa-truck service-icon truck-freight"></i>
                                    <h5>陆运业务</h5>
                                    <h3 id="truckOrders">0</h3>
                                    <p class="text-muted">本月订单</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card text-center service-card rail-freight">
                                <div class="card-body">
                                    <i class="fas fa-train service-icon rail-freight"></i>
                                    <h5>铁运业务</h5>
                                    <h3 id="railOrders">0</h3>
                                    <p class="text-muted">本月订单</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 最近订单 -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-clock me-2"></i>最近订单</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadRecentOrders()">
                                <i class="fas fa-refresh me-1"></i>刷新
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th style="min-width: 200px;">订单号</th>
                                            <th>客户</th>
                                            <th>业务类型</th>
                                            <th>包含服务</th>
                                            <th>起始地</th>
                                            <th>目的地</th>
                                            <th>金额</th>
                                            <th>状态</th>
                                            <th>客服负责人</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentOrdersTable">
                                        <!-- 动态加载 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 订单管理 -->
                <div id="orders" class="content-section" style="display:none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2"><i class="fas fa-clipboard-list me-2"></i>订单管理</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-primary" onclick="showNewOrderForm()">
                                <i class="fas fa-plus me-2"></i>新建订单
                            </button>
                        </div>
                    </div>
                    
                    <!-- 新建订单表单 -->
                    <div class="card mb-4" id="newOrderForm" style="display:none;">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-plus me-2"></i>新建货代订单</h5>
                        </div>
                        <div class="card-body">
                            <form id="orderForm">
                                <!-- 客服信息 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-primary"><i class="fas fa-user-tie me-2"></i>客服信息</h6>
                                        <hr>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">当前登录客服</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                                            <input type="text" class="form-control" id="currentOperator" readonly>
                                        </div>
                                        <small class="text-muted">当前登录用户将成为订单负责人</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">接单时间</label>
                                        <input type="datetime-local" class="form-control" id="receiveTime" readonly>
                                    </div>
                                </div>

                                <!-- 基本信息 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-primary"><i class="fas fa-info-circle me-2"></i>基本信息</h6>
                                        <hr>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">订单号</label>
                                        <input type="text" class="form-control" id="orderNo" readonly>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">客户名称 *</label>
                                        <select class="form-select" id="customerId" required onchange="updateCustomerInfo()">
                                            <option value="">请选择客户</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">业务类型 *</label>
                                        <select class="form-select" id="businessType" required onchange="loadServiceOptions()">
                                            <option value="">请选择业务类型</option>
                                            <option value="OCEAN">海运</option>
                                            <option value="AIR">空运</option>
                                            <option value="TRUCK">陆运</option>
                                            <option value="RAIL">铁运</option>
                                            <option value="MULTIMODAL">多式联运</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- 运输信息 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-primary"><i class="fas fa-route me-2"></i>运输信息</h6>
                                        <hr>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">起运港/地 *</label>
                                        <input type="text" class="form-control" id="portOfLoading" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">目的港/地 *</label>
                                        <input type="text" class="form-control" id="portOfDischarge" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">预计开船/起运日期</label>
                                        <input type="date" class="form-control" id="estimatedDeparture">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">预计到达日期</label>
                                        <input type="date" class="form-control" id="estimatedArrival">
                                    </div>
                                </div>
                                
                                <!-- 货物信息 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-primary"><i class="fas fa-boxes me-2"></i>货物信息</h6>
                                        <hr>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">货物描述</label>
                                        <input type="text" class="form-control" id="cargoDescription">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">件数</label>
                                        <input type="number" class="form-control" id="packageCount">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">重量 (KG)</label>
                                        <input type="number" class="form-control" id="weight" step="0.1">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">体积 (CBM)</label>
                                        <input type="number" class="form-control" id="volume" step="0.001">
                                    </div>
                                </div>
                                
                                <!-- 服务选择 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-primary"><i class="fas fa-tools me-2"></i>服务选择</h6>
                                        <hr>
                                    </div>
                                    <!-- 服务选择汇总 -->
                                    <div class="col-12 mb-3">
                                        <div class="alert alert-info d-none" id="selectedServicesAlert">
                                            <h6 class="alert-heading"><i class="fas fa-list me-2"></i>已选择的服务项目：</h6>
                                            <div id="selectedServicesList">
                                                <!-- 动态显示已选择的服务 -->
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">共选择 <span id="selectedServicesCount">0</span> 项服务</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="serviceSelection">
                                        <!-- 动态加载服务选项 -->
                                    </div>
                                </div>
                                
                                <!-- 费用明细 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-primary"><i class="fas fa-calculator me-2"></i>费用明细</h6>
                                        <hr>
                                    </div>
                                    <div class="col-12">
                                        <div id="feeBreakdown">
                                            <!-- 动态生成费用明细 -->
                                        </div>
                                        <div class="total-amount mt-3">
                                            <h5>总金额: <span id="totalAmount">¥ 0.00</span></h5>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 操作按钮 -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="btn-group me-2">
                                            <button type="button" class="btn btn-outline-primary" onclick="calculateFees()">
                                                <i class="fas fa-calculator me-2"></i>计算费用
                                            </button>
                                            <button type="button" class="btn btn-primary" onclick="saveOrder()" data-feature-permission="create_order">
                                                <i class="fas fa-save me-2"></i>保存订单
                                            </button>
                                            <button type="button" class="btn btn-success" onclick="submitOrder()" data-feature-permission="create_order">
                                                <i class="fas fa-paper-plane me-2"></i>客服接单
                                            </button>
                                        </div>
                                        <button type="button" class="btn btn-secondary" onclick="cancelNewOrder()">
                                            <i class="fas fa-times me-2"></i>取消
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- 订单列表 -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list me-2"></i>订单列表</h5>
                            <div class="d-flex gap-2">
                                <select class="form-select form-select-sm" id="orderStatusFilter" onchange="filterOrders()">
                                    <option value="">全部状态</option>
                                    <option value="PENDING">待确认</option>
                                    <option value="CONFIRMED">已确认</option>
                                    <option value="SHIPPED">已发运</option>
                                    <option value="DELIVERED">已送达</option>
                                    <option value="COMPLETED">已完成</option>
                                </select>
                                <button class="btn btn-sm btn-outline-primary" onclick="loadOrders()">
                                    <i class="fas fa-refresh me-1"></i>刷新
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th style="min-width: 200px;">订单号</th>
                                            <th>客户</th>
                                            <th>业务类型</th>
                                            <th>包含服务</th>
                                            <th>起始地</th>
                                            <th>目的地</th>
                                            <th>金额</th>
                                            <th>状态</th>
                                            <th>客服负责人</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ordersTable">
                                        <!-- 动态加载 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <!-- 任务管理 -->
                <div id="tasks" class="content-section" style="display:none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2"><i class="fas fa-tasks me-2"></i>任务管理</h1>
                        <div>
                            <button class="btn btn-outline-primary me-2" onclick="loadMyTasks()">
                                <i class="fas fa-sync me-1"></i>刷新任务
                            </button>
                            <button class="btn btn-primary" onclick="showServiceAssignModal()">
                                <i class="fas fa-plus me-1"></i>新增派单
                            </button>
                        </div>
                    </div>
                    
                    <!-- 操作人员选择 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-user-cog me-2"></i>操作人员选择</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">选择操作人员</label>
                                    <select class="form-select" id="selectedOperationStaff">
                                        <option value="">请选择操作人员...</option>
                                        <!-- 动态加载 -->
                                    </select>
                                </div>
                                <div class="col-md-8 d-flex align-items-end">
                                    <button type="button" class="btn btn-info" onclick="loadOperationStaff()">
                                        <i class="fas fa-users me-1"></i>加载操作人员
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 我的任务列表 -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>我的任务</h5>
                            <div class="d-flex gap-2">
                                <select class="form-select form-select-sm" id="taskStatusFilter" onchange="filterTasks()">
                                    <option value="">全部状态</option>
                                    <option value="ASSIGNED">已派单</option>
                                    <option value="PROTOCOL_CONFIRMED">协议已确认</option>
                                    <option value="IN_PROGRESS">执行中</option>
                                    <option value="COMPLETED">已完成</option>
                                    <option value="BLOCKED">受阻</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>订单号</th>
                                            <th>服务类型</th>
                                            <th>内部协议</th>
                                            <th>状态</th>
                                            <th>派单时间</th>
                                            <th>协议确认时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myTasksTable">
                                        <!-- 动态加载 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 接派单管理 -->
                <div id="assignment" class="content-section" style="display:none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2"><i class="fas fa-user-check me-2"></i>接派单管理</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-outline-secondary" onclick="showSection('orders')">
                                <i class="fas fa-arrow-left me-2"></i>返回订单管理
                            </button>
                        </div>
                    </div>
                    
                    <!-- 完整的接派单功能 -->
                    <div class="row">
                        <!-- 左侧：订单选择和服务列表 -->
                        <div class="col-lg-8">
                            <!-- 订单选择 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5><i class="fas fa-search me-2"></i>选择订单</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">选择订单</label>
                                        <div class="input-group">
                                            <select class="form-select" id="orderSelect" onchange="loadOrderServices()">
                                                <option value="">请选择订单</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button" onclick="loadOrderList()" title="刷新订单列表">
                                                <i class="fas fa-refresh"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 服务项目列表 -->
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-cog me-2"></i>服务项目</h5>
                                    <div>
                                        <button class="btn btn-primary btn-sm" onclick="autoAssignAll()">
                                            <i class="fas fa-magic"></i> 智能派单
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="batchAssign()">
                                            <i class="fas fa-tasks"></i> 批量派单
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="servicesContainer">
                                        <div class="text-center py-5">
                                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">请先选择订单以加载服务项目</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右侧：操作人员和历史记录 -->
                        <div class="col-lg-4">
                            <!-- 可用操作人员 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6><i class="fas fa-users me-2"></i>可用操作人员</h6>
                                </div>
                                <div class="card-body">
                                    <div id="operatorsContainer">
                                        <div class="text-center py-3">
                                            <i class="fas fa-user-clock fa-2x text-muted mb-2"></i>
                                            <p class="text-muted">加载中...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 派单历史 -->
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-history me-2"></i>派单历史</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm">
                                            <tbody id="assignmentHistoryTableBody">
                                                <tr>
                                                    <td class="text-center py-4">
                                                        <i class="fas fa-history fa-2x text-muted mb-2 d-block"></i>
                                                        <p class="text-muted">暂无派单历史记录</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 分润计算 -->
                <div id="profitsharing" class="content-section" style="display:none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2"><i class="fas fa-calculator me-2"></i>分润计算</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-outline-secondary" onclick="showSection('assignment')">
                                <i class="fas fa-arrow-left me-2"></i>返回接派单
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body p-0">
                            <iframe id="profitsharingFrame" 
                                    src="profit-sharing.html" 
                                    frameborder="0" 
                                    style="width: 100%; height: 800px; border: none;">
                                <p>您的浏览器不支持iframe，请<a href="profit-sharing.html" target="_blank">点击这里</a>访问分润计算页面。</p>
                            </iframe>
                        </div>
                    </div>
                </div>
                
                <!-- 清分处理 -->
                <div id="clearing" class="content-section" style="display:none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2"><i class="fas fa-cogs me-2"></i>清分处理</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-outline-secondary" onclick="showSection('profitsharing')">
                                <i class="fas fa-arrow-left me-2"></i>返回分润计算
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body p-0">
                            <iframe id="clearingFrame" 
                                    src="index.html" 
                                    frameborder="0" 
                                    style="width: 100%; height: 800px; border: none;">
                                <p>您的浏览器不支持iframe，请<a href="index.html" target="_blank">点击这里</a>访问清分处理页面。</p>
                            </iframe>
                        </div>
                    </div>
                </div>
                
                <!-- 过账处理 -->
                <div id="passthrough" class="content-section" style="display:none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2"><i class="fas fa-route me-2"></i>过账处理</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-outline-secondary" onclick="showSection('clearing')">
                                <i class="fas fa-arrow-left me-2"></i>返回清分处理
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body text-center p-5">
                            <i class="fas fa-route fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">过账处理模块</h4>
                            <p class="text-muted">过账处理功能正在开发中，将支持资金路由、轧差结算等功能</p>
                            <div class="mt-4">
                                <span class="badge bg-secondary me-2">开发中</span>
                                <span class="badge bg-info">预计下个版本上线</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 财务报表部分 -->
                <div id="reports" class="content-section" style="display:none;">
                    <h1 class="h2">财务报表中心</h1>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card service-card" onclick="navigateToEntityReports()">
                                <div class="card-body text-center">
                                    <div class="service-icon">
                                        <i class="fas fa-building" style="color: #667eea;"></i>
                                    </div>
                                    <h5 class="card-title">管法分离报表</h5>
                                    <p class="card-text">管理实体与法人实体分离的财务报表分析，包含资金流向、损益分析、过账统计、合规检查等功能</p>
                                    <div class="mt-3">
                                        <span class="badge bg-primary me-2">实体管理</span>
                                        <span class="badge bg-success me-2">资金流向</span>
                                        <span class="badge bg-info">合规检查</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card service-card" style="opacity: 0.6;">
                                <div class="card-body text-center">
                                    <div class="service-icon">
                                        <i class="fas fa-chart-line text-muted"></i>
                                    </div>
                                    <h5 class="card-title text-muted">业务分析报表</h5>
                                    <p class="card-text text-muted">业务数据统计分析、趋势预测、KPI仪表盘等功能</p>
                                    <span class="badge bg-secondary">开发中</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card service-card" style="opacity: 0.6;">
                                <div class="card-body text-center">
                                    <div class="service-icon">
                                        <i class="fas fa-file-invoice-dollar text-muted"></i>
                                    </div>
                                    <h5 class="card-title text-muted">税务申报报表</h5>
                                    <p class="card-text text-muted">税务合规申报、增值税处理、所得税计算等功能</p>
                                    <span class="badge bg-secondary">规划中</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 管法分离报表快速入口 -->
                    <div class="card mt-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>管法分离报表快速入口</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="d-grid">
                                        <button class="btn btn-outline-primary" onclick="navigateToEntityReports('entities')">
                                            <i class="fas fa-sitemap me-2"></i>实体管理
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-grid">
                                        <button class="btn btn-outline-success" onclick="navigateToEntityReports('fund-flow')">
                                            <i class="fas fa-exchange-alt me-2"></i>资金流向
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-grid">
                                        <button class="btn btn-outline-info" onclick="navigateToEntityReports('profit-loss')">
                                            <i class="fas fa-chart-line me-2"></i>损益分析
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-grid">
                                        <button class="btn btn-outline-warning" onclick="navigateToEntityReports('compliance')">
                                            <i class="fas fa-shield-alt me-2"></i>合规检查
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="customers" class="content-section" style="display:none;">
                    <h1 class="h2">客户管理</h1>
                    <p>客户管理功能开发中...</p>
                </div>
                
            </main>
        </div>
    </div>
    
    <!-- 服务派单界面 -->
    <div id="serviceAssignmentSection" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2"><i class="fas fa-tasks me-2"></i>服务派单</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <button type="button" class="btn btn-outline-secondary" onclick="showSection('orders')">
                    <i class="fas fa-arrow-left me-2"></i>返回订单列表
                </button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>待派单服务列表</h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadAllAvailableStaff()">
                        <i class="fas fa-users me-1"></i>加载操作人员
                    </button>
                    <button type="button" class="btn btn-success btn-sm" onclick="batchAssignServices()">
                        <i class="fas fa-tasks me-1"></i>批量派单
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="pendingServicesList">
                    <!-- 动态加载待派单服务 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 订单创建结果模态框 -->
    <div class="modal fade" id="orderCreationResultModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>订单创建成功
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">订单信息</h6>
                            <table class="table table-sm">
                                <tr><td>订单ID:</td><td id="resultOrderId"></td></tr>
                                <tr><td>订单号:</td><td id="resultOrderNo"></td></tr>
                                <tr><td>总金额:</td><td id="resultTotalAmount"></td></tr>
                                <tr><td>服务数量:</td><td id="resultServiceCount"></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">下一步操作</h6>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                订单已创建成功，系统将自动跳转到服务派单界面，您可以为每个服务指派操作人员。
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="showServiceAssignmentInterface(currentOrderId)" data-bs-dismiss="modal">
                        <i class="fas fa-tasks me-2"></i>开始派单
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">稍后处理</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量派单模态框 -->
    <div class="modal fade" id="batchAssignModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-tasks me-2"></i>批量派单</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="batchAssignContainer">
                        <!-- 批量派单内容将在这里动态生成 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmBatchAssign()">
                        <i class="fas fa-check me-2"></i>确认批量派单
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 协议派单模态框 -->
    <div class="modal fade" id="assignServiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">服务派单 - 协议匹配</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 进度指示器 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <div class="text-center" id="step1Indicator">
                                    <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">1</div>
                                    <div class="small mt-1">选择操作人员</div>
                                </div>
                                <div class="text-center" id="step2Indicator">
                                    <div class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">2</div>
                                    <div class="small mt-1">匹配协议</div>
                                </div>
                                <div class="text-center" id="step3Indicator">
                                    <div class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">3</div>
                                    <div class="small mt-1">确认派单</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form id="assignServiceForm">
                        <input type="hidden" id="serviceCodeInput" value="">
                        <input type="hidden" id="serviceNameInput" value="">
                        
                        <!-- 步骤1: 选择操作人员 -->
                        <div id="assignStep1">
                            <div class="alert alert-primary">
                                <h6><i class="fas fa-user-check me-2"></i>选择操作人员</h6>
                                <div>服务项目: <strong id="assignServiceName">-</strong></div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">客服指派操作人员</label>
                                <select class="form-select" id="operatorSelect" required onchange="loadMatchingProtocols()">
                                    <option value="">请选择要指派的操作人员</option>
                                </select>
                                <small class="text-muted">作为客服，您需要为此服务选择合适的操作人员，系统将自动匹配可用的内部协议</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">客服派单备注</label>
                                <textarea class="form-control" id="assignmentNotes" rows="2" placeholder="请输入您的派单备注和要求..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">预计完成时间</label>
                                <input type="datetime-local" class="form-control" id="expectedCompleteTime">
                            </div>
                        </div>

                        <!-- 步骤2: 协议匹配和选择 -->
                        <div id="assignStep2" style="display: none;">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-handshake me-2"></i>智能协议匹配</h6>
                                <div>正在为 <strong id="selectedOperatorName">-</strong> 匹配适用的内部协议...</div>
                            </div>

                            <!-- 协议匹配结果 -->
                            <div id="protocolMatchResults" class="mb-3">
                                <!-- 匹配结果将在这里显示 -->
                            </div>

                            <!-- 协议选择 -->
                            <div class="mb-3">
                                <label class="form-label">选择内部协议</label>
                                <select class="form-select" id="protocolSelect" required onchange="showProtocolDetails()">
                                    <option value="">请选择协议</option>
                                </select>
                                <small class="text-muted">系统已按匹配度和佣金率排序，建议选择推荐协议</small>
                            </div>

                            <!-- 协议详情展示 -->
                            <div id="protocolDetails" style="display: none;">
                                <!-- 协议详情将在这里显示 -->
                            </div>
                        </div>

                        <!-- 步骤3: 确认派单 -->
                        <div id="assignStep3" style="display: none;">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle me-2"></i>客服派单信息确认</h6>
                                <small>请确认以下指派信息，确认后将正式将服务派单给操作人员</small>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary">派单信息</h6>
                                            <table class="table table-sm">
                                                <tr><td><strong>服务项目:</strong></td><td id="confirmServiceName">-</td></tr>
                                                <tr><td><strong>操作人员:</strong></td><td id="confirmOperatorName">-</td></tr>
                                                <tr><td><strong>预计完成时间:</strong></td><td id="confirmExpectedTime">-</td></tr>
                                                <tr><td><strong>客服备注:</strong></td><td id="confirmAssignmentNotes">-</td></tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-success">协议信息</h6>
                                            <table class="table table-sm">
                                                <tr><td><strong>协议名称:</strong></td><td id="confirmProtocolName">-</td></tr>
                                                <tr><td><strong>基础佣金率:</strong></td><td id="confirmBaseCommission">-</td></tr>
                                                <tr><td><strong>绩效奖金率:</strong></td><td id="confirmBonusCommission">-</td></tr>
                                                <tr><td><strong>适用范围:</strong></td><td id="confirmProtocolScope">-</td></tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="prevStepBtn" style="display: none;" onclick="previousAssignStep()">
                        <i class="fas fa-arrow-left me-2"></i>上一步
                    </button>
                    <button type="button" class="btn btn-primary" id="nextStepBtn" onclick="nextAssignStep()">
                        下一步<i class="fas fa-arrow-right ms-2"></i>
                    </button>
                    <button type="button" class="btn btn-success" id="confirmAssignBtn" style="display: none;" onclick="confirmAssignment()">
                        <i class="fas fa-check me-2"></i>确认派单
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 服务详情模态框 -->
    <div class="modal fade" id="serviceDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">服务详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="serviceDetailContent">
                    <!-- 服务详情将在这里显示 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 协议详情模态框 -->
    <div class="modal fade" id="protocolDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-handshake me-2"></i>内部协议详情
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">协议基本信息</h6>
                            <table class="table table-sm">
                                <tr><td>协议编号:</td><td id="protocolDetailsId"></td></tr>
                                <tr><td>协议名称:</td><td id="protocolDetailsName"></td></tr>
                                <tr><td>销售部门:</td><td id="protocolDetailsSalesDept"></td></tr>
                                <tr><td>操作部门:</td><td id="protocolDetailsOperationDept"></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">分润规则</h6>
                            <table class="table table-sm">
                                <tr><td>基本佣金率:</td><td id="protocolDetailsBaseCommission"></td></tr>
                                <tr><td>绩效奖金率:</td><td id="protocolDetailsPerformanceBonus"></td></tr>
                                <tr><td>生效日期:</td><td id="protocolDetailsEffective"></td></tr>
                                <tr><td>过期日期:</td><td id="protocolDetailsExpiry"></td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-primary">协议说明</h6>
                            <p id="protocolDetailsDescription" class="text-muted"></p>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>注意:</strong> 操作人员接单时需要确认此协议条款，协议一旦确认将作为分润计算的依据。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 模态框 -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-eye me-2"></i>订单详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetailContent">
                    <!-- 动态加载订单详情 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="executeOrderClearing()">
                        <i class="fas fa-coins me-2"></i>执行清分
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/user-state.js"></script>
    <script src="js/global-user-manager.js"></script>
    <script src="js/permission-manager.js?v=20250919-1647"></script>
    <script src="js/freight-order.js?v=20250918-1025"></script>
    <!-- 临时注释其他JS文件排查问题 -->
    <!-- <script src="js/customer-service.js"></script> -->
    <script src="js/service-assignment.js?v=20250919-1720"></script>
    <script>
        // 全局用户切换功能
        function handleGlobalUserSwitch() {
            const select = document.getElementById('globalUserSwitchSelect');
            const selectedUserId = select.value;
            const selectedUserText = select.options[select.selectedIndex].text;
            
            console.log('全局用户切换:', selectedUserText);
            
            // 更新UserState（如果存在）
            if (typeof UserState !== 'undefined') {
                const userMap = {
                    'CS001': { id: 'CS001', name: '张美华', department: '客服部', role: 'CUSTOMER_SERVICE' },
                    'OP001': { id: 'OP001', name: '陈师傅', department: '海运操作', role: 'OPERATOR' },
                    'OP002': { id: 'OP002', name: '林操作', department: '空运操作', role: 'OPERATOR' },
                    'OP003': { id: 'OP003', name: '张操作', department: '陆运操作', role: 'OPERATOR' },
                    'MGR001': { id: 'MGR001', name: '李经理', department: '管理层', role: 'MANAGER' },
                    'FIN001': { id: 'FIN001', name: '王会计', department: '财务部', role: 'FINANCE' }
                };
                
                const selectedUser = userMap[selectedUserId];
                if (selectedUser) {
                    UserState.setCurrentUser(selectedUser);
                    console.log('UserState已更新:', selectedUser);
                }
            }
            
            // 通知所有iframe更新用户信息
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                try {
                    if (iframe.contentWindow && iframe.contentWindow.postMessage) {
                        iframe.contentWindow.postMessage({
                            type: 'USER_SWITCH',
                            userId: selectedUserId,
                            userText: selectedUserText
                        }, '*');
                    }
                } catch (e) {
                    console.log('无法向iframe发送消息:', e.message);
                }
            });
            
            // 更新当前页面的用户相关内容
            if (typeof window.switchUser === 'function') {
                window.switchUser(selectedUserId);
            }
            
            // 显示切换成功提示
            if (typeof showNotification === 'function') {
                showNotification(`已切换到用户: ${selectedUserText}`, 'success');
            }
        }

        // 更新时间显示
        function updateGlobalTime() {
            const timeElement = document.getElementById('globalCurrentTime');
            if (timeElement) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                timeElement.textContent = timeString;
            }
        }

        // 页面加载完成初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('OneOrder主系统页面加载完成');
            
            // 初始化时间显示
            updateGlobalTime();
            setInterval(updateGlobalTime, 1000);
            
            // 初始化订单数据加载  
            setTimeout(() => {
                if (typeof loadOrdersData === 'function') {
                    loadOrdersData();
                } else if (typeof loadOrders === 'function') {
                    loadOrders();
                } else {
                    console.log('等待JS文件加载完成...');
                }
                
                // 绑定用户切换事件（保持向后兼容）
                const userSelect = document.getElementById('userSwitchSelect');
                if (userSelect && typeof window.switchUser === 'function') {
                    userSelect.addEventListener('change', function() {
                        window.switchUser(this.value);
                    });
                }
            }, 100);
        });
    </script>
    
    <!-- 全局通知系统 -->
    <script src="js/notification-system.js"></script>
    <script>
        // 等待全局通知系统初始化完成
        document.addEventListener('DOMContentLoaded', function() {
            // 等待通知系统加载完成
            setTimeout(() => {
                if (typeof notificationSystem !== 'undefined' && notificationSystem) {
                    console.log('通知系统已初始化，设置全局计数同步');
                    
                    // 监听通知计数变化并同步到全局通知按钮
                    const originalUpdateBadge = notificationSystem.updateNotificationBadge;
                    notificationSystem.updateNotificationBadge = function() {
                        originalUpdateBadge.call(this);
                        
                        // 同步到全局通知按钮
                        const globalCount = document.getElementById('globalNotificationCount');
                        const serviceCount = document.getElementById('notificationCount');
                        
                        if (globalCount && serviceCount) {
                            globalCount.textContent = serviceCount.textContent;
                            globalCount.style.display = serviceCount.style.display;
                        }
                    };
                } else {
                    console.warn('通知系统未初始化');
                }
            }, 1000);
        });
    </script>
</body>
</html>
