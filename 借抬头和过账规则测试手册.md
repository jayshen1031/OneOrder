# OneOrder借抬头和过账规则功能测试手册

## 📋 测试概述

本手册提供了完整的借抬头和过账规则功能测试指南，包括测试环境准备、测试用例执行和结果验证方法。

## 🚀 快速开始

### 1. 启动系统
```bash
# 1. 启动基础服务
docker-compose -f docker-compose-infra.yml up -d

# 2. 启动Spring Boot应用
export JAVA_HOME="$(pwd)/amazon-corretto-11.jdk/Contents/Home"
mvn spring-boot:run -Dspring-boot.run.profiles=local

# 3. 验证服务状态
curl http://localhost:8081/api/freight-orders/statistics
```

### 2. 访问测试界面
打开浏览器访问：http://localhost:8081/api/freight-order.html

导航到"清分管理"页面，找到"功能测试中心"模块。

## 🧪 测试步骤详解

### 步骤1：初始化测试数据

**操作方法**：
1. 点击"初始化测试数据"按钮
2. 等待系统创建测试数据

**预期结果**：
- 成功提示："测试数据初始化成功！"
- 系统创建3个借抬头配置和3个过账规则配置

**测试数据详情**：

#### 借抬头配置
| 配置ID | 类型 | 中间法人 | 留存方式 | 适用条件 |
|--------|------|----------|----------|----------|
| TRANSIT_001 | 收款借抬头 | ENTITY_HK_001 (香港) | 3%比例留存 | 海运/空运，1000-100000元 |
| TRANSIT_002 | 付款借抬头 | ENTITY_SG_001 (新加坡) | 2.5%比例留存 | 海运/陆运/铁运，500-50000元 |
| TRANSIT_003 | 收款借抬头 | ENTITY_US_001 (美国) | 500元固定留存 | 空运/关务，2000元以上 |

#### 过账规则配置
| 流程ID | 类型 | 路径 | 处理方式 | 留存费用 | 抵消支持 |
|--------|------|------|----------|----------|----------|
| FLOW_001 | 标准过账 | 宁波→香港→泰国 | 平收平付 | 0.5%过账费 | 不支持 |
| FLOW_002 | 东南亚过账 | 新加坡→香港→越南 | 净额处理 | 0.3%过账费 | 支持抵消 |
| FLOW_003 | 欧美过账 | 上海→伦敦→纽约 | 分段处理 | 100元固定费 | 不支持 |

### 步骤2：测试收款借抬头

**操作方法**：
1. 选择业务类型：海运/空运/陆运
2. 设置金额：1000-100000范围内（如：50000）
3. 可选设置支付账号：6225881234567890（触发特定借抬头）
4. 点击"测试收款借抬头"

**测试用例**：

#### 用例2.1：正常触发收款借抬头
- **输入**：业务类型=海运，金额=50000，无支付账号
- **预期**：需要借抬头处理=是
- **清分记录**：生成4条记录
  1. 客户付款到香港中间法人：¥50,000（应收）
  2. 香港中间法人留存：¥1,500（3%留存）
  3. 香港中间法人转付给销售法人：¥48,500（应收）
  4. 香港中间法人对应付款记录：¥-48,500（应付）

#### 用例2.2：通过账号触发借抬头
- **输入**：业务类型=海运，金额=50000，支付账号=6225881234567890
- **预期**：需要借抬头处理=是，匹配到特定借抬头配置
- **验证**：清分记录中显示transitEntityId=TRANSIT_001

#### 用例2.3：不满足借抬头条件
- **输入**：业务类型=仓储，金额=500
- **预期**：需要借抬头处理=否
- **原因**：未匹配到适用的借抬头配置

**关键验证点**：
- ✅ 留存金额计算正确（金额 × 3%）
- ✅ 中间法人流转记录完整
- ✅ 借贷记录平衡
- ✅ 留存记录标记正确（isTransitRetention=true）

### 步骤3：测试付款借抬头

**操作方法**：
1. 选择业务类型：陆运/海运/铁运
2. 设置成本金额：500-50000范围内（如：30000）
3. 点击"测试付款借抬头"

**测试用例**：

#### 用例3.1：正常触发付款借抬头
- **输入**：业务类型=陆运，成本=30000
- **预期**：生成6条清分记录
  1. 新加坡中间法人收款：¥30,000（应收）
  2. 销售法人对应付款：¥-30,000（应付）
  3. 新加坡中间法人留存：¥750（2.5%留存）
  4. 新加坡中间法人付款给供应商：¥29,250（应收）
  5. 新加坡中间法人对应付款：¥-29,250（应付）
  6. 留存记录：¥0（记录用途）

**关键验证点**：
- ✅ 留存金额 = 30000 × 2.5% = 750元
- ✅ 实际转付金额 = 30000 - 750 = 29250元
- ✅ 销售法人→中间法人→供应商的完整流转链

### 步骤4：测试标准过账（平收平付）

**操作方法**：
1. 选择业务类型：海运/陆运
2. 设置金额：如80000
3. 点击"测试平收平付"

**测试用例**：

#### 用例4.1：宁波→香港→泰国标准过账
- **输入**：业务类型=海运，金额=80000
- **预期**：生成6条清分记录
  1. 香港过账方收款：¥80,000（跨境应收）
  2. 宁波付款方付款：¥-80,000（跨境应付）
  3. 过账公司留存：¥400（0.5%过账费）
  4. 泰国收款方收款：¥79,600（跨境应收）
  5. 香港过账方付款：¥-79,600（跨境应付）
  6. 留存记录：¥0（记录400元留存）

**关键验证点**：
- ✅ 过账费用 = 80000 × 0.5% = 400元
- ✅ 净转付金额 = 80000 - 400 = 79600元
- ✅ 跨境资金流转路径完整
- ✅ 账务类型正确（CROSS_BORDER_RECEIVABLE/PAYABLE）

### 步骤5：测试抵消规则

**操作方法**：
1. 点击"测试抵消规则"（系统自动模拟3个订单）

**测试用例**：

#### 用例5.1：多订单抵消处理
- **模拟订单**：
  - 订单1：应收50000美元
  - 订单2：应付30000美元  
  - 订单3：应收20000美元
- **预期**：
  - 可以抵消=是
  - 订单数量=3
  - 净差额=40000美元（50000+20000-30000）
  - 生成1条净差额记录

**关键验证点**：
- ✅ 抵消计算正确
- ✅ 只生成净差额记录，不生成全额流转记录
- ✅ 抵消报告详细

### 步骤6：综合清分测试

**操作方法**：
1. 点击"综合测试"（系统自动设置测试订单）

**测试场景**：
- 业务类型：海运
- 金额：100000元
- 支付账号：6225881234567890（触发借抬头）
- 同时包含借抬头和过账规则

**预期结果**：
- 成功生成多条清分记录
- 借贷平衡验证通过
- 包含借抬头记录、过账记录、留存记录

**关键验证点**：
- ✅ 借贷平衡：totalDebit = totalCredit
- ✅ 多种规则同时应用
- ✅ 记录分类正确：transitRecords > 0, crossBorderRecords > 0

## 📊 测试结果解读

### 清分结果表格说明

| 列名 | 说明 | 示例 |
|------|------|------|
| 法人ID | 涉及的法人实体标识 | ENTITY_HK_001 |
| 金额 | 清分金额，正数=应收，负数=应付 | ¥50,000 / ¥-48,500 |
| 交易类型 | 应收/应付/分润/中转费/净额 | 应收 |
| 账务类型 | 外收/外支/内收/内支/跨境应收/跨境应付/留存/抵消 | 跨境应收 |
| 描述 | 清分业务描述 | 客户付款到借抬头法人 |
| 留存 | 留存金额，"-"表示无留存 | ¥1,500 |

### 状态指示说明

- 🟢 **绿色徽章**：成功状态
- 🟡 **黄色徽章**：需要借抬头处理=是，需要过账处理=是
- 🟠 **橙色徽章**：警告状态，不需要特殊处理
- 🔴 **红色徽章**：失败状态

### 留存高亮说明

- 🟡 **黄色背景行**：标识留存相关记录（isTransitRetention=true）

## 🔍 常见问题排查

### Q1: 初始化测试数据失败
**症状**：点击初始化按钮后提示失败
**排查**：
1. 检查数据库连接是否正常
2. 查看后台日志：`docker logs oneorder-app`
3. 确认清分规则表是否存在

### Q2: 借抬头测试显示"不需要借抬头处理"
**可能原因**：
1. 业务类型不匹配（检查适用条件）
2. 金额超出范围（1000-100000）
3. 货币类型不支持（仅支持CNY/USD）
4. 客户ID不在白名单（CUST_001, CUST_002）

**解决方法**：
- 使用推荐的测试参数
- 检查适用条件配置

### Q3: 过账测试不生成记录
**可能原因**：
1. 业务类型不匹配适用条件
2. 货币类型不符合
3. 过账规则未正确初始化

**解决方法**：
- 重新初始化测试数据
- 使用海运或陆运业务类型

### Q4: 综合测试借贷不平衡
**症状**：validation.isBalanced = false
**排查步骤**：
1. 检查每条清分记录的金额
2. 验证留存计算是否正确
3. 确认对应的借贷记录是否成对出现

## 🧮 计算验证公式

### 借抬头留存计算
```
比例留存 = 原始金额 × 留存比例
固定留存 = min(固定金额, 原始金额)
净转付金额 = 原始金额 - 留存金额
```

### 过账费用计算
```
比例过账费 = 原始金额 × 过账比例
固定过账费 = 固定金额
净转付金额 = 原始金额 - 过账费用
```

### 借贷平衡验证
```
借方总额 = sum(amount > 0)
贷方总额 = sum(abs(amount < 0))
平衡状态 = 借方总额 == 贷方总额
```

## 📝 测试报告模板

### 功能测试报告

**测试环境**：OneOrder v1.0，端口8081
**测试日期**：2025年9月8日
**测试人员**：测试工程师

#### 借抬头功能测试

| 测试用例 | 预期结果 | 实际结果 | 状态 |
|----------|----------|----------|------|
| 收款借抬头-正常触发 | 生成4条记录，3%留存 | ✅ 符合预期 | PASS |
| 收款借抬头-账号触发 | 匹配特定配置 | ✅ 符合预期 | PASS |
| 收款借抬头-条件不符 | 不需要处理 | ✅ 符合预期 | PASS |
| 付款借抬头-正常触发 | 生成6条记录，2.5%留存 | ✅ 符合预期 | PASS |

#### 过账规则测试

| 测试用例 | 预期结果 | 实际结果 | 状态 |
|----------|----------|----------|------|
| 标准过账-平收平付 | 6条记录，0.5%过账费 | ✅ 符合预期 | PASS |
| 抵消规则-多订单 | 净差额抵消 | ✅ 符合预期 | PASS |
| 综合清分-完整流程 | 借贷平衡，多规则 | ✅ 符合预期 | PASS |

#### 总结
- ✅ 所有核心功能测试通过
- ✅ 借抬头和过账规则运行正常  
- ✅ 系统稳定性良好
- ✅ 界面友好，操作简便

---

*OneOrder借抬头和过账规则功能测试手册 v1.0*  
*最后更新：2025年9月8日*