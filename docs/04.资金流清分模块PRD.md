# OneOrder资金流清分模块产品需求文档(PRD)

## 📋 文档信息
- **版本**: v1.0  
- **创建日期**: 2025-09-15
- **创建者**: Claude Code Assistant
- **项目**: OneOrder货代订单管理与财务清分系统
- **模块**: 资金流清分模块

## 🎯 模块概述

### 业务背景
资金流清分模块是OneOrder系统中负责法人间关联交易生成的核心模块。该模块在外部费用录入完成后，基于法人体维度进行实际资金流转计算，主要用于生成报税所需的法人体报表和财务合规处理。

### 核心价值
1. **法人体核算**: 提供准确的法人间关联交易数据
2. **税务合规**: 生成符合税务要求的法人体财务报表
3. **资金流透明**: 清晰展示各法人体的资金流入流出
4. **星式结算**: 优化资金流向，减少不必要的资金周转

## 📊 核心业务原则

### 处理原则
1. **法人体维度**: 完全基于法人实体进行计算，与管理账分润相反
2. **实际交易性质**: 生成真实的法人间关联交易，对应实际现金流
3. **星式结算逻辑**: 采用总包法人集中收付的资金流向模式
4. **成对交易生成**: 内部交易一收一付成对生成，确保账务平衡

### 核心计算公式
```
法人体留存毛利 = 法人组分润总额 - 借抬头法人留存金额
法人体资金流 = 对外净收入 - 需要留存毛利
流入(+) / 流出(-) = 资金流方向标识
```

## 🔧 详细业务流程

### 1. 法人体识别与分组

#### 1.1 参与法人体确认

**法人体类型识别**
- **客服ID对应法人**: 客服人员所属的法人实体
- **操作ID对应法人**: 操作人员所属的法人实体  
- **收款借抬头法人**: 用于收款的非默认法人实体
- **付款借抬头法人**: 用于付款的非默认法人实体

**法人组划分规则**
```
销售法人组 = 客服ID对应法人 + 借来收款的法人
操作法人组 = 操作ID对应法人 + 借来付款的法人
```

#### 1.2 法人组示例

**业务场景**
- 客服ID法人: A公司
- 操作ID法人: B公司
- C抬头收客户款1000元
- D抬头付供应商900元

**分组结果**
```
销售法人组: A公司(客服) + C公司(借抬头收款)
操作法人组: B公司(操作) + D公司(借抬头付款)
```

### 2. 法人体分润基准确定

#### 2.1 默认分润规则

**基准对齐原则**
- 法人体分润基准默认与管理分润保持一致
- 管理分润结果作为法人体分润的起始参考
- 确保管理账和资金流的毛利总额一致性

**基准示例**
```
管理分润结果: 销售部门50元毛利, 操作部门50元毛利
默认法人体分润: 销售法人组50元毛利, 操作法人组50元毛利
```

#### 2.2 法人体特殊分润规则

**特殊规则配置**
- 在部门分润规则的子表中配置法人体特殊规则
- 特殊规则优先级高于默认规则，会覆盖管理分润基准
- 按具体的法人体组合进行规则匹配

**特殊规则示例**
```
配置规则: A法人(客服) vs B法人(操作) → 70:30分润
应用结果: 销售法人组70元毛利, 操作法人组30元毛利
```

### 3. 借抬头留存计算

#### 3.1 收款借抬头留存规则

**适用条件判定**
- 借抬头法人不同时为该订单下任何一个服务的操作ID对应法人体
- 即该借抬头法人纯粹是收款用途，不承担操作职能

**留存计算模式**
```
模式1: 比例留存
留存金额 = 收款金额 × 留存比例

模式2: 固定留存  
留存金额 = 固定金额
```

**留存计算示例**
```
C抬头收款1000元，留存比例3%
C法人留存 = 1000 × 3% = 30元
```

#### 3.2 付款借抬头留存规则

**适用条件判定**
- 借抬头法人不同时为该订单下任何一个服务的操作ID或客服ID对应法人体
- 即该借抬头法人纯粹是付款用途，不承担业务职能

**留存计算模式**
```
模式1: 比例留存
留存金额 = 付款金额 × 留存比例

模式2: 固定留存
留存金额 = 固定金额
```

**留存计算示例**
```
D抬头付款900元，固定留存10元
D法人留存 = 10元
```

### 4. 法人体分润计算详例

#### 4.1 业务场景设定

**基础数据**
- 客服ID法人: A公司
- 操作ID法人: B公司  
- C抬头收客户款: 1000元
- D抬头付供应商: 900元
- C抬头留存规则: 收款金额3%
- D抬头留存规则: 固定10元
- 部门分润: 50:50
- A法人 vs B法人特殊规则: 70:30

#### 4.2 分步计算过程

**步骤1: 外部毛利计算**
```
总体毛利 = 1000 - 900 = 100元
```

**步骤2: 法人组分润计算**
```
符合A vs B特殊规则70:30
销售法人组分润 = 100 × 70% = 70元
操作法人组分润 = 100 × 30% = 30元
```

**步骤3: 销售法人组内部分配**
```
C法人(借抬头)留存 = 1000 × 3% = 30元
A法人(客服)留存 = 70 - 30 = 40元
```

**步骤4: 操作法人组内部分配**
```
D法人(借抬头)留存 = 10元(固定)
B法人(操作)留存 = 30 - 10 = 20元
```

**步骤5: 法人体留存汇总**
```
A法人留存: 40元
B法人留存: 20元  
C法人留存: 30元
D法人留存: 10元
合计留存: 40 + 20 + 30 + 10 = 100元 ✓
```

### 5. 资金流向计算

#### 5.1 流入流出判定

**计算原理**
```
法人体资金流 = 对外净收入 - 需要留存毛利
流入(正数): 需要从其他法人体获得资金
流出(负数): 需要向其他法人体支付资金
```

**实际计算**
```
A法人: 对外净收入0元, 需留存40元 → 流入40元
B法人: 对外净收入0元, 需留存20元 → 流入20元
C法人: 对外净收入1000元, 需留存30元 → 流出970元
D法人: 对外净收入-900元, 需留存10元 → 流入910元
```

#### 5.2 资金流验证

**平衡验证**
```
流入合计: 40 + 20 + 910 = 970元
流出合计: 970元
流入 = 流出 ✓ 资金流平衡
```

### 6. 星式结算逻辑

#### 6.1 总包法人确定规则

**确定优先级**
1. 如果客服ID对应法人为流出法人体 → 该法人作为总包法人
2. 如果客服ID对应法人为流入法人体 → 选择流出金额最多的法人作为总包法人

**总包法人确定**
```
客服ID法人: A法人(流入40元)
流出法人: C法人(流出970元)
总包法人: C法人(流出金额最多)
```

#### 6.2 资金流向生成

**星式流向设计**
```
总包法人(C) → 各流入法人
C → A: 40元
C → B: 20元  
C → D: 910元
```

**流向验证**
```
C法人总支出: 40 + 20 + 910 = 970元
C法人应流出: 970元 ✓
```

### 7. 多服务合并处理

#### 7.1 多服务计算策略

**处理原则**
- 逐个服务独立计算法人体留存
- 同一法人体在不同服务中的留存进行合并
- 最终得到订单级法人体留存汇总

**合并示例**
```
法人A在3个服务中的留存:
- MBL处理: 40元
- 内装: 15元
- 报关: 5元
合并结果: A法人总留存60元
```

#### 7.2 合并后资金流计算

**综合流向计算**
- 基于合并后的法人体留存重新计算资金流向
- 重新确定总包法人和星式结算路径
- 生成最终的内部交易明细

### 8. 内部交易生成

#### 8.1 交易特征

**交易属性**
- **只带法人属性**: 我方法人公司、对方法人公司
- **不带部门属性**: 与管理分润相反，无部门信息
- **成对生成**: 一收一付必须成对，确保账务平衡
- **统一科目**: 使用"内部运费"科目

#### 8.2 交易生成示例

**基于星式结算生成**
```
C支付A 40元:
- C付A 40元 (C法人付款)
- A收C 40元 (A法人收款)

C支付B 20元:
- C付B 20元 (C法人付款)  
- B收C 20元 (B法人收款)

C支付D 910元:
- C付D 910元 (C法人付款)
- D收C 910元 (D法人收款)
```

#### 8.3 交易汇总验证

**验证指标**
```
总付款笔数: 3笔
总收款笔数: 3笔
成对验证: ✓

C法人总付款: 40 + 20 + 910 = 970元
其他法人总收款: 40 + 20 + 910 = 970元
金额平衡: ✓
```

## 🎨 界面设计需求

### 1. 资金流清分主界面

#### 1.1 界面布局
```
+----------------------------------------------------------+
| OneOrder - 资金流清分               [重新计算] [导出]     |
+----------------------------------------------------------+
| 订单信息区域                                               |
| 订单号: HCBD20250915001  |  总毛利: 100.00元            |
| 清分状态: 已完成         |  清分时间: 2025-09-15 10:30    |
+----------------------------------------------------------+
| 法人体分润结果区域                            [展开/收起] |
| +------------------------------------------------------+ |
| | 法人名称 | 法人类型 | 留存毛利 | 对外收支 | 资金流向 | |
| | A公司    | 客服法人 | 40.00   | 0.00    | 流入40   | |
| | B公司    | 操作法人 | 20.00   | 0.00    | 流入20   | |
| | C公司    | 借抬头   | 30.00   | 1000.00 | 流出970  | |
| | D公司    | 借抬头   | 10.00   | -900.00 | 流入910  | |
| +------------------------------------------------------+ |
+----------------------------------------------------------+
| 星式结算流向区域                                          |
| 总包法人: C公司 [查看详情]                                |
| C → A: 40元  |  C → B: 20元  |  C → D: 910元           |
+----------------------------------------------------------+
```

#### 1.2 交互设计
- **法人钻取**: 点击法人名称查看该法人的详细收支明细
- **流向图表**: 可视化展示星式结算的资金流向
- **交易明细**: 查看生成的内部交易明细表
- **数据导出**: 支持导出法人体报表和内部交易明细

### 2. 法人体分润明细

#### 2.1 分润结果表
```
+--------------------------------------------------------+
| 法人体分润明细                                          |
+--------------------------------------------------------+
| 法人名称 | 法人类型 | 法人组 | 留存毛利 | 留存规则 | 备注 |
|----------|----------|--------|----------|----------|------|
| A公司    | 客服法人 | 销售组 | 40.00    | 组内分配 | 主体 |
| C公司    | 借抬头   | 销售组 | 30.00    | 3%比例   | 收款 |
| B公司    | 操作法人 | 操作组 | 20.00    | 组内分配 | 主体 |
| D公司    | 借抬头   | 操作组 | 10.00    | 固定10元 | 付款 |
+--------------------------------------------------------+
| 销售组小计: 70.00  |  操作组小计: 30.00  |  总计: 100.00 |
+--------------------------------------------------------+
```

#### 2.2 资金流向分析
```
+--------------------------------------------------------+
| 资金流向分析                                            |
+--------------------------------------------------------+
| 法人名称 | 对外收入 | 对外支出 | 净收支 | 留存毛利 | 资金流 |
|----------|----------|----------|--------|----------|--------|
| A公司    | 0.00     | 0.00     | 0.00   | 40.00    | +40.00 |
| B公司    | 0.00     | 0.00     | 0.00   | 20.00    | +20.00 |
| C公司    | 1000.00  | 0.00     | 1000.00| 30.00    | -970.00|
| D公司    | 0.00     | 900.00   | -900.00| 10.00    | +910.00|
+--------------------------------------------------------+
| 流入合计: 970.00  |  流出合计: 970.00  |  平衡: ✓     |
+--------------------------------------------------------+
```

### 3. 内部交易明细

#### 3.1 交易明细表
```
+--------------------------------------------------------+
| 内部交易明细                                            |
+--------------------------------------------------------+
| 交易对ID | 我方法人 | 对方法人 | 交易类型 | 金额   | 科目     |
|----------|----------|----------|----------|--------|----------|
| TXN001   | C公司    | A公司    | 付款     | 40.00  | 内部运费 |
| TXN001   | A公司    | C公司    | 收款     | 40.00  | 内部运费 |
| TXN002   | C公司    | B公司    | 付款     | 20.00  | 内部运费 |
| TXN002   | B公司    | C公司    | 收款     | 20.00  | 内部运费 |
| TXN003   | C公司    | D公司    | 付款     | 910.00 | 内部运费 |
| TXN003   | D公司    | C公司    | 收款     | 910.00 | 内部运费 |
+--------------------------------------------------------+
| 付款笔数: 3  |  收款笔数: 3  |  成对验证: ✓           |
+--------------------------------------------------------+
```

## 🔒 数据模型设计

### 1. 法人体特殊分润规则表
```sql
CREATE TABLE entity_special_profit_rules (
    id BIGSERIAL PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL,        -- 规则名称
    sales_entity_id VARCHAR(50) NOT NULL,   -- 销售法人ID(客服ID对应法人)
    operation_entity_id VARCHAR(50) NOT NULL, -- 操作法人ID(操作ID对应法人)
    sales_ratio DECIMAL(5,4) NOT NULL,      -- 销售法人组分润比例
    operation_ratio DECIMAL(5,4) NOT NULL,  -- 操作法人组分润比例
    priority INTEGER DEFAULT 1,             -- 优先级(数字越大优先级越高)
    effective_date DATE NOT NULL,           -- 生效日期
    expiry_date DATE,                       -- 失效日期
    status VARCHAR(20) DEFAULT 'ACTIVE',    -- 状态: ACTIVE/INACTIVE
    created_by VARCHAR(50) NOT NULL,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CHECK (sales_ratio + operation_ratio = 1.0000), -- 确保比例之和为100%
    INDEX idx_entity_pair (sales_entity_id, operation_entity_id),
    INDEX idx_priority_effective (priority DESC, effective_date DESC)
);
```

### 2. 借抬头留存规则表
```sql
CREATE TABLE transit_entity_retention_rules (
    id BIGSERIAL PRIMARY KEY,
    entity_id VARCHAR(50) NOT NULL,         -- 借抬头法人ID
    retention_type VARCHAR(20) NOT NULL,    -- 留存类型: PERCENTAGE/FIXED
    retention_value DECIMAL(15,4) NOT NULL, -- 留存值(比例小数或固定金额)
    transaction_type VARCHAR(20) NOT NULL,  -- 交易类型: RECEIVABLE/PAYABLE
    min_amount DECIMAL(15,2),               -- 最小适用金额
    max_amount DECIMAL(15,2),               -- 最大适用金额
    effective_date DATE NOT NULL,           -- 生效日期
    expiry_date DATE,                       -- 失效日期
    status VARCHAR(20) DEFAULT 'ACTIVE',    -- 状态: ACTIVE/INACTIVE
    created_by VARCHAR(50) NOT NULL,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_entity_type (entity_id, transaction_type),
    INDEX idx_effective_date (effective_date)
);
```

### 3. 法人体分润结果表
```sql
CREATE TABLE entity_profit_sharing_results (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    entity_id VARCHAR(50) NOT NULL,         -- 法人ID
    entity_name VARCHAR(200) NOT NULL,      -- 法人名称
    entity_type VARCHAR(30) NOT NULL,       -- 法人类型: SALES_PRIMARY/OPERATION_PRIMARY/TRANSIT_RECEIVABLE/TRANSIT_PAYABLE
    entity_group VARCHAR(20) NOT NULL,      -- 法人组: SALES_GROUP/OPERATION_GROUP
    retained_profit DECIMAL(15,2) NOT NULL, -- 留存毛利
    retention_rule_type VARCHAR(20),        -- 留存规则类型: GROUP_ALLOCATION/PERCENTAGE/FIXED
    retention_base_amount DECIMAL(15,2),    -- 留存计算基数
    retention_rate_or_amount DECIMAL(15,4), -- 留存比例或金额
    external_revenue DECIMAL(15,2) DEFAULT 0, -- 对外收入
    external_cost DECIMAL(15,2) DEFAULT 0,    -- 对外支出
    net_external_flow DECIMAL(15,2) DEFAULT 0, -- 对外净收支
    cash_flow_direction VARCHAR(10) NOT NULL, -- 资金流向: INFLOW/OUTFLOW
    cash_flow_amount DECIMAL(15,2) NOT NULL,  -- 资金流量
    is_general_contractor BOOLEAN DEFAULT FALSE, -- 是否为总包法人
    calculation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    calculation_version INTEGER DEFAULT 1,      -- 计算版本
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    INDEX idx_order_entity (order_id, entity_id),
    INDEX idx_entity_group (entity_group),
    INDEX idx_cash_flow (cash_flow_direction, cash_flow_amount)
);
```

### 4. 内部交易明细表
```sql
CREATE TABLE internal_transactions (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    transaction_pair_id VARCHAR(50) NOT NULL, -- 交易对ID(用于关联收付)
    sequence_number INTEGER NOT NULL,        -- 交易序号
    our_entity_id VARCHAR(50) NOT NULL,     -- 我方法人ID
    our_entity_name VARCHAR(200) NOT NULL,  -- 我方法人名称
    counterpart_entity_id VARCHAR(50) NOT NULL, -- 对方法人ID
    counterpart_entity_name VARCHAR(200) NOT NULL, -- 对方法人名称
    transaction_type VARCHAR(10) NOT NULL,  -- 交易类型: RECEIVABLE/PAYABLE
    amount DECIMAL(15,2) NOT NULL,          -- 交易金额
    currency VARCHAR(10) DEFAULT 'CNY',     -- 币种
    fee_code VARCHAR(50) DEFAULT 'INTERNAL_FREIGHT', -- 费用科目(默认内部运费)
    fee_name VARCHAR(100) DEFAULT '内部运费', -- 费用科目名称
    description VARCHAR(200),               -- 交易描述
    source_type VARCHAR(20) DEFAULT 'STAR_SETTLEMENT', -- 来源类型
    generated_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    INDEX idx_order_transaction (order_id, transaction_pair_id),
    INDEX idx_entity_pair (our_entity_id, counterpart_entity_id),
    INDEX idx_transaction_type (transaction_type)
);
```

### 5. 清分计算汇总表
```sql
CREATE TABLE cash_flow_clearing_summary (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    total_gross_profit DECIMAL(15,2) NOT NULL, -- 总毛利
    sales_group_profit DECIMAL(15,2) NOT NULL, -- 销售法人组分润
    operation_group_profit DECIMAL(15,2) NOT NULL, -- 操作法人组分润
    profit_sharing_rule VARCHAR(100),          -- 使用的分润规则
    entity_count INTEGER NOT NULL,             -- 参与法人数量
    inflow_entity_count INTEGER NOT NULL,      -- 流入法人数量
    outflow_entity_count INTEGER NOT NULL,     -- 流出法人数量
    total_inflow_amount DECIMAL(15,2) NOT NULL, -- 流入金额合计
    total_outflow_amount DECIMAL(15,2) NOT NULL, -- 流出金额合计
    general_contractor_entity_id VARCHAR(50),   -- 总包法人ID
    internal_transaction_count INTEGER DEFAULT 0, -- 内部交易笔数
    calculation_status VARCHAR(20) DEFAULT 'COMPLETED', -- 计算状态
    calculation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    calculation_version INTEGER DEFAULT 1,      -- 计算版本
    
    -- 验证约束
    CONSTRAINT chk_profit_balance CHECK (
        sales_group_profit + operation_group_profit = total_gross_profit
    ),
    CONSTRAINT chk_cash_flow_balance CHECK (
        total_inflow_amount = total_outflow_amount
    ),
    
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    UNIQUE (order_id, calculation_version),
    INDEX idx_calculation_status (calculation_status),
    INDEX idx_calculation_time (calculation_time)
);
```

## 🔧 API接口设计

### 1. 资金流清分计算API

#### 1.1 执行清分计算
```http
POST /api/cash-flow-clearing/calculate
Content-Type: application/json

{
    "orderId": "HCBD20250915001",
    "forceRecalculate": false,
    "useSpecialRules": true
}

Response:
{
    "code": 200,
    "message": "清分计算完成",
    "data": {
        "orderId": "HCBD20250915001",
        "calculationTime": "2025-09-15T10:30:00",
        "totalGrossProfit": 100.00,
        "salesGroupProfit": 70.00,
        "operationGroupProfit": 30.00,
        "entityCount": 4,
        "generalContractorEntityId": "ENTITY_C",
        "internalTransactionCount": 6,
        "calculationVersion": 1
    }
}
```

#### 1.2 查询清分结果
```http
GET /api/cash-flow-clearing/results/{orderId}

Response:
{
    "code": 200,
    "data": {
        "orderInfo": {
            "orderId": "HCBD20250915001",
            "totalGrossProfit": 100.00,
            "calculationStatus": "COMPLETED",
            "calculationTime": "2025-09-15T10:30:00"
        },
        "entityResults": [
            {
                "entityId": "ENTITY_A",
                "entityName": "A公司",
                "entityType": "SALES_PRIMARY",
                "entityGroup": "SALES_GROUP",
                "retainedProfit": 40.00,
                "externalRevenue": 0.00,
                "externalCost": 0.00,
                "cashFlowDirection": "INFLOW",
                "cashFlowAmount": 40.00
            }
        ],
        "internalTransactions": [
            {
                "transactionPairId": "TXN001",
                "ourEntityId": "ENTITY_C",
                "counterpartEntityId": "ENTITY_A",
                "transactionType": "PAYABLE",
                "amount": 40.00,
                "feeCode": "INTERNAL_FREIGHT"
            }
        ],
        "summary": {
            "totalInflowAmount": 970.00,
            "totalOutflowAmount": 970.00,
            "generalContractorEntity": "C公司",
            "cashFlowBalanced": true
        }
    }
}
```

### 2. 法人体规则管理API

#### 2.1 查询适用的特殊分润规则
```http
GET /api/cash-flow-clearing/special-rules
?salesEntityId=ENTITY_A
&operationEntityId=ENTITY_B
&businessDate=2025-09-15

Response:
{
    "code": 200,
    "data": {
        "ruleId": 1,
        "ruleName": "A公司-B公司特殊分润规则",
        "salesRatio": 0.7000,
        "operationRatio": 0.3000,
        "priority": 10,
        "effectiveDate": "2025-01-01"
    }
}
```

#### 2.2 查询借抬头留存规则
```http
GET /api/cash-flow-clearing/retention-rules/{entityId}
?transactionType=RECEIVABLE

Response:
{
    "code": 200,
    "data": {
        "entityId": "ENTITY_C",
        "retentionType": "PERCENTAGE",
        "retentionValue": 0.0300,
        "transactionType": "RECEIVABLE",
        "minAmount": 0.00,
        "maxAmount": null,
        "effectiveDate": "2025-01-01"
    }
}
```

## 🚀 业务规则引擎

### 1. 法人体分润规则引擎

```java
public class EntityProfitSharingEngine {
    
    // 规则1: 确定法人体分润基准
    public EntityGroupProfitSharingResult determineEntityGroupProfit(
            String orderId,
            BigDecimal totalGrossProfit,
            ManagementProfitSharingResult managementResult) {
        
        // 查找特殊分润规则
        Optional<EntitySpecialProfitRule> specialRule = findSpecialRule(orderId);
        
        if (specialRule.isPresent()) {
            // 应用特殊规则
            return applySpecialRule(totalGrossProfit, specialRule.get());
        } else {
            // 使用管理分润基准
            return alignWithManagementProfit(managementResult);
        }
    }
    
    // 规则2: 计算借抬头留存
    public BigDecimal calculateTransitEntityRetention(
            String entityId,
            BigDecimal baseAmount,
            TransactionType transactionType) {
        
        TransitEntityRetentionRule rule = findRetentionRule(entityId, transactionType);
        
        if (RetentionType.PERCENTAGE.equals(rule.getRetentionType())) {
            return baseAmount.multiply(rule.getRetentionValue());
        } else {
            return rule.getRetentionValue();
        }
    }
    
    // 规则3: 计算法人体组内分配
    public List<EntityProfitAllocation> allocateWithinGroup(
            EntityGroup group,
            BigDecimal groupTotalProfit) {
        
        List<EntityProfitAllocation> allocations = new ArrayList<>();
        BigDecimal remainingProfit = groupTotalProfit;
        
        // 先计算借抬头留存
        for (Entity transitEntity : group.getTransitEntities()) {
            BigDecimal retention = calculateTransitEntityRetention(transitEntity);
            allocations.add(new EntityProfitAllocation(transitEntity, retention));
            remainingProfit = remainingProfit.subtract(retention);
        }
        
        // 主体法人获得剩余利润
        Entity primaryEntity = group.getPrimaryEntity();
        allocations.add(new EntityProfitAllocation(primaryEntity, remainingProfit));
        
        return allocations;
    }
}
```

### 2. 星式结算引擎

```java
public class StarSettlementEngine {
    
    // 确定总包法人
    public Entity determineGeneralContractor(List<EntityCashFlow> cashFlows, String salesEntityId) {
        
        List<EntityCashFlow> outflowEntities = cashFlows.stream()
            .filter(cf -> cf.getCashFlowDirection() == CashFlowDirection.OUTFLOW)
            .collect(Collectors.toList());
            
        // 规则1: 如果销售法人是流出法人，则作为总包法人
        Optional<EntityCashFlow> salesEntityFlow = outflowEntities.stream()
            .filter(cf -> salesEntityId.equals(cf.getEntityId()))
            .findFirst();
            
        if (salesEntityFlow.isPresent()) {
            return salesEntityFlow.get().getEntity();
        }
        
        // 规则2: 选择流出金额最多的法人作为总包法人
        return outflowEntities.stream()
            .max(Comparator.comparing(EntityCashFlow::getCashFlowAmount))
            .map(EntityCashFlow::getEntity)
            .orElseThrow(() -> new RuntimeException("找不到合适的总包法人"));
    }
    
    // 生成星式结算路径
    public List<InternalTransaction> generateStarSettlementPaths(
            Entity generalContractor,
            List<EntityCashFlow> inflowEntities) {
        
        List<InternalTransaction> transactions = new ArrayList<>();
        
        for (EntityCashFlow inflowEntity : inflowEntities) {
            // 生成总包法人向流入法人的支付
            String transactionPairId = generateTransactionPairId();
            BigDecimal amount = inflowEntity.getCashFlowAmount();
            
            // 付款交易
            transactions.add(InternalTransaction.builder()
                .transactionPairId(transactionPairId)
                .ourEntityId(generalContractor.getEntityId())
                .counterpartEntityId(inflowEntity.getEntityId())
                .transactionType(TransactionType.PAYABLE)
                .amount(amount)
                .feeCode("INTERNAL_FREIGHT")
                .build());
                
            // 收款交易
            transactions.add(InternalTransaction.builder()
                .transactionPairId(transactionPairId)
                .ourEntityId(inflowEntity.getEntityId())
                .counterpartEntityId(generalContractor.getEntityId())
                .transactionType(TransactionType.RECEIVABLE)
                .amount(amount)
                .feeCode("INTERNAL_FREIGHT")
                .build());
        }
        
        return transactions;
    }
}
```

## 📋 验收标准

### 功能验收
- ✅ 法人体识别和分组准确，销售法人组和操作法人组划分正确
- ✅ 法人体特殊分润规则能够覆盖默认管理分润基准
- ✅ 借抬头留存计算准确，支持比例留存和固定留存
- ✅ 星式结算逻辑正确，总包法人确定规则符合业务要求
- ✅ 内部交易成对生成，使用内部运费科目，法人属性完整
- ✅ 多服务业务的法人利润合并计算正确
- ✅ 资金流向计算准确，流入流出平衡

### 数据准确性验收
- ✅ 法人体分润总额等于订单总毛利
- ✅ 资金流入金额等于资金流出金额
- ✅ 内部交易收款金额等于付款金额
- ✅ 法人体留存金额符合配置的留存规则
- ✅ 星式结算路径完整，无遗漏法人体

### 性能验收
- ✅ 单订单清分计算时间 < 5秒
- ✅ 支持100+法人体的复杂订单清分
- ✅ 并发清分能力支持20+用户同时操作
- ✅ 内部交易生成响应时间 < 3秒

## 🎊 业务价值

### 财务合规支撑
1. **法人体核算**: 提供准确的法人间关联交易数据
2. **税务报表**: 生成符合税务要求的法人体财务报表
3. **合规审计**: 完整的内部交易审计轨迹
4. **风险控制**: 清晰的资金流向，降低合规风险

### 资金管理优化
1. **星式结算**: 减少不必要的资金周转，提高资金效率
2. **流向透明**: 实时了解各法人体的资金流入流出状况
3. **集中管控**: 通过总包法人实现资金的集中管理
4. **精确核算**: 基于实际业务的法人体利润分配

### 业务决策支持
1. **法人体绩效**: 评估各法人体的盈利能力和资金贡献
2. **借抬头管理**: 优化借抬头使用策略，降低留存成本
3. **资金规划**: 为资金预算和流动性管理提供数据支撑
4. **业务优化**: 基于法人体分润数据优化业务结构

---

## 附录

### A. 法人体类型定义
- **SALES_PRIMARY**: 销售主体法人(客服ID对应法人)
- **OPERATION_PRIMARY**: 操作主体法人(操作ID对应法人)
- **TRANSIT_RECEIVABLE**: 收款借抬头法人
- **TRANSIT_PAYABLE**: 付款借抬头法人

### B. 特殊分润规则示例
```json
{
  "ruleName": "A公司-B公司特殊分润规则",
  "salesEntityId": "ENTITY_A",
  "operationEntityId": "ENTITY_B",
  "salesRatio": 0.7000,
  "operationRatio": 0.3000,
  "priority": 10,
  "effectiveDate": "2025-01-01"
}
```

### C. 借抬头留存规则示例
```json
{
  "entityId": "ENTITY_C",
  "retentionType": "PERCENTAGE",
  "retentionValue": 0.0300,
  "transactionType": "RECEIVABLE",
  "minAmount": 1000.00,
  "effectiveDate": "2025-01-01"
}
```

### D. 错误码定义
- CF001: 法人体信息不完整
- CF002: 找不到适用的特殊分润规则
- CF003: 借抬头留存规则配置错误
- CF004: 资金流计算不平衡
- CF005: 总包法人确定失败

---
*最后更新: 2025-09-15*  
*文档版本: v1.0*  
*项目: OneOrder资金流清分模块*