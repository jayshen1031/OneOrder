# OneOrder管理账分润计算模块产品需求文档(PRD)

## 📋 文档信息
- **版本**: v1.1  
- **创建日期**: 2025-09-15
- **更新日期**: 2025-09-15 (新增多服务合并处理逻辑和五项要素汇总)
- **创建者**: Claude Code Assistant
- **项目**: OneOrder货代订单管理与财务清分系统
- **模块**: 管理账分润计算模块

## 🎯 模块概述

### 业务背景
管理账分润计算模块是OneOrder系统中负责部门间利润分配的核心模块。该模块在外部费用录入完成后，基于部门维度进行虚拟利润分配，主要用于内部考核激励和绩效评估。

### 核心价值
1. **部门绩效评估**: 提供部门级别的收入支出和毛利数据
2. **激励机制支撑**: 为薪酬激励提供客观的利润分配依据
3. **管理决策支持**: 帮助管理层了解各部门的盈利能力
4. **虚拟账户管理**: 实现部门间虚拟资金流转和利润分配

## 📊 核心业务原则

### 业务处理原则
1. **忽略法人因素**: 管理账计算过程中完全不考虑借抬头等法人问题
2. **部门维度计算**: 只关注我方部门和对方部门，不涉及法人属性
3. **服务分组计算**: 按服务项目分别计算，每个服务独立处理
4. **虚拟利润性质**: 分润结果为虚拟账户金额，不代表实际资金支付

### 计算核心公式
```
服务毛利 = 该服务下所有外部收入 - 该服务下所有外部支出
销售部门分润 = 服务毛利 × 销售分润比例
操作部门分润 = 服务毛利 × 操作分润比例
销售部门内部支出 = 操作部门外部支出 + 操作部门分润
操作部门内部收入 = 销售部门内部支出
```

## 🔧 详细业务流程

### 1. 计算触发条件

**前置条件**
- 外部收付明细已全部录入完成
- 费用明细数据通过完整性校验
- 相关服务的内部协议已配置完成

**触发方式**
- 自动触发：费用录入状态变更为"已完成"时
- 手动触发：用户主动点击"计算管理分润"按钮
- 批量触发：定时任务批量计算待处理订单

### 2. 服务维度分组

**服务识别规则**
- 从费用明细中提取所有涉及的服务项目
- 每个服务对应一个操作部门(通过操作ID确定)
- 每个服务对应一个销售部门(通过客服ID确定)

**分组示例**
```
订单HCBD20250915001包含服务:
- MBL处理: 销售部门(海运销售部), 操作部门(海运操作部)
- 内装: 销售部门(海运销售部), 操作部门(内装操作部)  
- 报关: 销售部门(海运销售部), 操作部门(报关部)
```

### 3. 服务毛利计算

**收入汇总计算**
```sql
SELECT service_code, SUM(amount) as total_revenue
FROM expense_entries 
WHERE order_id = ? AND entry_type = 'RECEIVABLE'
GROUP BY service_code
```

**支出汇总计算**
```sql
SELECT service_code, SUM(amount) as total_cost
FROM expense_entries 
WHERE order_id = ? AND entry_type = 'PAYABLE'
GROUP BY service_code
```

**毛利计算**
```
服务毛利 = 服务总收入 - 服务总支出
```

### 4. 内部协议匹配

**协议查找优先级**
1. 特定服务+特定部门组合的专用协议
2. 特定服务的通用协议
3. 全局默认协议

**协议匹配示例**
```
查找条件: 服务=MBL处理, 销售部门=海运销售部, 操作部门=海运操作部
匹配结果: 销售分润50%, 操作分润50%
```

### 5. 分润计算详例

**业务场景**
- 服务: MBL处理
- 销售部门收客户款: 1000元
- 操作部门付供应商: 900元  
- 内部协议: 50% vs 50%

**计算步骤**
```
步骤1: 服务毛利计算
服务毛利 = 1000 - 900 = 100元

步骤2: 分润金额计算  
销售部门分润 = 100 × 50% = 50元
操作部门分润 = 100 × 50% = 50元

步骤3: 内部流转计算
销售部门内部支出 = 900 + 50 = 950元
操作部门内部收入 = 950元

步骤4: 部门收支汇总
销售部门: 外部收入1000元, 内部支出950元, 净利润50元
操作部门: 内部收入950元, 外部支出900元, 净利润50元
```

### 6. 多服务合并处理

#### 6.1 多服务计算原则

**分步计算策略**
1. **服务独立计算**: 首先分别计算每个服务项下的分润结果
2. **部门维度合并**: 对一个订单下的各项进行合并同类项
3. **五项要素汇总**: 每个部门包含外部收入、内部支出、内部收入、外部支出、部门毛利

**计算公式**
```
部门毛利 = 外部收入 + 内部收入 - 内部支出 - 外部支出
```

**内部收支分离原因**
- 内部收入、内部支出单独列示
- 便于后续合并管理报表时进行内部交易抵消
- 支持集团管理报表的生成和合并

#### 6.2 多服务计算详例

**业务场景**
一个海运订单包含3个服务项目：
- MBL处理: 销售收1000元，操作付900元，50%-50%分润
- 内装: 销售收300元，操作付280元，50%-50%分润  
- 报关: 销售收80元，操作付60元，50%-50%分润

**分步计算过程**

**步骤1: 各服务独立计算**
```
MBL处理服务:
- 服务毛利: 1000 - 900 = 100元
- 销售分润: 100 × 50% = 50元
- 操作分润: 100 × 50% = 50元
- 销售内部支出: 900 + 50 = 950元
- 操作内部收入: 950元

内装服务:
- 服务毛利: 300 - 280 = 20元
- 销售分润: 20 × 50% = 10元
- 操作分润: 20 × 50% = 10元
- 销售内部支出: 280 + 10 = 290元
- 操作内部收入: 290元

报关服务:
- 服务毛利: 80 - 60 = 20元
- 销售分润: 20 × 50% = 10元
- 操作分润: 20 × 50% = 10元
- 销售内部支出: 60 + 10 = 70元
- 操作内部收入: 70元
```

**步骤2: 部门维度合并**
```
海运销售部合并结果:
- 外部收入: 1000 + 300 + 80 = 1380元
- 内部支出: 950 + 290 + 70 = 1310元
- 内部收入: 0元
- 外部支出: 0元
- 部门毛利: 1380 + 0 - 1310 - 0 = 70元

海运操作部合并结果:
- 外部收入: 0元
- 内部支出: 0元
- 内部收入: 950元
- 外部支出: 900元
- 部门毛利: 0 + 950 - 0 - 900 = 50元

内装操作部合并结果:
- 外部收入: 0元
- 内部支出: 0元
- 内部收入: 290元
- 外部支出: 280元
- 部门毛利: 0 + 290 - 0 - 280 = 10元

报关部合并结果:
- 外部收入: 0元
- 内部支出: 0元
- 内部收入: 70元
- 外部支出: 60元
- 部门毛利: 0 + 70 - 0 - 60 = 10元
```

**步骤3: 验证平衡**
```
总体验证:
- 各部门毛利合计: 70 + 50 + 10 + 10 = 140元
- 订单总毛利: (1000+300+80) - (900+280+60) = 140元
- 内部收支抵消: 内部收入合计 = 内部支出合计 = 1310元
```

#### 6.3 最终管理报表格式

**订单级部门汇总表**
| 部门名称 | 外部收入 | 内部收入 | 内部支出 | 外部支出 | 部门毛利 |
|---------|----------|----------|----------|----------|----------|
| 海运销售部 | 1380.00 | 0.00 | 1310.00 | 0.00 | 70.00 |
| 海运操作部 | 0.00 | 950.00 | 0.00 | 900.00 | 50.00 |
| 内装操作部 | 0.00 | 290.00 | 0.00 | 280.00 | 10.00 |
| 报关部 | 0.00 | 70.00 | 0.00 | 60.00 | 10.00 |
| **合计** | **1380.00** | **1310.00** | **1310.00** | **1240.00** | **140.00** |

**关键验证指标**
- ✅ 内部收入 = 内部支出 (1310.00元)
- ✅ 部门毛利合计 = 订单总毛利 (140.00元)
- ✅ (外部收入+内部收入) = (内部支出+外部支出) + 部门毛利

#### 6.4 集团合并支撑

**内部交易抵消机制**
```sql
-- 集团报表合并时的内部交易抵消
SELECT 
    department_id,
    SUM(external_revenue) as total_external_revenue,
    SUM(external_cost) as total_external_cost,
    SUM(internal_income - internal_payment) as net_internal_flow,
    SUM(department_profit) as total_department_profit
FROM department_profit_summary 
WHERE order_date BETWEEN ? AND ?
GROUP BY department_id
```

**多层级汇总支持**
- 支持按部门、业务类型、时间维度的多层级汇总
- 内部收支单独列示便于不同汇总口径的计算
- 为集团管理报表提供标准化的数据接口

## 🎨 界面设计需求

### 1. 管理账分润主界面

#### 1.1 界面布局
```
+----------------------------------------------------------+
| OneOrder - 管理账分润计算              [重新计算] [导出] |
+----------------------------------------------------------+
| 订单信息区域                                               |
| 订单号: HCBD20250915001  |  客户: 上海XX贸易有限公司       |
| 计算状态: 已完成         |  计算时间: 2025-09-15 10:30    |
+----------------------------------------------------------+
| 服务分润明细区域                              [展开/收起] |
| +------------------------------------------------------+ |
| | 服务 | 外部收入 | 外部支出 | 毛利 | 销售分润 | 操作分润 | |
| | MBL  | 1000     | 900     | 100  | 50      | 50      | |
| | 内装 | 300      | 280     | 20   | 10      | 10      | |
| +------------------------------------------------------+ |
+----------------------------------------------------------+
| 部门汇总区域                                              |
| [销售部门] [操作部门] 切换标签                             |
| 部门收支汇总表                                            |
+----------------------------------------------------------+
```

#### 1.2 交互设计
- **实时计算**: 费用明细变更后可重新计算分润
- **钻取查询**: 点击部门可查看该部门的详细收支明细
- **数据导出**: 支持Excel/PDF格式导出分润报表
- **历史对比**: 可查看历史版本的分润计算结果

### 2. 服务分润明细表

#### 2.1 表格结构
```
+--------------------------------------------------------+
| 服务分润明细                                            |
+--------------------------------------------------------+
| 服务项目 | 外部收入 | 外部支出 | 毛利 | 分润比例 | 销售分润 | 操作分润 |
|----------|----------|----------|------|----------|----------|----------|
| MBL处理  | 1000.00  | 900.00   | 100  | 50%:50%  | 50.00    | 50.00    |
| 内装     | 300.00   | 280.00   | 20   | 50%:50%  | 10.00    | 10.00    |
| 报关     | 80.00    | 60.00    | 20   | 50%:50%  | 10.00    | 10.00    |
+--------------------------------------------------------+
| 合计     | 1380.00  | 1240.00  | 140  | -        | 70.00    | 70.00    |
+--------------------------------------------------------+
```

#### 2.2 交互功能
- **排序功能**: 支持按金额、毛利率等字段排序
- **筛选功能**: 可按服务类型、部门等条件筛选
- **详情查看**: 点击服务名称可查看该服务的费用明细

### 3. 部门收支汇总

#### 3.1 五项要素完整视图
```
+--------------------------------------------------------+
| 部门收支五项要素汇总                                    |
+--------------------------------------------------------+
| 部门名称 | 外部收入 | 内部收入 | 内部支出 | 外部支出 | 部门毛利 |
|----------|----------|----------|----------|----------|----------|
| 海运销售部| 1380.00  | 0.00     | 1310.00  | 0.00     | 70.00    |
| 海运操作部| 0.00     | 950.00   | 0.00     | 900.00   | 50.00    |
| 内装操作部| 0.00     | 290.00   | 0.00     | 280.00   | 10.00    |
| 报关部   | 0.00     | 70.00    | 0.00     | 60.00    | 10.00    |
| **合计** | **1380.00**| **1310.00**| **1310.00**| **1240.00**| **140.00**|
+--------------------------------------------------------+
| 验证指标：内部收入 = 内部支出 ✓                        |
|         部门毛利合计 = 订单总毛利 ✓                     |
+--------------------------------------------------------+
```

#### 3.2 销售部门详细视图
```
+--------------------------------------------------------+
| 海运销售部收支详情                                      |
+--------------------------------------------------------+
| 项目     | 金额      | 占比    | 说明                    |
|----------|-----------|---------|-------------------------|
| 外部收入 | 1380.00   | 100%    | 向客户收取的费用        |
| 内部收入 | 0.00      | 0%      | 从其他部门收取的费用    |
| 内部支出 | 1310.00   | 94.9%   | 向操作部门支付的费用    |
| 外部支出 | 0.00      | 0%      | 向外部供应商支付        |
| 部门毛利 | 70.00     | 5.1%    | 销售部门留存利润        |
+--------------------------------------------------------+
| 计算验证: 1380 + 0 - 1310 - 0 = 70 ✓                  |
+--------------------------------------------------------+
```

#### 3.3 操作部门详细视图
```
+--------------------------------------------------------+
| 海运操作部收支详情                                      |
+--------------------------------------------------------+
| 项目     | 金额      | 占比    | 说明                    |
|----------|-----------|---------|-------------------------|
| 外部收入 | 0.00      | 0%      | 向客户收取的费用        |
| 内部收入 | 950.00    | 100%    | 从销售部门收取的费用    |
| 内部支出 | 0.00      | 0%      | 向其他部门支付的费用    |
| 外部支出 | 900.00    | 94.7%   | 向供应商支付的费用      |
| 部门毛利 | 50.00     | 5.3%    | 操作部门留存利润        |
+--------------------------------------------------------+
| 计算验证: 0 + 950 - 0 - 900 = 50 ✓                    |
+--------------------------------------------------------+
```

#### 3.4 内部交易抵消验证
```
+--------------------------------------------------------+
| 内部交易抵消验证                                        |
+--------------------------------------------------------+
| 验证项目           | 计算结果    | 状态              |
|-------------------|-------------|-------------------|
| 内部收入合计       | 1310.00     | ✅ 正确           |
| 内部支出合计       | 1310.00     | ✅ 正确           |
| 内部收支差额       | 0.00        | ✅ 平衡           |
| 部门毛利合计       | 140.00      | ✅ 与总毛利一致    |
| 外部收支差额       | 140.00      | ✅ 与毛利一致      |
+--------------------------------------------------------+
```

## 🔒 数据模型设计

### 1. 管理账分润结果表
```sql
CREATE TABLE management_profit_sharing_results (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    service_code VARCHAR(50) NOT NULL,
    sales_department_id VARCHAR(50) NOT NULL,  -- 销售部门ID
    operation_department_id VARCHAR(50) NOT NULL, -- 操作部门ID
    external_revenue DECIMAL(15,2) NOT NULL,   -- 外部收入
    external_cost DECIMAL(15,2) NOT NULL,      -- 外部支出
    gross_profit DECIMAL(15,2) NOT NULL,       -- 毛利
    profit_sharing_ratio VARCHAR(20) NOT NULL, -- 分润比例(如"50:50")
    sales_profit_amount DECIMAL(15,2) NOT NULL, -- 销售分润金额
    operation_profit_amount DECIMAL(15,2) NOT NULL, -- 操作分润金额
    sales_internal_payment DECIMAL(15,2) NOT NULL, -- 销售内部支出
    operation_internal_income DECIMAL(15,2) NOT NULL, -- 操作内部收入
    calculation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    calculation_version INTEGER DEFAULT 1,      -- 计算版本
    status VARCHAR(20) DEFAULT 'ACTIVE',        -- 状态: ACTIVE/ARCHIVED
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    INDEX idx_order_service (order_id, service_code),
    INDEX idx_calculation_time (calculation_time)
);
```

### 2. 部门汇总表
```sql
CREATE TABLE department_profit_summary (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    department_id VARCHAR(50) NOT NULL,        -- 部门ID
    department_name VARCHAR(100) NOT NULL,     -- 部门名称
    department_type VARCHAR(20) NOT NULL,      -- 部门类型: SALES/OPERATION
    external_revenue DECIMAL(15,2) DEFAULT 0,  -- 外部收入
    internal_income DECIMAL(15,2) DEFAULT 0,   -- 内部收入
    internal_payment DECIMAL(15,2) DEFAULT 0,  -- 内部支出
    external_cost DECIMAL(15,2) DEFAULT 0,     -- 外部支出
    department_profit DECIMAL(15,2) NOT NULL,  -- 部门毛利
    profit_margin DECIMAL(5,4),                -- 利润率
    service_count INTEGER DEFAULT 0,           -- 涉及服务数量
    calculation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    calculation_version INTEGER DEFAULT 1,      -- 计算版本
    
    -- 验证约束：部门毛利 = 外部收入 + 内部收入 - 内部支出 - 外部支出
    CONSTRAINT chk_profit_balance CHECK (
        department_profit = external_revenue + internal_income - internal_payment - external_cost
    ),
    
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    UNIQUE (order_id, department_id),
    INDEX idx_department_type (department_type),
    INDEX idx_profit_margin (profit_margin),
    INDEX idx_calculation_time (calculation_time)
);
```

### 3. 内部协议配置表
```sql
CREATE TABLE internal_profit_sharing_protocols (
    id BIGSERIAL PRIMARY KEY,
    protocol_name VARCHAR(100) NOT NULL,       -- 协议名称
    service_code VARCHAR(50),                  -- 适用服务(NULL表示全部)
    sales_department_id VARCHAR(50),           -- 适用销售部门(NULL表示全部)
    operation_department_id VARCHAR(50),       -- 适用操作部门(NULL表示全部)
    sales_ratio DECIMAL(5,4) NOT NULL,         -- 销售分润比例
    operation_ratio DECIMAL(5,4) NOT NULL,     -- 操作分润比例
    priority INTEGER DEFAULT 1,                -- 优先级(数字越大优先级越高)
    effective_date DATE NOT NULL,              -- 生效日期
    expiry_date DATE,                          -- 失效日期
    status VARCHAR(20) DEFAULT 'ACTIVE',       -- 状态: ACTIVE/INACTIVE
    created_by VARCHAR(50) NOT NULL,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(50),
    updated_time TIMESTAMP,
    CHECK (sales_ratio + operation_ratio = 1.0000), -- 确保比例之和为100%
    INDEX idx_service_department (service_code, sales_department_id, operation_department_id),
    INDEX idx_priority_effective (priority DESC, effective_date DESC)
);
```

## 🔧 API接口设计

### 1. 管理账分润计算API

#### 1.1 计算分润接口
```http
POST /api/management-profit/calculate
Content-Type: application/json

{
    "orderId": "HCBD20250915001",
    "forceRecalculate": false  // 是否强制重新计算
}

Response:
{
    "code": 200,
    "message": "计算成功",
    "data": {
        "orderId": "HCBD20250915001",
        "calculationTime": "2025-09-15T10:30:00",
        "totalGrossProfit": 140.00,
        "serviceCount": 3,
        "departmentCount": 4,
        "calculationVersion": 1
    }
}
```

#### 1.2 查询分润结果接口
```http
GET /api/management-profit/results/{orderId}

Response:
{
    "code": 200,
    "data": {
        "orderInfo": {
            "orderId": "HCBD20250915001",
            "customerName": "上海XX贸易有限公司",
            "calculationStatus": "COMPLETED",
            "calculationTime": "2025-09-15T10:30:00"
        },
        "serviceResults": [
            {
                "serviceCode": "MBL_PROCESSING",
                "serviceName": "MBL处理",
                "externalRevenue": 1000.00,
                "externalCost": 900.00,
                "grossProfit": 100.00,
                "profitSharingRatio": "50:50",
                "salesProfitAmount": 50.00,
                "operationProfitAmount": 50.00,
                "salesInternalPayment": 950.00,
                "operationInternalIncome": 950.00
            }
        ],
        "departmentSummary": [
            {
                "departmentId": "OCEAN_SALES",
                "departmentName": "海运销售部",
                "departmentType": "SALES",
                "totalExternalRevenue": 1380.00,
                "totalInternalPayment": 1290.00,
                "netProfit": 90.00,
                "profitMargin": 0.0652
            }
        ]
    }
}
```

### 2. 协议管理API

#### 2.1 查询适用协议接口
```http
GET /api/management-profit/protocols
?serviceCode=MBL_PROCESSING
&salesDeptId=OCEAN_SALES
&operationDeptId=OCEAN_OPERATION

Response:
{
    "code": 200,
    "data": {
        "protocolId": 1,
        "protocolName": "海运MBL处理标准协议",
        "salesRatio": 0.5000,
        "operationRatio": 0.5000,
        "effectiveDate": "2025-01-01",
        "priority": 10
    }
}
```

## 🚀 业务规则引擎

### 1. 计算规则配置

**基础计算规则**
```java
public class ManagementProfitCalculationRules {
    
    // 规则1: 服务毛利计算
    public BigDecimal calculateServiceGrossProfit(List<ExpenseEntry> entries) {
        BigDecimal revenue = entries.stream()
            .filter(e -> EntryType.RECEIVABLE.equals(e.getEntryType()))
            .map(ExpenseEntry::getAmount)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
            
        BigDecimal cost = entries.stream()
            .filter(e -> EntryType.PAYABLE.equals(e.getEntryType()))
            .map(ExpenseEntry::getAmount)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
            
        return revenue.subtract(cost);
    }
    
    // 规则2: 分润比例应用
    public ProfitSharingResult applyProfitSharingRatio(
            BigDecimal grossProfit, 
            InternalProtocol protocol) {
        BigDecimal salesProfit = grossProfit.multiply(protocol.getSalesRatio());
        BigDecimal operationProfit = grossProfit.multiply(protocol.getOperationRatio());
        
        return ProfitSharingResult.builder()
            .salesProfitAmount(salesProfit)
            .operationProfitAmount(operationProfit)
            .build();
    }
    
    // 规则3: 内部支付计算
    public BigDecimal calculateInternalPayment(
            BigDecimal externalCost, 
            BigDecimal operationProfitAmount) {
        return externalCost.add(operationProfitAmount);
    }
}
```

### 2. 协议匹配规则

**匹配优先级算法**
```java
public class ProtocolMatcher {
    
    public InternalProtocol findBestMatchProtocol(
            String serviceCode,
            String salesDeptId, 
            String operationDeptId,
            LocalDate businessDate) {
        
        List<InternalProtocol> candidates = protocolRepository
            .findActiveProtocols(businessDate);
            
        // 按优先级排序并匹配
        return candidates.stream()
            .sorted(Comparator.comparing(InternalProtocol::getPriority).reversed())
            .filter(p -> matchesService(p, serviceCode))
            .filter(p -> matchesDepartments(p, salesDeptId, operationDeptId))
            .findFirst()
            .orElse(getDefaultProtocol());
    }
    
    private boolean matchesService(InternalProtocol protocol, String serviceCode) {
        return protocol.getServiceCode() == null || 
               protocol.getServiceCode().equals(serviceCode);
    }
    
    private boolean matchesDepartments(InternalProtocol protocol, 
                                     String salesDeptId, 
                                     String operationDeptId) {
        boolean salesMatch = protocol.getSalesDepartmentId() == null || 
                           protocol.getSalesDepartmentId().equals(salesDeptId);
        boolean operationMatch = protocol.getOperationDepartmentId() == null || 
                               protocol.getOperationDepartmentId().equals(operationDeptId);
        return salesMatch && operationMatch;
    }
}
```

## 📋 验收标准

### 功能验收
- ✅ 能够基于费用明细正确计算各服务的毛利
- ✅ 协议匹配算法按优先级正确选择分润规则
- ✅ 分润计算结果准确，销售和操作部门分润之和等于毛利
- ✅ 内部支付计算正确，操作部门内部收入等于销售部门内部支出
- ✅ 多服务场景下部门汇总数据准确
- ✅ 计算结果只包含部门属性，不包含法人属性
- ✅ 虚拟利润性质得到正确体现

### 性能验收
- ✅ 单订单分润计算时间 < 3秒
- ✅ 支持100+服务项目的复杂订单计算
- ✅ 并发计算能力支持20+用户同时操作
- ✅ 历史数据查询响应时间 < 2秒

### 数据准确性验收
- ✅ 收入支出平衡：所有收入等于所有支出
- ✅ 毛利一致性：部门毛利之和等于订单总毛利
- ✅ 分润比例验证：分润金额符合协议配置
- ✅ 数据溯源：可追溯到具体的费用明细来源

## 🎊 业务价值

### 管理决策支持
1. **部门绩效透明化**: 清晰展示各部门的盈利贡献
2. **激励机制优化**: 为绩效奖金提供客观分配依据
3. **成本控制改进**: 识别高成本服务环节，优化操作流程
4. **业务策略调整**: 基于分润数据调整业务重点和资源配置

### 运营效率提升
1. **自动化计算**: 减少人工计算错误，提高数据准确性
2. **实时分析**: 支持实时查看部门收支状况
3. **历史对比**: 支持不同时期的分润数据对比分析
4. **异常监控**: 自动识别异常的分润比例和利润率

---

## 附录

### A. 计算示例详解
详细的多服务、多部门分润计算案例和公式推导。

### B. 协议配置示例
```json
{
  "protocolName": "海运标准分润协议",
  "serviceCode": null,
  "salesRatio": 0.6000,
  "operationRatio": 0.4000,
  "priority": 1,
  "effectiveDate": "2025-01-01"
}
```

### C. 错误码定义
- MP001: 费用明细数据不完整
- MP002: 找不到适用的分润协议
- MP003: 分润比例配置错误
- MP004: 计算结果校验失败

---
*最后更新: 2025-09-15*  
*文档版本: v1.1*  
*项目: OneOrder管理账分润计算模块*  
*更新内容: 新增多服务合并处理逻辑，完善五项要素汇总机制，增强集团报表合并支撑*