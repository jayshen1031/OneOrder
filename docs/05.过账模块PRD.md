# OneOrderè¿‡è´¦æ¨¡å—äº§å“éœ€æ±‚æ–‡æ¡£(PRD)

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **ç‰ˆæœ¬**: v1.0  
- **åˆ›å»ºæ—¥æœŸ**: 2025-09-15
- **åˆ›å»ºè€…**: Claude Code Assistant
- **é¡¹ç›®**: OneOrderè´§ä»£è®¢å•ç®¡ç†ä¸è´¢åŠ¡æ¸…åˆ†ç³»ç»Ÿ
- **æ¨¡å—**: è¿‡è´¦å¤„ç†æ¨¡å—

## ğŸ¯ æ¨¡å—æ¦‚è¿°

### ä¸šåŠ¡èƒŒæ™¯
è¿‡è´¦æ¨¡å—æ˜¯OneOrderç³»ç»Ÿä¸­åœ¨å†…éƒ¨äº¤æ˜“åˆæ­¥æ¸…åˆ†å®ŒæˆåŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥é’ˆå¯¹ç‰¹æ®Šè¿‡è´¦è§„åˆ™è¿›è¡Œå¤„ç†çš„é«˜çº§æ¨¡å—ã€‚è¿‡è´¦å¯ä»¥ç†è§£ä¸ºä¸€ç§ç‰¹æ®Šçš„å€ŸæŠ¬å¤´è¡Œä¸ºï¼Œä½†å…¶äº¤æ˜“ä¸¤ç«¯å‡ä¸ºå†…éƒ¨æ³•äººä½“ï¼Œä¸»è¦ç”¨äºæ»¡è¶³ç‰¹å®šçš„èµ„é‡‘è·¯ç”±å’Œåˆè§„è¦æ±‚ã€‚

### æ ¸å¿ƒä»·å€¼
1. **èµ„é‡‘è·¯ç”±ç®¡æ§**: æŒ‰ç…§ç‰¹å®šè·¯å¾„è¿›è¡Œèµ„é‡‘æµè½¬ï¼Œæ»¡è¶³åˆè§„è¦æ±‚
2. **è¿‡è´¦è´¹ç”¨ç®¡ç†**: åˆç†æ”¶å–è¿‡è´¦æœåŠ¡è´¹ï¼Œä¼˜åŒ–èµ„é‡‘æˆæœ¬
3. **è½§å·®ç»“ç®—æ”¯æŒ**: å‡å°‘é‡å¤äº¤æ˜“ï¼Œæé«˜èµ„é‡‘æ•ˆç‡
4. **å·®å¼‚è´¦å•å¤„ç†**: æ”¯æŒæ¸…åˆ†ç»“æœçš„å¢é‡æ›´æ–°å’Œå˜æ›´ç®¡ç†

## ğŸ“Š æ ¸å¿ƒä¸šåŠ¡åŸåˆ™

### å¤„ç†åŸåˆ™
1. **åç½®å¤„ç†**: åœ¨èµ„é‡‘æµæ¸…åˆ†å®Œæˆåè¿›è¡Œè¿‡è´¦å¤„ç†
2. **æ³•äººä½“ç»´åº¦**: åªæ¶‰åŠæ³•äººå±æ€§ï¼Œä¸æ¶‰åŠéƒ¨é—¨å±æ€§
3. **è·¯ç”±è§„åˆ™é©±åŠ¨**: åŸºäºé…ç½®çš„è·¯ç”±è§„åˆ™è‡ªåŠ¨è°ƒæ•´èµ„é‡‘æµå‘
4. **è½§å·®å¯é€‰**: æ”¯æŒæ”¶ä»˜åˆ†å¼€å’Œè½§å·®ä¸¤ç§å¤„ç†æ¨¡å¼

### æ ¸å¿ƒè®¡ç®—å…¬å¼
```
è¿‡è´¦ç•™å­˜é‡‘é¢ = è¿‡è´¦é‡‘é¢ Ã— ç•™å­˜æ¯”ä¾‹ or å›ºå®šé‡‘é¢
å®é™…è½¬ä»˜é‡‘é¢ = æ”¶åˆ°é‡‘é¢ - è¿‡è´¦ç•™å­˜é‡‘é¢
è½§å·®åé‡‘é¢ = |æ³•äººAä»˜æ³•äººB - æ³•äººBä»˜æ³•äººA|
```

## ğŸ”§ è¯¦ç»†ä¸šåŠ¡æµç¨‹

### 1. è¿‡è´¦è§¦å‘æ¡ä»¶

#### 1.1 å‰ç½®æ¡ä»¶
- å†…éƒ¨äº¤æ˜“å·²å®Œæˆåˆæ­¥æ¸…åˆ†
- æ˜Ÿå¼ç»“ç®—ç»“æœå·²ç”Ÿæˆ
- å†…éƒ¨äº¤æ˜“æ˜ç»†è¡¨å·²ç”Ÿæˆæˆå¯¹äº¤æ˜“

#### 1.2 è¿‡è´¦å¤„ç†æ—¶æœº
- åœ¨æ˜Ÿå¼ç»“ç®—å®Œæˆåè‡ªåŠ¨è§¦å‘
- æ”¯æŒæ‰‹åŠ¨è§¦å‘è¿‡è´¦å¤„ç†
- å¯é…ç½®æ˜¯å¦å¯ç”¨è¿‡è´¦åŠŸèƒ½

### 2. èµ„é‡‘è·¯ç”±è§„åˆ™åˆ¤å®š

#### 2.1 è·¯ç”±è§„åˆ™ç»“æ„

**è§„åˆ™å­—æ®µå®šä¹‰**
| å­—æ®µåç§° | å­—æ®µè¯´æ˜ | æ•°æ®ç±»å‹ | å¿…å¡« | ç¤ºä¾‹ |
|---------|---------|----------|------|------|
| ä»˜æ¬¾æ³•äººå…¬å¸ | åŸå§‹ä»˜æ¬¾æ–¹æ³•äºº | ä¸‹æ‹‰é€‰æ‹© | æ˜¯ | Aå…¬å¸ |
| æ”¶æ¬¾æ³•äººå…¬å¸ | åŸå§‹æ”¶æ¬¾æ–¹æ³•äºº | ä¸‹æ‹‰é€‰æ‹© | æ˜¯ | Bå…¬å¸ |
| å¸ç§ | äº¤æ˜“å¸ç§ | ä¸‹æ‹‰é€‰æ‹© | æ˜¯ | USD |
| è·¯ç”±å…¬å¸1 | ç¬¬ä¸€ä¸ªè¿‡è´¦æ³•äºº | ä¸‹æ‹‰é€‰æ‹© | æ˜¯ | Cå…¬å¸ |
| è·¯ç”±å…¬å¸2 | ç¬¬äºŒä¸ªè¿‡è´¦æ³•äºº(å¯é€‰) | ä¸‹æ‹‰é€‰æ‹© | å¦ | Då…¬å¸ |

#### 2.2 è·¯ç”±è§„åˆ™åŒ¹é…

**åŒ¹é…é€»è¾‘**
```
IF (ä»˜æ¬¾æ³•äºº = Aå…¬å¸ AND æ”¶æ¬¾æ³•äºº = Bå…¬å¸ AND å¸ç§ = USD) 
THEN åº”ç”¨è·¯ç”±è§„åˆ™: A â†’ C â†’ D â†’ B
```

**é»˜è®¤ç›´æ¥æ”¶ä»˜**
- å¦‚æœæ²¡æœ‰åŒ¹é…çš„è·¯ç”±è§„åˆ™ï¼Œæ³•äººä½“ä¹‹é—´å¯ä»¥ç›´æ¥æ”¶ä»˜
- èµ„é‡‘è·¯å¾„å‘ˆç½‘çŠ¶ç»“æ„ï¼Œæ— éœ€è¿‡è´¦å¤„ç†

#### 2.3 è·¯ç”±è§„åˆ™ä¼˜å…ˆçº§

**åŒ¹é…ä¼˜å…ˆçº§**
1. ç²¾ç¡®åŒ¹é…ï¼šä»˜æ¬¾æ³•äºº+æ”¶æ¬¾æ³•äºº+å¸ç§å®Œå…¨åŒ¹é…
2. é€šé…ç¬¦åŒ¹é…ï¼šæ”¯æŒæ³•äººæˆ–å¸ç§çš„é€šé…ç¬¦è§„åˆ™
3. é»˜è®¤è§„åˆ™ï¼šæ— åŒ¹é…è§„åˆ™æ—¶çš„é»˜è®¤å¤„ç†æ–¹å¼

### 3. è¿‡è´¦å¤„ç†è¯¦ä¾‹

#### 3.1 å•è·¯ç”±å…¬å¸ç¤ºä¾‹

**ä¸šåŠ¡åœºæ™¯**
- åŸå§‹äº¤æ˜“ï¼šAå…¬å¸ä»˜Bå…¬å¸1000ç¾å…ƒ
- è·¯ç”±è§„åˆ™ï¼šAâ†’Bï¼ŒUSDï¼Œè·¯ç”±å…¬å¸C
- Cå…¬å¸è¿‡è´¦ç•™å­˜ï¼š1%

**è¿‡è´¦å¤„ç†**
```
æ­¥éª¤1: åŒ¹é…è·¯ç”±è§„åˆ™
Aä»˜B 1000ç¾å…ƒ â†’ åŒ¹é…è§„åˆ™(A,B,USD,C)

æ­¥éª¤2: è°ƒæ•´èµ„é‡‘æµå‘
åŸæµå‘: A â†’ B (1000ç¾å…ƒ)
æ–°æµå‘: A â†’ C â†’ B

æ­¥éª¤3: è®¡ç®—è¿‡è´¦ç•™å­˜
Cæ”¶A: 1000ç¾å…ƒ
Cç•™å­˜: 1000 Ã— 1% = 10ç¾å…ƒ  
Cä»˜B: 1000 - 10 = 990ç¾å…ƒ

æ­¥éª¤4: ç”Ÿæˆè¿‡è´¦äº¤æ˜“
Aä»˜C: 1000ç¾å…ƒ
Cæ”¶A: 1000ç¾å…ƒ
Cä»˜B: 990ç¾å…ƒ
Bæ”¶C: 990ç¾å…ƒ
```

#### 3.2 åŒè·¯ç”±å…¬å¸ç¤ºä¾‹

**ä¸šåŠ¡åœºæ™¯**  
- åŸå§‹äº¤æ˜“ï¼šAå…¬å¸ä»˜Bå…¬å¸1000ç¾å…ƒ
- è·¯ç”±è§„åˆ™ï¼šAâ†’Bï¼ŒUSDï¼Œè·¯ç”±å…¬å¸Cå’ŒD
- Cå…¬å¸è¿‡è´¦ç•™å­˜ï¼š1%ï¼ŒDå…¬å¸è¿‡è´¦ç•™å­˜ï¼š1%

**è¿‡è´¦å¤„ç†**
```
æ­¥éª¤1: åŒ¹é…è·¯ç”±è§„åˆ™
Aä»˜B 1000ç¾å…ƒ â†’ åŒ¹é…è§„åˆ™(A,B,USD,C,D)

æ­¥éª¤2: è°ƒæ•´èµ„é‡‘æµå‘  
åŸæµå‘: A â†’ B (1000ç¾å…ƒ)
æ–°æµå‘: A â†’ C â†’ D â†’ B

æ­¥éª¤3: è®¡ç®—è¿‡è´¦ç•™å­˜
Aä»˜C: 1000ç¾å…ƒ
Cæ”¶A: 1000ç¾å…ƒï¼Œç•™å­˜1% = 10ç¾å…ƒï¼Œä»˜D: 990ç¾å…ƒ
Dæ”¶C: 990ç¾å…ƒï¼Œç•™å­˜1% = 9.9ç¾å…ƒï¼Œä»˜B: 980.1ç¾å…ƒ
Bæ”¶D: 980.1ç¾å…ƒ

æ­¥éª¤4: ç”Ÿæˆè¿‡è´¦äº¤æ˜“åºåˆ—
Aä»˜C: 1000ç¾å…ƒ (Aæ”¶å…¥å‡å°‘1000)
Cæ”¶A: 1000ç¾å…ƒï¼ŒCä»˜D: 990ç¾å…ƒ (Cå‡€æ”¶å…¥10)
Dæ”¶C: 990ç¾å…ƒï¼ŒDä»˜B: 980.1ç¾å…ƒ (Då‡€æ”¶å…¥9.9)  
Bæ”¶D: 980.1ç¾å…ƒ (Bæ”¶å…¥980.1)
```

### 4. è¿‡è´¦ç•™å­˜è§„åˆ™

#### 4.1 ç•™å­˜è®¡ç®—æ¨¡å¼

**æ¯”ä¾‹ç•™å­˜æ¨¡å¼**
```
ç•™å­˜é‡‘é¢ = è¿‡è´¦é‡‘é¢ Ã— ç•™å­˜æ¯”ä¾‹
è½¬ä»˜é‡‘é¢ = è¿‡è´¦é‡‘é¢ - ç•™å­˜é‡‘é¢
```

**å›ºå®šé‡‘é¢ç•™å­˜æ¨¡å¼**
```
ç•™å­˜é‡‘é¢ = å›ºå®šé‡‘é¢
è½¬ä»˜é‡‘é¢ = è¿‡è´¦é‡‘é¢ - å›ºå®šé‡‘é¢
```

#### 4.2 ä¸šåŠ¡æ³•äººä½“è±å…è§„åˆ™

**è±å…æ¡ä»¶**
- å¦‚æœè¿‡è´¦å…¬å¸åœ¨ä¸šåŠ¡ä¸­ä½œä¸ºå®¢æœIDå¯¹åº”çš„æ³•äººå…¬å¸
- å¦‚æœè¿‡è´¦å…¬å¸åœ¨ä¸šåŠ¡ä¸­ä½œä¸ºæ“ä½œIDå¯¹åº”çš„æ³•äººå…¬å¸
- æ­£å¸¸ä¸šåŠ¡åˆ©æ¶¦ç•™å­˜å·²æ»¡è¶³ç¨åŠ¡è¦æ±‚

**è±å…å¤„ç†**
```
IF (è¿‡è´¦æ³•äºº = å®¢æœIDæ³•äºº OR è¿‡è´¦æ³•äºº = æ“ä½œIDæ³•äºº) 
THEN è¿‡è´¦ç•™å­˜ = 0
ELSE è¿‡è´¦ç•™å­˜ = æŒ‰é…ç½®è§„åˆ™è®¡ç®—
```

### 5. è½§å·®ç»“ç®—å¤„ç†

#### 5.1 é‡å¤è¿‡è´¦è¯†åˆ«

**é‡å¤è¿‡è´¦åœºæ™¯**
```
ä¸šåŠ¡åœºæ™¯: Aä»˜Bï¼ŒBä»˜C
è·¯ç”±è§„åˆ™: Aä»˜Bç»ç”±Dï¼ŒBä»˜Cç»ç”±D

å¤„ç†å‰:
Aä»˜B â†’ Aä»˜Dï¼ŒDä»˜B  
Bä»˜C â†’ Bä»˜Dï¼ŒDä»˜C

è¯†åˆ«ç»“æœ: å­˜åœ¨Dä»˜Bå’ŒBä»˜Dçš„é‡å¤äº¤æ˜“
```

#### 5.2 è½§å·®å¤„ç†è§„åˆ™é…ç½®

**è§„åˆ™å­—æ®µ**
| å­—æ®µåç§° | å­—æ®µè¯´æ˜ | æ•°æ®ç±»å‹ | å¿…å¡« | ç¤ºä¾‹ |
|---------|---------|----------|------|------|
| è¿‡è´¦æ³•äººä½“ | å‘ç”Ÿé‡å¤äº¤æ˜“çš„è¿‡è´¦æ³•äºº | ä¸‹æ‹‰é€‰æ‹© | æ˜¯ | Då…¬å¸ |
| å¯¹è±¡æ³•äººä½“ | ä¸è¿‡è´¦æ³•äººå‘ç”Ÿé‡å¤äº¤æ˜“çš„æ³•äºº | ä¸‹æ‹‰é€‰æ‹© | æ˜¯ | Bå…¬å¸ |
| å¤„ç†æ¨¡å¼ | è½§å·®æˆ–æ”¶ä»˜åˆ†å¼€ | å•é€‰ | æ˜¯ | è½§å·® |

#### 5.3 è½§å·®è®¡ç®—ç¤ºä¾‹

**æ”¶ä»˜åˆ†å¼€æ¨¡å¼**
```
Dä»˜B: 900å…ƒ
Bä»˜D: 800å…ƒ
å¤„ç†ç»“æœ: ä¿ç•™ä¸¤ç¬”äº¤æ˜“ï¼Œä¸è¿›è¡Œåˆå¹¶
```

**è½§å·®æ¨¡å¼**
```
Dä»˜B: 900å…ƒ  
Bä»˜D: 800å…ƒ
è½§å·®è®¡ç®—: 900 - 800 = 100å…ƒ
å¤„ç†ç»“æœ: Dä»˜B 100å…ƒ (å–æ¶ˆBä»˜D)
```

### 6. å·®å¼‚è´¦å•å¤„ç†

#### 6.1 å·®å¼‚åœºæ™¯è¯†åˆ«

**å·®å¼‚äº§ç”ŸåŸå› **
- å¤–éƒ¨æ”¶ä»˜è´¦å•å‘ç”Ÿå˜åŒ–
- åˆ†æ¶¦è§„åˆ™è¿›è¡Œäº†è°ƒæ•´
- è¿‡è´¦è§„åˆ™é…ç½®å‘ç”Ÿå˜æ›´
- å€ŸæŠ¬å¤´ç•™å­˜è§„åˆ™è°ƒæ•´

#### 6.2 å·®å¼‚è®¡ç®—é€»è¾‘

**å·®å¼‚è®¡ç®—å…¬å¼**
```
æ–°è´¦å• = åŸæœ‰è´¦å• + å·®å¼‚è´¦å•
å·®å¼‚è´¦å• = æ–°ç”Ÿæˆç»“æœ - åŸæœ‰ç»“æœ
```

**å·®å¼‚è´¦å•ç¤ºä¾‹**
```
åŸæœ‰ç»“æœ: Aä»˜B 1000å…ƒ
æ–°ç”Ÿæˆç»“æœ: Aä»˜B 1200å…ƒ  
å·®å¼‚è´¦å•: Aä»˜B 200å…ƒ

æœ€ç»ˆè´¦å• = åŸæœ‰è´¦å•(1000) + å·®å¼‚è´¦å•(200) = 1200å…ƒ
```

#### 6.3 å·®å¼‚å¤„ç†ç­–ç•¥

**å¢é‡æ›´æ–°æ¨¡å¼**
- åªç”Ÿæˆå˜åŒ–éƒ¨åˆ†çš„å·®å¼‚è´¦å•
- ä¿ç•™åŸæœ‰è´¦å•è®°å½•
- æ”¯æŒå·®å¼‚è´¦å•çš„è¿½æº¯å’Œå®¡è®¡

**å…¨é‡æ›¿æ¢æ¨¡å¼**
- å®Œå…¨æ›¿æ¢åŸæœ‰æ¸…åˆ†ç»“æœ
- é€‚ç”¨äºå¤§å¹…è°ƒæ•´çš„åœºæ™¯
- ä¿ç•™å†å²ç‰ˆæœ¬è®°å½•

## ğŸ¨ ç•Œé¢è®¾è®¡éœ€æ±‚

### 1. è¿‡è´¦å¤„ç†ä¸»ç•Œé¢

#### 1.1 ç•Œé¢å¸ƒå±€
```
+----------------------------------------------------------+
| OneOrder - è¿‡è´¦å¤„ç†                  [æ‰§è¡Œè¿‡è´¦] [å¯¼å‡º]    |
+----------------------------------------------------------+
| è®¢å•ä¿¡æ¯åŒºåŸŸ                                               |
| è®¢å•å·: HCBD20250915001  |  è¿‡è´¦çŠ¶æ€: å·²å®Œæˆ            |
| åŸå§‹äº¤æ˜“ç¬”æ•°: 6          |  è¿‡è´¦åäº¤æ˜“ç¬”æ•°: 12           |
+----------------------------------------------------------+
| è·¯ç”±è§„åˆ™åŒ¹é…ç»“æœ                              [å±•å¼€/æ”¶èµ·] |
| +------------------------------------------------------+ |
| | åŸå§‹äº¤æ˜“ | åŒ¹é…è§„åˆ™ | è·¯ç”±è·¯å¾„ | è¿‡è´¦è´¹ç”¨ | çŠ¶æ€    | |
| | Aâ†’B 1000 | è§„åˆ™001  | Aâ†’Câ†’Dâ†’B  | C:10,D:9.9| å·²å¤„ç† | |
| +------------------------------------------------------+ |
+----------------------------------------------------------+
| è¿‡è´¦äº¤æ˜“æ˜ç»†                                              |
| [åŸå§‹äº¤æ˜“] [è¿‡è´¦äº¤æ˜“] [è½§å·®ç»“æœ] åˆ‡æ¢æ ‡ç­¾                  |
| è¯¦ç»†äº¤æ˜“æ˜ç»†è¡¨                                            |
+----------------------------------------------------------+
```

#### 1.2 äº¤äº’è®¾è®¡
- **è·¯ç”±è§„åˆ™æŸ¥çœ‹**: ç‚¹å‡»åŒ¹é…è§„åˆ™å¯æŸ¥çœ‹å…·ä½“çš„è·¯ç”±è§„åˆ™é…ç½®
- **äº¤æ˜“æµç¨‹å›¾**: å¯è§†åŒ–å±•ç¤ºè¿‡è´¦å‰åçš„èµ„é‡‘æµå‘å˜åŒ–
- **å·®å¼‚å¯¹æ¯”**: æ”¯æŒæŸ¥çœ‹è¿‡è´¦å‰åçš„äº¤æ˜“å·®å¼‚
- **è½§å·®åˆ†æ**: å±•ç¤ºè½§å·®å¤„ç†çš„è¯¦ç»†è®¡ç®—è¿‡ç¨‹

### 2. è·¯ç”±è§„åˆ™é…ç½®ç•Œé¢

#### 2.1 è§„åˆ™é…ç½®è¡¨
```
+--------------------------------------------------------+
| è·¯ç”±è§„åˆ™é…ç½®                           [+ æ·»åŠ è§„åˆ™]    |
+--------------------------------------------------------+
| è§„åˆ™ID | ä»˜æ¬¾æ³•äºº | æ”¶æ¬¾æ³•äºº | å¸ç§ | è·¯ç”±å…¬å¸1 | è·¯ç”±å…¬å¸2 | çŠ¶æ€ |
|--------|----------|----------|------|-----------|-----------|------|
| R001   | Aå…¬å¸    | Bå…¬å¸    | USD  | Cå…¬å¸     | Då…¬å¸     | å¯ç”¨ |
| R002   | Aå…¬å¸    | *        | CNY  | Eå…¬å¸     | -         | å¯ç”¨ |
| R003   | *        | Bå…¬å¸    | EUR  | Få…¬å¸     | Gå…¬å¸     | ç¦ç”¨ |
+--------------------------------------------------------+
```

#### 2.2 è§„åˆ™ç¼–è¾‘å¼¹çª—
```
+--------------------------------------------+
| ç¼–è¾‘è·¯ç”±è§„åˆ™                    [Ã—]        |
+--------------------------------------------+
| è§„åˆ™åç§°: [_____________________]          |
| ä»˜æ¬¾æ³•äºº: [ä¸‹æ‹‰é€‰æ‹©: Aå…¬å¸]                |
| æ”¶æ¬¾æ³•äºº: [ä¸‹æ‹‰é€‰æ‹©: Bå…¬å¸]                |
| å¸ç§:     [ä¸‹æ‹‰é€‰æ‹©: USD]                  |
+--------------------------------------------+
| è·¯ç”±é…ç½®                                   |
| è·¯ç”±å…¬å¸1: [ä¸‹æ‹‰é€‰æ‹©: Cå…¬å¸] [å¿…å¡«]        |
| è¿‡è´¦ç•™å­˜: [â—‹æ¯”ä¾‹] [â—‹å›ºå®š] å€¼:[____]        |
| è·¯ç”±å…¬å¸2: [ä¸‹æ‹‰é€‰æ‹©: Då…¬å¸] [å¯é€‰]        |
| è¿‡è´¦ç•™å­˜: [â—‹æ¯”ä¾‹] [â—‹å›ºå®š] å€¼:[____]        |
+--------------------------------------------+
| è§„åˆ™ä¼˜å…ˆçº§: [____] ç”Ÿæ•ˆæ—¥æœŸ: [____]        |
|                    [å–æ¶ˆ] [ä¿å­˜]          |
+--------------------------------------------+
```

### 3. è¿‡è´¦äº¤æ˜“æµç¨‹å›¾

#### 3.1 æµç¨‹å¯è§†åŒ–
```
+--------------------------------------------------------+
| è¿‡è´¦å¤„ç†æµç¨‹å›¾                                          |
+--------------------------------------------------------+
| åŸå§‹äº¤æ˜“:                                               |
| Aå…¬å¸ ----1000ç¾å…ƒ----> Bå…¬å¸                          |
+--------------------------------------------------------+
| è¿‡è´¦åäº¤æ˜“:                                             |
| Aå…¬å¸ ----1000ç¾å…ƒ----> Cå…¬å¸ ----990ç¾å…ƒ----> Då…¬å¸    |
|                         (ç•™å­˜10)      ----980.1ç¾å…ƒ--> Bå…¬å¸ |
|                                       (ç•™å­˜9.9)        |
+--------------------------------------------------------+
| è¿‡è´¦æ±‡æ€»:                                               |
| â€¢ Aå…¬å¸æ”¯å‡º: 1000ç¾å…ƒ                                   |
| â€¢ Bå…¬å¸æ”¶å…¥: 980.1ç¾å…ƒ                                  |
| â€¢ Cå…¬å¸ç•™å­˜: 10ç¾å…ƒ                                     |
| â€¢ Då…¬å¸ç•™å­˜: 9.9ç¾å…ƒ                                    |
| â€¢ æ€»è¿‡è´¦è´¹ç”¨: 19.9ç¾å…ƒ                                  |
+--------------------------------------------------------+
```

### 4. è½§å·®å¤„ç†ç•Œé¢

#### 4.1 è½§å·®å‰åå¯¹æ¯”
```
+--------------------------------------------------------+
| è½§å·®å¤„ç†åˆ†æ                                            |
+--------------------------------------------------------+
| è½§å·®å‰äº¤æ˜“:                                             |
| Då…¬å¸ â†’ Bå…¬å¸: 900.00å…ƒ                                |
| Bå…¬å¸ â†’ Då…¬å¸: 800.00å…ƒ                                |
+--------------------------------------------------------+
| è½§å·®è®¡ç®—:                                               |
| è½§å·®é‡‘é¢ = |900.00 - 800.00| = 100.00å…ƒ               |
| è½§å·®æ–¹å‘ = Då…¬å¸ â†’ Bå…¬å¸                               |
+--------------------------------------------------------+
| è½§å·®åäº¤æ˜“:                                             |
| Då…¬å¸ â†’ Bå…¬å¸: 100.00å…ƒ                                |
| (å·²å–æ¶ˆ: Bå…¬å¸ â†’ Då…¬å¸: 800.00å…ƒ)                      |
+--------------------------------------------------------+
| è½§å·®æ•ˆæœ:                                               |
| â€¢ å‡å°‘äº¤æ˜“ç¬”æ•°: 2ç¬” â†’ 1ç¬”                              |
| â€¢ å‡å°‘èµ„é‡‘å‘¨è½¬: 1600.00å…ƒ â†’ 100.00å…ƒ                   |
| â€¢ æå‡æ•ˆç‡: 93.75%                                     |
+--------------------------------------------------------+
```

## ğŸ”’ æ•°æ®æ¨¡å‹è®¾è®¡

### 1. èµ„é‡‘è·¯ç”±è§„åˆ™è¡¨
```sql
CREATE TABLE fund_routing_rules (
    id BIGSERIAL PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL,        -- è§„åˆ™åç§°
    payer_entity_id VARCHAR(50) NOT NULL,   -- ä»˜æ¬¾æ³•äººå…¬å¸
    payee_entity_id VARCHAR(50) NOT NULL,   -- æ”¶æ¬¾æ³•äººå…¬å¸
    currency VARCHAR(10) NOT NULL,          -- å¸ç§
    routing_entity_1_id VARCHAR(50) NOT NULL, -- è·¯ç”±å…¬å¸1
    routing_entity_2_id VARCHAR(50),        -- è·¯ç”±å…¬å¸2(å¯é€‰)
    priority INTEGER DEFAULT 1,             -- ä¼˜å…ˆçº§
    effective_date DATE NOT NULL,           -- ç”Ÿæ•ˆæ—¥æœŸ
    expiry_date DATE,                       -- å¤±æ•ˆæ—¥æœŸ
    status VARCHAR(20) DEFAULT 'ACTIVE',    -- çŠ¶æ€: ACTIVE/INACTIVE
    created_by VARCHAR(50) NOT NULL,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(50),
    updated_time TIMESTAMP,
    
    INDEX idx_routing_match (payer_entity_id, payee_entity_id, currency),
    INDEX idx_priority_effective (priority DESC, effective_date DESC),
    INDEX idx_routing_entities (routing_entity_1_id, routing_entity_2_id)
);
```

### 2. è¿‡è´¦ç•™å­˜è§„åˆ™è¡¨
```sql
CREATE TABLE routing_retention_rules (
    id BIGSERIAL PRIMARY KEY,
    routing_entity_id VARCHAR(50) NOT NULL, -- è¿‡è´¦æ³•äººID
    retention_type VARCHAR(20) NOT NULL,    -- ç•™å­˜ç±»å‹: PERCENTAGE/FIXED
    retention_value DECIMAL(15,4) NOT NULL, -- ç•™å­˜å€¼(æ¯”ä¾‹æˆ–å›ºå®šé‡‘é¢)
    min_amount DECIMAL(15,2),               -- æœ€å°è¿‡è´¦é‡‘é¢
    max_amount DECIMAL(15,2),               -- æœ€å¤§è¿‡è´¦é‡‘é¢
    currency VARCHAR(10),                   -- é€‚ç”¨å¸ç§(NULLè¡¨ç¤ºå…¨éƒ¨)
    business_exemption BOOLEAN DEFAULT FALSE, -- ä¸šåŠ¡æ³•äººè±å…
    effective_date DATE NOT NULL,           -- ç”Ÿæ•ˆæ—¥æœŸ
    expiry_date DATE,                       -- å¤±æ•ˆæ—¥æœŸ
    status VARCHAR(20) DEFAULT 'ACTIVE',    -- çŠ¶æ€: ACTIVE/INACTIVE
    created_by VARCHAR(50) NOT NULL,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_routing_entity (routing_entity_id),
    INDEX idx_effective_date (effective_date)
);
```

### 3. è½§å·®å¤„ç†è§„åˆ™è¡¨
```sql
CREATE TABLE netting_processing_rules (
    id BIGSERIAL PRIMARY KEY,
    routing_entity_id VARCHAR(50) NOT NULL, -- è¿‡è´¦æ³•äººä½“
    counterpart_entity_id VARCHAR(50) NOT NULL, -- å¯¹è±¡æ³•äººä½“
    processing_mode VARCHAR(20) NOT NULL,   -- å¤„ç†æ¨¡å¼: NETTING/SEPARATE
    min_netting_amount DECIMAL(15,2),       -- æœ€å°è½§å·®é‡‘é¢
    currency VARCHAR(10),                   -- é€‚ç”¨å¸ç§
    effective_date DATE NOT NULL,           -- ç”Ÿæ•ˆæ—¥æœŸ
    expiry_date DATE,                       -- å¤±æ•ˆæ—¥æœŸ
    status VARCHAR(20) DEFAULT 'ACTIVE',    -- çŠ¶æ€: ACTIVE/INACTIVE
    created_by VARCHAR(50) NOT NULL,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE (routing_entity_id, counterpart_entity_id, currency),
    INDEX idx_entity_pair (routing_entity_id, counterpart_entity_id)
);
```

### 4. è¿‡è´¦å¤„ç†ç»“æœè¡¨
```sql
CREATE TABLE routing_processing_results (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    original_transaction_id BIGINT NOT NULL, -- åŸå§‹å†…éƒ¨äº¤æ˜“ID
    routing_rule_id BIGINT,                 -- åº”ç”¨çš„è·¯ç”±è§„åˆ™ID
    routing_path VARCHAR(500) NOT NULL,     -- è·¯ç”±è·¯å¾„(å¦‚: Aâ†’Câ†’Dâ†’B)
    original_amount DECIMAL(15,2) NOT NULL, -- åŸå§‹äº¤æ˜“é‡‘é¢
    total_routing_fee DECIMAL(15,2) DEFAULT 0, -- æ€»è¿‡è´¦è´¹ç”¨
    final_received_amount DECIMAL(15,2) NOT NULL, -- æœ€ç»ˆåˆ°è´¦é‡‘é¢
    routing_entity_count INTEGER DEFAULT 0,  -- è¿‡è´¦æ³•äººæ•°é‡
    generated_transaction_count INTEGER DEFAULT 0, -- ç”Ÿæˆäº¤æ˜“ç¬”æ•°
    processing_status VARCHAR(20) DEFAULT 'COMPLETED', -- å¤„ç†çŠ¶æ€
    processing_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (original_transaction_id) REFERENCES internal_transactions(id),
    FOREIGN KEY (routing_rule_id) REFERENCES fund_routing_rules(id),
    INDEX idx_order_routing (order_id),
    INDEX idx_original_transaction (original_transaction_id)
);
```

### 5. è¿‡è´¦äº¤æ˜“æ˜ç»†è¡¨
```sql
CREATE TABLE routing_transaction_details (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    routing_result_id BIGINT NOT NULL,      -- è¿‡è´¦å¤„ç†ç»“æœID
    transaction_pair_id VARCHAR(50) NOT NULL, -- äº¤æ˜“å¯¹ID
    sequence_number INTEGER NOT NULL,        -- åœ¨è·¯ç”±ä¸­çš„åºå·
    routing_entity_id VARCHAR(50),          -- è¿‡è´¦æ³•äººID(å¦‚æœæ˜¯è¿‡è´¦äº¤æ˜“)
    our_entity_id VARCHAR(50) NOT NULL,     -- æˆ‘æ–¹æ³•äººID
    counterpart_entity_id VARCHAR(50) NOT NULL, -- å¯¹æ–¹æ³•äººID
    transaction_type VARCHAR(10) NOT NULL,  -- äº¤æ˜“ç±»å‹: RECEIVABLE/PAYABLE
    amount DECIMAL(15,2) NOT NULL,          -- äº¤æ˜“é‡‘é¢
    retention_amount DECIMAL(15,2) DEFAULT 0, -- è¿‡è´¦ç•™å­˜é‡‘é¢
    currency VARCHAR(10) DEFAULT 'CNY',     -- å¸ç§
    fee_code VARCHAR(50) DEFAULT 'INTERNAL_FREIGHT', -- è´¹ç”¨ç§‘ç›®
    transaction_category VARCHAR(20) DEFAULT 'ROUTING', -- äº¤æ˜“ç±»åˆ«: ROUTING/ORIGINAL
    generated_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (routing_result_id) REFERENCES routing_processing_results(id),
    INDEX idx_order_routing_result (order_id, routing_result_id),
    INDEX idx_transaction_pair (transaction_pair_id),
    INDEX idx_routing_entity (routing_entity_id)
);
```

### 6. è½§å·®å¤„ç†ç»“æœè¡¨
```sql
CREATE TABLE netting_processing_results (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    entity_a_id VARCHAR(50) NOT NULL,       -- æ³•äººA
    entity_b_id VARCHAR(50) NOT NULL,       -- æ³•äººB
    amount_a_to_b DECIMAL(15,2) DEFAULT 0,  -- Aä»˜Bé‡‘é¢
    amount_b_to_a DECIMAL(15,2) DEFAULT 0,  -- Bä»˜Aé‡‘é¢
    netting_amount DECIMAL(15,2) NOT NULL,  -- è½§å·®é‡‘é¢
    netting_direction VARCHAR(10) NOT NULL, -- è½§å·®æ–¹å‘: A_TO_B/B_TO_A
    processing_mode VARCHAR(20) NOT NULL,   -- å¤„ç†æ¨¡å¼: NETTING/SEPARATE
    original_transaction_count INTEGER DEFAULT 0, -- åŸå§‹äº¤æ˜“ç¬”æ•°
    final_transaction_count INTEGER DEFAULT 0,    -- æœ€ç»ˆäº¤æ˜“ç¬”æ•°
    efficiency_improvement DECIMAL(5,4),    -- æ•ˆç‡æå‡æ¯”ä¾‹
    processing_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    INDEX idx_order_netting (order_id),
    INDEX idx_entity_pair (entity_a_id, entity_b_id)
);
```

### 7. å·®å¼‚è´¦å•è¡¨
```sql
CREATE TABLE clearing_difference_bills (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    original_version INTEGER NOT NULL,      -- åŸå§‹ç‰ˆæœ¬å·
    new_version INTEGER NOT NULL,           -- æ–°ç‰ˆæœ¬å·
    entity_id VARCHAR(50) NOT NULL,         -- æ³•äººID
    counterpart_entity_id VARCHAR(50) NOT NULL, -- å¯¹æ–¹æ³•äººID
    transaction_type VARCHAR(10) NOT NULL,  -- äº¤æ˜“ç±»å‹: RECEIVABLE/PAYABLE
    original_amount DECIMAL(15,2) DEFAULT 0, -- åŸå§‹é‡‘é¢
    new_amount DECIMAL(15,2) DEFAULT 0,     -- æ–°é‡‘é¢
    difference_amount DECIMAL(15,2) NOT NULL, -- å·®å¼‚é‡‘é¢
    difference_type VARCHAR(20) NOT NULL,   -- å·®å¼‚ç±»å‹: INCREASE/DECREASE/NEW/CANCEL
    change_reason VARCHAR(200),             -- å˜æ›´åŸå› 
    generated_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    INDEX idx_order_version (order_id, new_version),
    INDEX idx_difference_type (difference_type),
    INDEX idx_entity_pair (entity_id, counterpart_entity_id)
);
```

## ğŸ”§ APIæ¥å£è®¾è®¡

### 1. è¿‡è´¦å¤„ç†API

#### 1.1 æ‰§è¡Œè¿‡è´¦å¤„ç†
```http
POST /api/routing/process
Content-Type: application/json

{
    "orderId": "HCBD20250915001",
    "enableRouting": true,
    "enableNetting": true,
    "forceReprocess": false
}

Response:
{
    "code": 200,
    "message": "è¿‡è´¦å¤„ç†å®Œæˆ",
    "data": {
        "orderId": "HCBD20250915001",
        "processingTime": "2025-09-15T10:30:00",
        "originalTransactionCount": 6,
        "routingTransactionCount": 12,
        "nettingTransactionCount": 8,
        "totalRoutingFee": 19.90,
        "efficiencyImprovement": 0.3333
    }
}
```

#### 1.2 æŸ¥è¯¢è¿‡è´¦ç»“æœ
```http
GET /api/routing/results/{orderId}

Response:
{
    "code": 200,
    "data": {
        "orderInfo": {
            "orderId": "HCBD20250915001",
            "processingStatus": "COMPLETED",
            "processingTime": "2025-09-15T10:30:00"
        },
        "routingResults": [
            {
                "originalTransactionId": 123,
                "routingRuleId": 1,
                "routingPath": "Aâ†’Câ†’Dâ†’B",
                "originalAmount": 1000.00,
                "totalRoutingFee": 19.90,
                "finalReceivedAmount": 980.10
            }
        ],
        "nettingResults": [
            {
                "entityAId": "ENTITY_D",
                "entityBId": "ENTITY_B", 
                "amountAToB": 900.00,
                "amountBToA": 800.00,
                "nettingAmount": 100.00,
                "nettingDirection": "A_TO_B"
            }
        ],
        "finalTransactions": [
            {
                "ourEntityId": "ENTITY_A",
                "counterpartEntityId": "ENTITY_C",
                "transactionType": "PAYABLE",
                "amount": 1000.00,
                "transactionCategory": "ROUTING"
            }
        ]
    }
}
```

### 2. è·¯ç”±è§„åˆ™ç®¡ç†API

#### 2.1 æŸ¥è¯¢åŒ¹é…çš„è·¯ç”±è§„åˆ™
```http
GET /api/routing/rules/match
?payerEntityId=ENTITY_A
&payeeEntityId=ENTITY_B
&currency=USD

Response:
{
    "code": 200,
    "data": {
        "ruleId": 1,
        "ruleName": "A-Bç¾å…ƒè·¯ç”±è§„åˆ™",
        "payerEntityId": "ENTITY_A",
        "payeeEntityId": "ENTITY_B", 
        "currency": "USD",
        "routingEntity1Id": "ENTITY_C",
        "routingEntity2Id": "ENTITY_D",
        "priority": 10
    }
}
```

#### 2.2 åˆ›å»ºè·¯ç”±è§„åˆ™
```http
POST /api/routing/rules
Content-Type: application/json

{
    "ruleName": "A-Bç¾å…ƒè·¯ç”±è§„åˆ™",
    "payerEntityId": "ENTITY_A",
    "payeeEntityId": "ENTITY_B",
    "currency": "USD", 
    "routingEntity1Id": "ENTITY_C",
    "routingEntity2Id": "ENTITY_D",
    "priority": 10,
    "effectiveDate": "2025-01-01"
}

Response:
{
    "code": 200,
    "message": "è·¯ç”±è§„åˆ™åˆ›å»ºæˆåŠŸ",
    "data": {
        "ruleId": 1,
        "status": "ACTIVE"
    }
}
```

### 3. å·®å¼‚è´¦å•API

#### 3.1 ç”Ÿæˆå·®å¼‚è´¦å•
```http
POST /api/routing/difference-bills/generate
Content-Type: application/json

{
    "orderId": "HCBD20250915001",
    "originalVersion": 1,
    "newVersion": 2,
    "changeReason": "åˆ†æ¶¦è§„åˆ™è°ƒæ•´"
}

Response:
{
    "code": 200,
    "message": "å·®å¼‚è´¦å•ç”Ÿæˆå®Œæˆ",
    "data": {
        "orderId": "HCBD20250915001",
        "differenceCount": 3,
        "totalDifferenceAmount": 150.00,
        "majorChanges": [
            {
                "entityId": "ENTITY_A",
                "transactionType": "PAYABLE",
                "differenceAmount": 100.00,
                "differenceType": "INCREASE"
            }
        ]
    }
}
```

## ğŸš€ ä¸šåŠ¡è§„åˆ™å¼•æ“

### 1. è·¯ç”±è§„åˆ™åŒ¹é…å¼•æ“

```java
public class RoutingRuleEngine {
    
    // è§„åˆ™1: æŸ¥æ‰¾åŒ¹é…çš„è·¯ç”±è§„åˆ™
    public Optional<FundRoutingRule> findMatchingRule(
            String payerEntityId,
            String payeeEntityId, 
            String currency) {
        
        List<FundRoutingRule> candidates = routingRuleRepository
            .findActiveRulesByDate(LocalDate.now());
            
        return candidates.stream()
            .filter(rule -> matchesExactly(rule, payerEntityId, payeeEntityId, currency))
            .max(Comparator.comparing(FundRoutingRule::getPriority));
    }
    
    // è§„åˆ™2: ç”Ÿæˆè·¯ç”±äº¤æ˜“è·¯å¾„
    public List<RoutingTransactionDetail> generateRoutingPath(
            FundRoutingRule rule,
            BigDecimal originalAmount,
            String currency) {
        
        List<RoutingTransactionDetail> transactions = new ArrayList<>();
        String transactionPairId = generateTransactionPairId();
        
        // ç¬¬ä¸€æ®µ: åŸä»˜æ¬¾æ–¹ â†’ è·¯ç”±å…¬å¸1
        BigDecimal currentAmount = originalAmount;
        transactions.addAll(createTransactionPair(
            rule.getPayerEntityId(), 
            rule.getRoutingEntity1Id(),
            currentAmount, transactionPairId + "_1"));
        
        // è®¡ç®—è·¯ç”±å…¬å¸1ç•™å­˜
        BigDecimal retention1 = calculateRoutingRetention(
            rule.getRoutingEntity1Id(), currentAmount);
        currentAmount = currentAmount.subtract(retention1);
        
        // ç¬¬äºŒæ®µ: è·¯ç”±å…¬å¸1 â†’ è·¯ç”±å…¬å¸2(å¦‚æœå­˜åœ¨)
        if (rule.getRoutingEntity2Id() != null) {
            transactions.addAll(createTransactionPair(
                rule.getRoutingEntity1Id(),
                rule.getRoutingEntity2Id(), 
                currentAmount, transactionPairId + "_2"));
                
            BigDecimal retention2 = calculateRoutingRetention(
                rule.getRoutingEntity2Id(), currentAmount);
            currentAmount = currentAmount.subtract(retention2);
        }
        
        // æœ€åä¸€æ®µ: æœ€åè·¯ç”±å…¬å¸ â†’ åŸæ”¶æ¬¾æ–¹
        String finalRoutingEntity = rule.getRoutingEntity2Id() != null ? 
            rule.getRoutingEntity2Id() : rule.getRoutingEntity1Id();
        transactions.addAll(createTransactionPair(
            finalRoutingEntity,
            rule.getPayeeEntityId(),
            currentAmount, transactionPairId + "_final"));
            
        return transactions;
    }
}
```

### 2. è½§å·®å¤„ç†å¼•æ“

```java
public class NettingEngine {
    
    // è¯†åˆ«é‡å¤äº¤æ˜“
    public List<NettingCandidate> identifyNettingCandidates(List<RoutingTransactionDetail> transactions) {
        
        Map<String, List<RoutingTransactionDetail>> entityPairMap = transactions.stream()
            .collect(Collectors.groupingBy(this::generateEntityPairKey));
            
        return entityPairMap.entrySet().stream()
            .filter(entry -> entry.getValue().size() >= 2)
            .map(this::createNettingCandidate)
            .collect(Collectors.toList());
    }
    
    // æ‰§è¡Œè½§å·®å¤„ç†
    public NettingProcessingResult processNetting(
            NettingCandidate candidate,
            NettingProcessingRule rule) {
        
        BigDecimal amountAToB = calculateDirectionalAmount(candidate, Direction.A_TO_B);
        BigDecimal amountBToA = calculateDirectionalAmount(candidate, Direction.B_TO_A);
        
        if (ProcessingMode.NETTING.equals(rule.getProcessingMode())) {
            // è½§å·®æ¨¡å¼
            BigDecimal nettingAmount = amountAToB.subtract(amountBToA).abs();
            Direction nettingDirection = amountAToB.compareTo(amountBToA) >= 0 ? 
                Direction.A_TO_B : Direction.B_TO_A;
                
            return NettingProcessingResult.builder()
                .entityAId(candidate.getEntityAId())
                .entityBId(candidate.getEntityBId())
                .amountAToB(amountAToB)
                .amountBToA(amountBToA)
                .nettingAmount(nettingAmount)
                .nettingDirection(nettingDirection)
                .processingMode(ProcessingMode.NETTING)
                .build();
        } else {
            // æ”¶ä»˜åˆ†å¼€æ¨¡å¼
            return NettingProcessingResult.builder()
                .entityAId(candidate.getEntityAId())
                .entityBId(candidate.getEntityBId())
                .amountAToB(amountAToB)
                .amountBToA(amountBToA)
                .processingMode(ProcessingMode.SEPARATE)
                .build();
        }
    }
}
```

### 3. å·®å¼‚è´¦å•ç”Ÿæˆå¼•æ“

```java
public class DifferenceBillEngine {
    
    // ç”Ÿæˆå·®å¼‚è´¦å•
    public List<ClearingDifferenceBill> generateDifferenceBills(
            String orderId,
            List<InternalTransaction> originalTransactions,
            List<RoutingTransactionDetail> newTransactions) {
        
        List<ClearingDifferenceBill> differenceBills = new ArrayList<>();
        
        // æ„å»ºåŸå§‹äº¤æ˜“Map
        Map<String, BigDecimal> originalAmountMap = buildTransactionAmountMap(originalTransactions);
        
        // æ„å»ºæ–°äº¤æ˜“Map  
        Map<String, BigDecimal> newAmountMap = buildTransactionAmountMap(newTransactions);
        
        // è®¡ç®—å·®å¼‚
        Set<String> allKeys = new HashSet<>();
        allKeys.addAll(originalAmountMap.keySet());
        allKeys.addAll(newAmountMap.keySet());
        
        for (String key : allKeys) {
            BigDecimal originalAmount = originalAmountMap.getOrDefault(key, BigDecimal.ZERO);
            BigDecimal newAmount = newAmountMap.getOrDefault(key, BigDecimal.ZERO);
            BigDecimal difference = newAmount.subtract(originalAmount);
            
            if (difference.compareTo(BigDecimal.ZERO) != 0) {
                differenceBills.add(createDifferenceBill(
                    orderId, key, originalAmount, newAmount, difference));
            }
        }
        
        return differenceBills;
    }
    
    private String buildTransactionKey(String entityId, String counterpartId, String type) {
        return entityId + "_" + counterpartId + "_" + type;
    }
    
    private ClearingDifferenceBill createDifferenceBill(
            String orderId, 
            String transactionKey,
            BigDecimal originalAmount,
            BigDecimal newAmount, 
            BigDecimal difference) {
        
        String[] keyParts = transactionKey.split("_");
        DifferenceType diffType = determineDifferenceType(originalAmount, newAmount);
        
        return ClearingDifferenceBill.builder()
            .orderId(orderId)
            .entityId(keyParts[0])
            .counterpartEntityId(keyParts[1])
            .transactionType(keyParts[2])
            .originalAmount(originalAmount)
            .newAmount(newAmount)
            .differenceAmount(difference)
            .differenceType(diffType)
            .build();
    }
}
```

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- âœ… è·¯ç”±è§„åˆ™åŒ¹é…å‡†ç¡®ï¼Œæ”¯æŒç²¾ç¡®åŒ¹é…å’Œé€šé…ç¬¦åŒ¹é…
- âœ… è¿‡è´¦è·¯å¾„ç”Ÿæˆæ­£ç¡®ï¼Œæ”¯æŒå•è·¯ç”±å’ŒåŒè·¯ç”±å…¬å¸
- âœ… è¿‡è´¦ç•™å­˜è®¡ç®—å‡†ç¡®ï¼Œæ”¯æŒæ¯”ä¾‹ç•™å­˜å’Œå›ºå®šç•™å­˜
- âœ… ä¸šåŠ¡æ³•äººä½“è±å…è§„åˆ™æ­£ç¡®æ‰§è¡Œ
- âœ… è½§å·®å¤„ç†åŠŸèƒ½æ­£å¸¸ï¼Œæ”¯æŒè½§å·®å’Œæ”¶ä»˜åˆ†å¼€ä¸¤ç§æ¨¡å¼
- âœ… å·®å¼‚è´¦å•ç”Ÿæˆå‡†ç¡®ï¼Œæ”¯æŒå¢é‡æ›´æ–°æ¨¡å¼
- âœ… è¿‡è´¦äº¤æ˜“æˆå¯¹ç”Ÿæˆï¼Œåªå¸¦æ³•äººå±æ€§

### æ•°æ®å‡†ç¡®æ€§éªŒæ”¶
- âœ… è¿‡è´¦å‰åèµ„é‡‘æ€»é¢å¹³è¡¡
- âœ… è·¯ç”±è¿‡è´¦è´¹ç”¨è®¡ç®—å‡†ç¡®
- âœ… è½§å·®è®¡ç®—ç»“æœæ­£ç¡®
- âœ… å·®å¼‚è´¦å•é‡‘é¢å‡†ç¡®
- âœ… äº¤æ˜“è·¯å¾„å®Œæ•´æ— é—æ¼

### æ€§èƒ½éªŒæ”¶
- âœ… å•è®¢å•è¿‡è´¦å¤„ç†æ—¶é—´ < 8ç§’
- âœ… æ”¯æŒ50+è·¯ç”±è§„åˆ™çš„å¤æ‚åŒ¹é…
- âœ… è½§å·®å¤„ç†å“åº”æ—¶é—´ < 3ç§’
- âœ… å·®å¼‚è´¦å•ç”Ÿæˆæ—¶é—´ < 5ç§’

## ğŸŠ ä¸šåŠ¡ä»·å€¼

### åˆè§„é£é™©æ§åˆ¶
1. **èµ„é‡‘è·¯ç”±ç®¡æ§**: æŒ‰ç…§åˆè§„è¦æ±‚è¿›è¡Œç‰¹å®šè·¯å¾„çš„èµ„é‡‘æµè½¬
2. **è¿‡è´¦è´¹ç”¨é€æ˜**: æ¸…æ™°è®°å½•è¿‡è´¦ç¯èŠ‚çš„è´¹ç”¨æˆæœ¬
3. **å®¡è®¡è½¨è¿¹å®Œæ•´**: å®Œæ•´çš„è¿‡è´¦å¤„ç†å’Œå·®å¼‚å˜æ›´è®°å½•
4. **åˆè§„æŠ¥å‘Šæ”¯æŒ**: ä¸ºç›‘ç®¡æŠ¥å‘Šæä¾›è¯¦ç»†çš„èµ„é‡‘æµå‘æ•°æ®

### èµ„é‡‘æ•ˆç‡ä¼˜åŒ–
1. **è½§å·®ç»“ç®—**: å‡å°‘é‡å¤äº¤æ˜“ï¼Œé™ä½èµ„é‡‘å‘¨è½¬æˆæœ¬
2. **è·¯å¾„ä¼˜åŒ–**: é€šè¿‡åˆç†çš„è·¯ç”±è®¾è®¡é™ä½æ•´ä½“è¿‡è´¦æˆæœ¬
3. **é›†ä¸­ç®¡ç†**: ç»Ÿä¸€çš„è¿‡è´¦è§„åˆ™ç®¡ç†å’Œæ‰§è¡Œ
4. **å·®å¼‚ç®¡æ§**: ç²¾ç¡®çš„å·®å¼‚è¯†åˆ«å’Œå¤„ç†æœºåˆ¶

### ç³»ç»Ÿé›†æˆæ”¯æŒ
1. **æ¸…åˆ†æµç¨‹å®Œæ•´**: å®Œæˆä»å½•è´¹åˆ°æœ€ç»ˆæ¸…åˆ†çš„å®Œæ•´é—­ç¯
2. **ç‰ˆæœ¬ç®¡ç†**: æ”¯æŒæ¸…åˆ†ç»“æœçš„ç‰ˆæœ¬æ§åˆ¶å’Œå†å²è¿½æº¯
3. **å¢é‡æ›´æ–°**: é«˜æ•ˆçš„å·®å¼‚è´¦å•å¤„ç†æœºåˆ¶
4. **æ•°æ®ä¸€è‡´æ€§**: ç¡®ä¿è¿‡è´¦å¤„ç†åçš„æ•°æ®å®Œæ•´æ€§å’Œå‡†ç¡®æ€§

---

## é™„å½•

### A. è·¯ç”±è§„åˆ™é…ç½®ç¤ºä¾‹
```json
{
  "ruleName": "A-Bç¾å…ƒè¿‡è´¦è§„åˆ™",
  "payerEntityId": "ENTITY_A",
  "payeeEntityId": "ENTITY_B",
  "currency": "USD",
  "routingEntity1Id": "ENTITY_C",
  "routingEntity2Id": "ENTITY_D",
  "priority": 10
}
```

### B. è¿‡è´¦ç•™å­˜è§„åˆ™ç¤ºä¾‹
```json
{
  "routingEntityId": "ENTITY_C",
  "retentionType": "PERCENTAGE",
  "retentionValue": 0.01,
  "businessExemption": false,
  "effectiveDate": "2025-01-01"
}
```

### C. è½§å·®å¤„ç†è§„åˆ™ç¤ºä¾‹
```json
{
  "routingEntityId": "ENTITY_D",
  "counterpartEntityId": "ENTITY_B", 
  "processingMode": "NETTING",
  "minNettingAmount": 100.00,
  "currency": "CNY"
}
```

### D. é”™è¯¯ç å®šä¹‰
- RT001: è·¯ç”±è§„åˆ™é…ç½®é”™è¯¯
- RT002: è¿‡è´¦ç•™å­˜è§„åˆ™ä¸å­˜åœ¨
- RT003: è½§å·®å¤„ç†è§„åˆ™å†²çª
- RT004: è¿‡è´¦è·¯å¾„ç”Ÿæˆå¤±è´¥
- RT005: å·®å¼‚è´¦å•è®¡ç®—é”™è¯¯

---
*æœ€åæ›´æ–°: 2025-09-15*  
*æ–‡æ¡£ç‰ˆæœ¬: v1.0*  
*é¡¹ç›®: OneOrderè¿‡è´¦æ¨¡å—*