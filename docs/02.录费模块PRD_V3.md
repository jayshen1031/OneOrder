# OneOrder录费模块产品需求文档(PRD)

## 📋 文档信息
- **版本**: v3.0  
- **创建日期**: 2025-09-15
- **创建者**: Claude Code Assistant
- **项目**: OneOrder货代订单管理与财务清分系统
- **模块**: 录费模块

## 🎯 模块概述

### 业务背景
录费模块是OneOrder系统中负责外部费用明细录入的核心模块。该模块支持客服录入外部收款明细，操作录入成本明细，为后续的管理账分润计算和资金流清分提供基础数据。

### 核心价值
1. **费用管理标准化**: 统一费用录入流程，确保费用信息完整准确
2. **业务流程支撑**: 为后续分润计算和清分处理提供可靠的数据基础
3. **权限控制精确**: 按角色严格控制费用录入权限和数据访问范围
4. **借抬头处理**: 灵活支持收付款借抬头场景的法人体选择

## 📊 核心业务流程

### 主流程
```
订单创建 → 录入外部收付费用 → 数据校验 → 录入完成 → 后续双路线处理
```

### 详细流程
1. **费用录入阶段**
   - 客服录入外部收款明细（客户付款）
   - 操作录入外部付款明细（供应商成本）
   - 系统进行费用科目和服务的校验

2. **数据校验阶段**
   - 费用科目适用性校验
   - 服务项目关联性检查
   - 法人信息完整性验证

3. **录入完成阶段**
   - 外部费用录入状态确认
   - 触发后续处理流程
   - 数据锁定和版本控制

## 🔧 功能需求详述

### 1. 费用明细录入

#### 1.1 费用明细信息结构
每条费用明细包含以下信息：

| 字段名称 | 字段说明 | 数据类型 | 必填 | 示例 |
|---------|---------|----------|------|------|
| 服务项目 | 该费用对应的服务项目 | 下拉选择 | 是 | 海运-MBL处理 |
| 费用科目 | 具体的费用科目 | 下拉选择 | 是 | 海运费 |
| 收付类型 | 收款/付款 | 单选 | 是 | 收款 |
| 对方法人公司 | 客户法人(收款)/供应商法人(付款) | 输入框 | 是 | 上海XX贸易有限公司 |
| 对方部门 | 对方部门信息 | 输入框 | 否 | 业务部 |
| 我方法人 | 经办法人公司 | 下拉选择 | 是 | 海程邦达物流(上海)有限公司 |
| 我方部门 | 经办人员部门 | 自动带出 | 是 | 海运部 |
| 金额 | 费用金额 | 数值输入 | 是 | 15000.00 |
| 币种 | 费用币种 | 下拉选择 | 是 | CNY |

#### 1.2 费用录入规则

**外部收款明细录入（客服权限）**
- **录入对象**：向客户收取的费用或向其他外部相关方收取的费用
- **服务关联**：必须选择对应的服务项目，确保后续分润计算正确拆段
- **对方法人**：收款明细的对方法人一般是客户的法人公司
- **对方部门**：对于客户来说，对方部门和对方法人公司是同一个概念
- **我方法人**：默认为客服ID对应的法人公司，支持借抬头选择其他法人
- **我方部门**：自动匹配客服ID对应的部门

**外部付款明细录入（操作权限）**
- **录入对象**：向供应商支付的成本费用
- **服务关联**：操作负责的服务清晰，录费时必须对应注明服务项目
- **对方法人**：付款明细的对方法人一般是供应商的法人公司
- **对方部门**：对于供应商来说，对方部门和对方法人公司是同一个概念
- **我方法人**：默认为操作ID对应的法人公司，支持借抬头选择其他法人
- **我方部门**：自动匹配操作ID对应的部门

#### 1.3 借抬头处理规则

**收款借抬头**
- 使用非客服ID对应法人的抬头进行收款
- 可以选择其他法人实体作为收款抬头
- 借抬头情况不影响费用对应的部门信息
- 我方部门仍然是客服ID对应的部门

**付款借抬头**
- 使用非操作ID对应法人的抬头进行付款
- 可以选择其他法人实体作为付款抬头
- 借抬头情况不影响费用对应的部门信息
- 我方部门仍然是操作ID对应的部门

**借抬头记录**
- 系统需要记录实际经办法人与默认法人的差异
- 标记借抬头类型：收款借抬头/付款借抬头
- 保留借抬头选择的业务原因和审批记录

### 2. 费用科目主数据约束与校验

#### 2.1 费用科目主数据约束规则

**适用服务约束**
- 在费用科目主数据中可以配置该科目适用的服务范围
- 例如：海运费(FCL001)仅适用于"MBL处理"、"订舱"等海运相关服务
- 录费时系统会校验选择的费用科目是否适用于所选服务项目

**供应商类型约束**  
- 费用科目可以框定适用的供应商类型范围
- 例如：码头操作费(THC001)仅适用于"码头/场站"类型供应商
- 录费时系统会校验对方法人公司的供应商类型是否匹配费用科目

#### 2.2 录费校验逻辑

**费用科目与服务关系**
- 费用科目和服务**没有必然的对应关系**
- 两个内容都需要**手动选择输入**，不存在固定绑定
- 系统仅在主数据约束范围内进行校验提示

**智能带出规则**
- **自动带出条件**: 当某个费用科目对应的订单内服务只有一个时
- **带出逻辑**: 系统检测到费用科目适用服务范围与订单服务项目的交集只有1个
- **用户确认**: 自动带出后仍需用户确认，可手动修改

#### 2.3 校验提示机制

**约束校验类型**
```
1. 严格约束 - 不允许录入，显示错误提示
   示例: "海运费不适用于空运业务，请重新选择费用科目"

2. 警告提示 - 允许录入，显示警告信息  
   示例: "该费用科目通常不用于此服务，请确认是否正确"

3. 建议提示 - 正常录入，显示优化建议
   示例: "建议选择更匹配的费用科目：码头操作费"
```

**校验时机**
- **实时校验**: 费用科目选择后立即校验服务适用性
- **提交校验**: 明细保存前进行完整性校验
- **批量校验**: 批量录费时的数据一致性检查

### 3. 录费完成与后续处理

#### 3.1 录费完成条件

**完成标准**
- 所有外部收款明细已录入完成
- 所有外部付款明细已录入完成
- 费用明细通过完整性校验和约束检查
- 关键字段信息完整：服务项目、费用科目、法人信息、金额等

**状态管理**
- 录费状态：进行中/已完成/已锁定
- 数据版本控制：支持录费数据的版本管理
- 变更追踪：记录费用明细的修改历史

#### 3.2 后续处理双路线触发

**处理路线概述**
```
外部费用录入完成
         ↓
    ┌─────────┴─────────┐
    ↓                   ↓
管理账分润计算      资金流清分计算
    ↓                   ↓
部门利润分配        法人间关联交易
    ↓                   ↓
考核激励用途        报税报表用途
```

**触发机制**
- **自动触发**: 录费状态变更为"已完成"时自动启动后续处理
- **手动触发**: 用户主动点击"开始分润计算"或"开始清分计算"
- **条件检查**: 确认数据完整性后才能触发后续处理

## 🎨 界面设计需求

### 1. 录费主界面

#### 1.1 界面布局
```
+----------------------------------------------------------+
| OneOrder - 录费管理                          [保存] [完成] |
+----------------------------------------------------------+
| 订单信息区域                                               |
| 订单号: HCBD20250915001  |  客户: 上海XX贸易有限公司       |
| 业务类型: 海运           |  录费状态: 进行中              |
+----------------------------------------------------------+
| 费用明细录入区域                                [+ 添加明细] |
| +------------------------------------------------------+ |
| | 序号 | 服务项目 | 费用科目 | 收付 | 对方法人 | 我方法人 | 金额 | |
| |  1   | MBL处理  | 海运费   | 收款 | 客户A    | 上海邦达 | 15000| |
| |  2   | 内装     | 装箱费   | 付款 | 供应商B  | 上海邦达 | 2000 | |
| +------------------------------------------------------+ |
+----------------------------------------------------------+
| 录费进度区域                                              |
| 收款明细: 3条 ✓  |  付款明细: 5条 ✓  |  待处理: 0条      |
+----------------------------------------------------------+
```

#### 1.2 交互设计
- **明细添加**: 点击"添加明细"弹出录入弹窗
- **明细编辑**: 双击明细行进行在线编辑
- **明细删除**: 选中明细后删除，需要确认
- **批量操作**: 支持批量导入费用明细
- **智能提示**: 费用科目选择时显示适用服务和供应商类型

### 2. 费用明细录入弹窗

#### 2.1 弹窗结构
```
+--------------------------------------------+
| 录入费用明细                    [×]        |
+--------------------------------------------+
| 基本信息                                   |
| 服务项目: [下拉选择: MBL处理]              |
| 费用科目: [下拉选择: 海运费] [ℹ️适用性提示]  |
| 收付类型: [○收款] [○付款]                  |
+--------------------------------------------+
| 对方信息                                   |
| 对方法人: [___________________]            |
| 对方部门: [___________________]            |
| 供应商类型: [下拉选择: 船公司] (付款时显示)  |
+--------------------------------------------+
| 我方信息                                   |
| 我方法人: [下拉选择: 默认法人] [🔄借抬头]    |
| 我方部门: [自动显示: 海运部]               |
| 借抬头原因: [________________] (借抬头时)   |
+--------------------------------------------+
| 金额信息                                   |
| 金额: [___________] 币种: [CNY]           |
+--------------------------------------------+
| 校验信息区域                               |
| [✅/⚠️/❌] 费用科目适用性检查结果           |
+--------------------------------------------+
|                    [取消] [确定]          |
+--------------------------------------------+
```

#### 2.2 表单验证
- 所有必填字段不能为空
- 金额必须为正数
- 对方法人不能与我方法人相同
- 服务项目与费用科目的适用性检查
- 借抬头场景的特殊验证

### 3. 费用科目智能提示

#### 3.1 适用性提示界面
```
+--------------------------------------------+
| 费用科目: [海运费(FCL001)] [ℹ️]             |
| +----------------------------------------+ |
| | ✅ 适用服务: MBL处理, 订舱, 舱单        | |
| | ✅ 适用供应商: 船公司, 货代公司          | |
| | ⚠️  当前选择: 内装服务(不完全匹配)       | |
| | 💡 建议: 装箱费, 内装费                 | |
| +----------------------------------------+ |
+--------------------------------------------+
```

#### 3.2 自动带出提示
```
+--------------------------------------------+
| 🤖 智能提示                                |
| 检测到费用科目"海运费"与订单服务的交集只有  |
| "MBL处理"一个服务，是否自动选择？           |
|                    [否] [是，自动选择]     |
+--------------------------------------------+
```

## 🔒 权限与安全需求

### 1. 角色权限设计

| 角色 | 录入权限 | 查看权限 | 修改权限 | 删除权限 | 说明 |
|------|----------|----------|----------|----------|------|
| 客服 | 外部收款明细 | 本人录入明细 | 本人录入明细 | 本人录入明细 | 只能操作收款明细 |
| 操作 | 外部付款明细 | 本人录入明细 | 本人录入明细 | 本人录入明细 | 只能操作付款明细 |
| 主管 | 全部明细 | 部门所有明细 | 部门明细 | 部门明细 | 部门范围权限 |
| 财务 | 全部明细 | 全部明细 | 全部明细 | 全部明细 | 最高权限 |

### 2. 数据安全要求
- **操作审计**: 记录所有录费操作的用户、时间、内容变更
- **数据备份**: 费用明细数据的定期备份和恢复机制
- **权限控制**: 严格按角色控制数据访问和操作权限
- **数据加密**: 敏感的法人和金额信息进行加密存储

## 📈 技术架构与数据模型

### 1. 技术架构
- **后端框架**: Spring Boot 2.7.14
- **数据库**: PostgreSQL 14 (费用明细表)
- **缓存**: Redis 7 (费用科目和服务数据缓存)
- **前端**: Bootstrap 5 + JavaScript ES6
- **API设计**: RESTful风格，JSON数据格式

### 2. 数据模型设计

#### 2.1 费用明细表(expense_entries)
```sql
CREATE TABLE expense_entries (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    service_code VARCHAR(50) NOT NULL,  -- 服务项目编码
    fee_code VARCHAR(50) NOT NULL,      -- 费用科目编码
    entry_type VARCHAR(10) NOT NULL,    -- 收付类型: RECEIVABLE/PAYABLE
    counterpart_entity VARCHAR(200) NOT NULL,    -- 对方法人公司
    counterpart_department VARCHAR(100), -- 对方部门
    counterpart_supplier_type VARCHAR(50), -- 对方供应商类型(付款时)
    our_entity_id VARCHAR(50) NOT NULL, -- 我方法人ID
    our_department_id VARCHAR(50) NOT NULL, -- 我方部门ID
    amount DECIMAL(15,2) NOT NULL,      -- 金额
    currency VARCHAR(10) NOT NULL,      -- 币种
    is_transit_entity BOOLEAN DEFAULT FALSE, -- 是否借抬头
    transit_reason VARCHAR(500),        -- 借抬头原因
    validation_status VARCHAR(20) DEFAULT 'VALID', -- 校验状态
    validation_message VARCHAR(500),    -- 校验提示信息
    created_by VARCHAR(50) NOT NULL,    -- 录入人
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(50),
    updated_time TIMESTAMP,
    entry_status VARCHAR(20) DEFAULT 'DRAFT', -- 明细状态: DRAFT/CONFIRMED/LOCKED
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (fee_code) REFERENCES service_config(fee_code),
    INDEX idx_order_service (order_id, service_code),
    INDEX idx_entry_type (entry_type),
    INDEX idx_created_by (created_by)
);
```

#### 2.2 费用科目服务约束表(fee_service_constraints)
```sql
CREATE TABLE fee_service_constraints (
    id BIGSERIAL PRIMARY KEY,
    fee_code VARCHAR(50) NOT NULL,      -- 费用科目编码
    service_code VARCHAR(50) NOT NULL,  -- 适用服务编码
    constraint_type VARCHAR(20) DEFAULT 'ALLOWED', -- 约束类型: ALLOWED/FORBIDDEN
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (fee_code) REFERENCES service_config(fee_code),
    UNIQUE (fee_code, service_code)
);
```

#### 2.3 费用科目供应商约束表(fee_supplier_constraints)  
```sql
CREATE TABLE fee_supplier_constraints (
    id BIGSERIAL PRIMARY KEY,
    fee_code VARCHAR(50) NOT NULL,      -- 费用科目编码
    supplier_type VARCHAR(50) NOT NULL, -- 适用供应商类型
    constraint_type VARCHAR(20) DEFAULT 'ALLOWED', -- 约束类型: ALLOWED/FORBIDDEN
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (fee_code) REFERENCES service_config(fee_code),
    UNIQUE (fee_code, supplier_type)
);
```

#### 2.4 录费状态管理表(expense_entry_status)
```sql
CREATE TABLE expense_entry_status (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    entry_status VARCHAR(20) NOT NULL,  -- 录费状态: IN_PROGRESS/COMPLETED/LOCKED
    receivable_count INTEGER DEFAULT 0, -- 收款明细数量
    payable_count INTEGER DEFAULT 0,    -- 付款明细数量
    total_receivable DECIMAL(15,2) DEFAULT 0, -- 收款总额
    total_payable DECIMAL(15,2) DEFAULT 0,    -- 付款总额
    last_modified_by VARCHAR(50),
    last_modified_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_time TIMESTAMP,           -- 录费完成时间
    locked_time TIMESTAMP,              -- 锁定时间
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    UNIQUE (order_id)
);
```

## 🔧 API接口设计

### 1. 费用明细管理API

#### 1.1 添加费用明细
```http
POST /api/expense-entries
Content-Type: application/json

{
    "orderId": "HCBD20250915001",
    "serviceCode": "MBL_PROCESSING",
    "feeCode": "FCL001",
    "entryType": "RECEIVABLE",
    "counterpartEntity": "上海XX贸易有限公司",
    "counterpartDepartment": "业务部",
    "ourEntityId": "HCBD_SHANGHAI",
    "amount": 15000.00,
    "currency": "CNY",
    "isTransitEntity": false
}

Response:
{
    "code": 200,
    "message": "费用明细添加成功",
    "data": {
        "entryId": 12345,
        "validationStatus": "VALID",
        "autoSelectedService": false
    }
}
```

#### 1.2 查询订单费用明细
```http
GET /api/expense-entries/order/{orderId}

Response:
{
    "code": 200,
    "data": {
        "orderInfo": {
            "orderId": "HCBD20250915001",
            "entryStatus": "IN_PROGRESS",
            "receivableCount": 3,
            "payableCount": 5
        },
        "entries": [
            {
                "id": 12345,
                "serviceCode": "MBL_PROCESSING",
                "serviceName": "MBL处理",
                "feeCode": "FCL001",
                "feeName": "海运费",
                "entryType": "RECEIVABLE",
                "counterpartEntity": "上海XX贸易有限公司",
                "ourEntityName": "海程邦达物流(上海)有限公司",
                "amount": 15000.00,
                "currency": "CNY",
                "isTransitEntity": false,
                "validationStatus": "VALID"
            }
        ]
    }
}
```

### 2. 费用科目校验API

#### 2.1 费用科目适用性校验
```http
POST /api/expense-entries/validate-fee-service
Content-Type: application/json

{
    "feeCode": "FCL001",
    "serviceCode": "MBL_PROCESSING",
    "supplierType": "SHIPPING_COMPANY"
}

Response:
{
    "code": 200,
    "data": {
        "validationResult": "VALID",
        "serviceCompatible": true,
        "supplierCompatible": true,
        "autoSuggestedService": null,
        "suggestedFees": [],
        "warningMessage": null
    }
}
```

#### 2.2 智能服务带出
```http
GET /api/expense-entries/suggest-service
?orderId=HCBD20250915001
&feeCode=FCL001

Response:
{
    "code": 200,
    "data": {
        "canAutoSelect": true,
        "suggestedService": "MBL_PROCESSING",
        "reason": "费用科目适用服务与订单服务交集唯一",
        "conflictServices": []
    }
}
```

### 3. 录费状态管理API

#### 3.1 完成录费
```http
POST /api/expense-entries/complete/{orderId}

Response:
{
    "code": 200,
    "message": "录费已完成",
    "data": {
        "orderId": "HCBD20250915001",
        "completedTime": "2025-09-15T10:30:00",
        "totalReceivable": 18000.00,
        "totalPayable": 15000.00,
        "canStartProfitSharing": true,
        "canStartClearing": true
    }
}
```

## 📋 验收标准

### 功能验收
- ✅ 客服能够录入外部收款明细，操作能够录入外部付款明细
- ✅ 费用科目主数据约束功能正常，校验提示准确
- ✅ 智能带出功能在单一服务匹配时正确自动带出服务项目
- ✅ 借抬头场景能够正确处理法人体选择和原因记录
- ✅ 录费完成后能够正确触发后续双路线处理
- ✅ 权限控制按角色严格执行，数据访问安全

### 性能验收
- ✅ 费用明细录入响应时间 < 2秒
- ✅ 费用科目校验时间 < 1秒
- ✅ 支持50+用户同时录费操作
- ✅ 单订单支持1000+费用明细

### 数据准确性验收
- ✅ 费用明细信息完整准确，包含7个核心字段
- ✅ 费用科目约束校验准确率100%
- ✅ 借抬头标记和原因记录完整
- ✅ 录费状态管理准确，支持数据版本控制

## 🎊 业务价值

### 数据质量保障
1. **标准化录入**: 统一的费用录入流程和数据格式
2. **智能校验**: 自动化的费用科目和服务适用性检查
3. **权限分离**: 按角色分工录入，减少数据错误
4. **完整性保证**: 确保后续处理所需的数据完整性

### 业务流程优化
1. **操作便捷**: 智能提示和自动带出提升录入效率
2. **灵活处理**: 支持借抬头等复杂业务场景
3. **实时反馈**: 即时的校验反馈和错误提示
4. **状态管控**: 清晰的录费进度和状态管理

### 后续处理支撑
1. **双路线基础**: 为管理账分润和资金流清分提供数据基础
2. **数据溯源**: 完整的录费历史和变更追踪
3. **版本控制**: 支持数据的版本管理和回滚
4. **触发机制**: 自动触发后续处理流程

---

## 附录

### A. 费用科目映射表
基于OneOrder费用科目梳理项目的188个费用科目，按15大类别和21个服务环节进行管理。

### B. 借抬头配置示例
```json
{
  "transitEntityId": "HCBD_HONGKONG",
  "transitReason": "客户指定香港公司收款",
  "approvalRequired": true,
  "retentionRule": {
    "type": "PERCENTAGE",
    "value": 0.03
  }
}
```

### C. API错误码定义
- EE001: 费用明细数据不完整
- EE002: 费用科目不适用于所选服务
- EE003: 供应商类型不匹配费用科目
- EE004: 权限不足，无法录入该类型费用
- EE005: 借抬头选择需要审批

---
*最后更新: 2025-09-15*  
*文档版本: v3.0*  
*项目: OneOrder录费模块*  
*说明: 专注于费用录入功能，不包含管理账分润计算逻辑*