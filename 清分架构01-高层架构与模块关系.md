flowchart LR
  subgraph Edge["上游/下游系统"]
    OMS[订单/服务\nOMS]:::ext
    ARAP[收付/总账\nAR/AP/GL]:::ext
    MDM[主数据\n(法人/客户/供应商/币种/区域)]:::ext
    BI[数据仓库/BI]:::ext
  end

  subgraph Core["清分核心域"]
    OI[订单与服务接入\nOrder Intake]:::svc
    RE[规则引擎\n(借抬头/过账/分润/模式选择)]:::svc
    BT[借抬头处理\n(Borrowed Title)]:::svc
    PR[过账路由\n(平收平付/抵消/地区玩法)]:::svc
    CE[清分执行器\n(Calculation Engine)]:::svc
    PG[过账与记账\nPosting Gateway]:::svc
    RG[报表生成器\n(管报/法报/差异标记)]:::svc
    TR[追溯与审计\n(Explain/Trace)]:::svc
    CFG[配置后台\n(规则/费率/阈值)]:::svc
  end

  subgraph Data["数据与基础设施"]
    ODS[(业务库 ODS\n订单/服务/费用明细)]:::db
    RDB[(规则库 RDB\n规则集/参数/优先级)]:::db
    LEDGER[(账务库\nPosting/分录/流水)]:::db
    DWH[(报表库/明细仓\n管报/法报/对照)]:::db
    BUS((消息总线\nKafka/RabbitMQ)):::bus
    CACHE[(缓存\nRedis)]:::cache
  end

  %% 主链路
  OMS -->|订单/服务/费用| OI --> ODS
  MDM --> CFG
  CFG --> RDB
  OI --> RE
  RE -->|规则/路由决策| CE
  RE --> BT
  RE --> PR
  BT --> CE
  PR --> CE
  CE -->|分润/应收应付/模式| PG --> LEDGER
  CE --> TR
  CE --> RG
  RG --> DWH
  DWH --> BI
  PG --> ARAP
  RG --> ARAP

  %% 事件流/异步
  OI <-->|事件/回执| BUS
  CE <-->|异步任务| BUS
  RG <-->|生成/刷新| BUS

  classDef ext fill:#fff,stroke:#999,stroke-width:1px,color:#333;
  classDef svc fill:#eef7ff,stroke:#66a3ff,stroke-width:1px,color:#0b3d91;
  classDef db fill:#fdf7e3,stroke:#e0b100,stroke-width:1px,color:#6a4b00;
  classDef bus fill:#f0f5ff,stroke:#8aa0ff,stroke-width:1px,color:#1f2a59,stroke-dasharray:3 3;
  classDef cache fill:#f4fafe,stroke:#9bd1f9,stroke-width:1px,color:#13445a;


  要点
	•	规则优先：配置后台→规则库→规则引擎→清分执行器，形成一条“声明式→可执行”的链。
	•	双轨输出：报表生成器同时产出管报/法报并写入报表库，账务分录经 Posting Gateway 对接 AR/AP/GL。
	•	可追溯：清分执行器全程把“规则版本/命中条件/数值来源”写入审计域，支持 Explain。
	•	异步扩展：消息总线承载批量清分、报表刷新、重算/补算等任务，保障峰值性能。