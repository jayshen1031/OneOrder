sequenceDiagram
    autonumber
    participant 客户 as 客户
    participant 销售 as 销售站/销售法人体
    participant 交付 as 交付法人体/操作
    participant 供应商 as 供应商法人体
    participant 引擎 as 清分引擎(规则/分润/模式)
    participant 财务 as 财务(AR/AP/GL)
    participant 报表 as 报表服务(管报/法报)

    客户->>销售: 1) 询价/下单(需求、币种、区域)
    销售->>交付: 2) 下派服务(订舱/拖车/报关等)
    交付->>供应商: 3) 采购与履约(外部应付形成)
    供应商-->>交付: 4) 回传费用/账单(应付)
    交付->>销售: 5) 回传成本与完工状态

    销售->>引擎: 6) 提交订单+服务+费用(试算请求)
    引擎-->>引擎: 6.1) 规则判定: 模式(星式/链式)、分润、借抬头、过账
    引擎-->>引擎: 6.2) 计算: 应收/应付/内外收支/分润(试算)
    引擎-->>销售: 6.3) 返回试算结果/差异提示

    销售->>引擎: 7) 确认入账(生成分录)
    引擎->>财务: 8) 记账分录(AR/AP/GL)
    引擎->>报表: 9) 生成双轨结果(管理口径/法定口径)
    报表-->>销售: 10) 管报视图(外收/外支/内收/内支/毛利)
    报表-->>财务: 11) 法报视图(法人收支/留存/税务口径)

    Note over 引擎,报表: 默认“星式”一次分配；链式仅在合规/特殊需求下启用