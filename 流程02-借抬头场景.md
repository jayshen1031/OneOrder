sequenceDiagram
    autonumber
    participant 客户 as 客户
    participant 借抬头 as 借抬头法人体(中间法人)
    participant 销售 as 销售法人体
    participant 供应商 as 供应商法人体
    participant 引擎 as 清分引擎
    participant 财务 as 财务(AR/AP/GL)
    participant 报表 as 报表服务

    客户->>引擎: 1) 订单确认(收款路径=借抬头?)
    alt 收款借抬头(客户→中间→销售)
        引擎-->>借抬头: 2) 生成收款分录(按规则留存, 如3%)
        客户->>借抬头: 3) 客户打款(外收)
        借抬头->>销售: 4) 转付净额(中间法人留存后)
    else 直接收款(客户→销售)
        客户->>销售: 2) 客户打款
    end

    alt 付款借抬头(销售→中间→供应商)
        引擎-->>借抬头: 5) 生成付款分录(可留存)
        销售->>借抬头: 6) 付款至中间法人
        借抬头->>供应商: 7) 向供应商付款
    else 直接付款(销售→供应商)
        销售->>供应商: 5) 向供应商付款
    end

    引擎-->>引擎: 8) 分润计算(五五/比例/定额)
    引擎->>财务: 9) 入账分录(含借抬头留存行)
    引擎->>报表: 10) 双轨结果 + 差异标记
    Note over 报表: 管报/法报若不一致(如部门0留存 vs 法报五五开)，输出差异原因