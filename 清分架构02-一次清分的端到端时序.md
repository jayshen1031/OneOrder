sequenceDiagram
  autonumber
  participant OMS as OMS(订单/费用)
  participant OI as Order Intake
  participant RE as 规则引擎
  participant CE as 清分执行器
  participant BT as 借抬头处理
  participant PR as 过账路由
  participant PG as Posting Gateway
  participant RG as 报表生成器
  participant TR as 追溯审计
  participant ARAP as AR/AP/GL

  OMS->>OI: 推送订单/服务/费用(含币种/区域/法人/科目)
  OI->>RE: 请求规则判定(Input: 实体/金额/上下文/配置版本)
  RE-->>RE: 命中分润规则(五五/比例/定额)
  RE-->>RE: 判定借抬头(基于账号/法人/默认抬头)
  RE-->>RE: 判定过账(区域/币种/法人关系 + 抵消策略)
  RE->>CE: 返回执行计划(模式=链式/新式, 分润参数, 借抬头/过账插入点)

  alt 存在借抬头
    CE->>BT: 生成中间法人收付与留存
    BT-->>CE: 借抬头分录片段
  end

  alt 需要过账
    CE->>PR: 插入过账公司及留存/抵消策略
    PR-->>CE: 过账分录片段
  end

  CE-->>CE: 计算应收/应付/分润; 生成管报/法报基数
  CE->>TR: 写入规则命中、数值来源、路径Explain
  CE->>RG: 产出 管报/法报/差异标记(试算)
  CE->>PG: 产出 记账分录(正式)

  PG->>ARAP: 发送分录/凭证(支持多币种/汇兑差额后续)
  RG->>ARAP: 辅助对账/出具法报口径明细
  RG-->>OI: 回执(可用于异步刷新/补算)

  要点
	•	模式选择：规则引擎根据“是否空转/合规要求”在链式与新式间切换（可按法人/区域配置默认）。
	•	试算→入账：清分执行器先生成试算结果（便于 UAT/灰度），通过配置开关控制入账。
	•	Explain：每个规则命中与数值都能在 TR 中还原，支撑审计/问题定位/回放重算。