# OneOrder 完整4步骤业务流程测试指南

## 🎯 测试目标
验证从客服接单到派单执行的完整业务链路，确保前端界面和后端API完全打通。

## 📋 测试环境
- **系统地址**: http://localhost:8081/api/
- **测试时间**: 2025-09-16
- **测试版本**: OneOrder v1.0.0

## 🔄 完整测试流程

### 步骤1: 客服接单阶段 (前端界面测试)

#### 1.1 访问接单页面
```
访问地址: http://localhost:8081/api/customer-order-intake-api.html
```

#### 1.2 操作步骤
1. **选择客户**:
   - 在搜索框输入 "ACME" 
   - 点击选择 "ACME物流有限公司"
   - 点击"下一步：选择业务类型"

2. **选择业务类型**:
   - 点击选择 "海运" 卡片
   - 系统自动进入下一步

3. **选择服务项目**:
   - 查看系统提示：6个服务项目，2个必选
   - 确认必选服务已自动选中：订舱 + MBL处理
   - 可选择添加：内装(¥350) + 报关(¥500)
   - 点击"下一步：确认订单"

4. **确认订单**:
   - 检查订单信息汇总
   - 确认总金额正确
   - 点击"创建订单"

#### 1.3 预期结果
- ✅ 显示成功模态框
- ✅ 生成订单编号(格式: HCBD开头)
- ✅ 显示正确的总金额
- ✅ 提供"去派单管理"链接

### 步骤2: 服务派单阶段 (前端界面测试)

#### 2.1 访问派单页面
```
点击成功页面的"去派单管理"按钮，或直接访问:
http://localhost:8081/api/service-assignment.html
```

#### 2.2 操作步骤
1. **选择订单**:
   - 在订单选择下拉框中找到刚创建的订单(HCBD开头)
   - 点击"加载服务项目"

2. **查看服务列表**:
   - 确认显示4个服务项目(如果选了4个)
   - 查看优先级排序(MBL处理优先级最高)

3. **分配操作人员**:
   - 点击"加载操作人员"
   - 为MBL处理选择"张三"(工作负载33%)
   - 为内装选择"王五"(内装操作部)
   - 为报关选择"赵六"(报关部)
   - 为订舱选择"张三"或"李四"

4. **执行派单**:
   - 可以单个派单，或使用"智能自动派单"
   - 观察派单成功提示

#### 2.3 预期结果
- ✅ 服务项目成功加载并显示
- ✅ 操作人员按技能匹配显示
- ✅ 派单成功并显示协议信息
- ✅ 状态更新为"已派单"

### 步骤3: 执行确认阶段 (API模拟测试)

由于前端暂无操作人员确认界面，使用API测试：

```bash
# 获取刚创建订单的派单状态
curl -s "http://localhost:8081/api/api/service-assignment/status/刚创建的订单号" | jq '.data.assignments'

# 模拟张三确认接单MBL处理
curl -s -X POST "http://localhost:8081/api/api/service-assignment/confirm" \
  -H "Content-Type: application/json" \
  -d '{
    "assignmentId": "从状态查询获取的派单ID",
    "operatorId": "OP001",
    "action": "CONFIRM",
    "notes": "确认接单，预计48小时完成"
  }' | jq '.data'
```

### 步骤4: 执行跟踪阶段 (前端+API验证)

#### 4.1 前端状态查看
在派单管理页面：
- 刷新订单状态
- 查看完成进度
- 观察状态变化

#### 4.2 API详细查询
```bash
# 查看整体订单执行状态
curl -s "http://localhost:8081/api/api/service-assignment/status/订单号" | jq '.data | {completionRate, statusSummary}'

# 查看操作人员通知
curl -s "http://localhost:8081/api/api/service-assignment/notifications/OP001" | jq '.data | {totalCount, unreadCount}'
```

## ✅ 完整测试验证清单

### 前端界面验证
- [ ] 客服接单页面可正常访问
- [ ] 客户搜索功能正常工作
- [ ] 业务类型选择响应及时
- [ ] 服务项目约束逻辑正确
- [ ] 订单创建成功并返回正确信息
- [ ] 派单管理页面可正常访问
- [ ] 订单和服务项目正确加载
- [ ] 操作人员匹配和分配正常
- [ ] 派单操作成功执行

### API功能验证
- [ ] 客户搜索API (/customers/search)
- [ ] 业务类型获取API (/business-types)
- [ ] 服务项目获取API (/services/available/{type})
- [ ] 订单创建API (/orders/create)
- [ ] 服务项目获取API (/service-assignment/services/{id})
- [ ] 操作人员获取API (/service-assignment/available-operators)
- [ ] 派单执行API (/service-assignment/assign)
- [ ] 接单确认API (/service-assignment/confirm)
- [ ] 状态跟踪API (/service-assignment/status/{id})

### 数据一致性验证
- [ ] 前端显示的数据与API返回一致
- [ ] 订单金额计算正确
- [ ] 服务项目状态流转正确
- [ ] 操作人员工作负载更新
- [ ] 协议匹配逻辑正确

## 🚨 已知问题

1. **前端模拟数据问题**: 原版客服接单页面使用模拟数据，已创建API版本解决
2. **操作人员确认界面**: 暂无专门的操作人员确认界面，使用API测试代替
3. **实时状态更新**: 前端状态更新需要手动刷新

## 📞 测试支持

如遇到问题，可以通过以下方式验证：

1. **查看应用日志**: 观察后台输出的日志信息
2. **API直接测试**: 使用curl命令直接测试API端点
3. **浏览器开发者工具**: 查看网络请求和控制台错误
4. **数据库查询**: 直接查询数据库验证数据一致性

## 🎯 测试成功标准

完整的4步骤测试成功标准：
1. 能够通过前端界面成功创建订单
2. 创建的订单能在派单管理中正确显示
3. 能够为所有服务项目分配操作人员
4. API确认接单功能正常工作
5. 状态跟踪显示正确的执行进度

---
**测试文档版本**: v1.0  
**最后更新**: 2025-09-16 10:55  
**测试负责人**: Claude Assistant